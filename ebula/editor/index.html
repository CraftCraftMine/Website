<!--
  Project:     CCMC™ Web EBuLa
  Part of:     CraftCraftMine Netzwerk™ (CCMN™)
  Copyright:   (c) 2026 CraftCraftMine Netzwerk™ – All rights reserved.
  Description: Privates Hobby-Projekt für Train Sim World Simulationen.
               Nicht für kommerzielle Zwecke bestimmt.
  Support:     support@craftcraftmine.net
  Info:        https://craftcraftmine.net/ueberuns
-->
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>CCMC™ Web EBuLa – Editor</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<script src="../shared/types.js"></script>
<script src="../shared/db.js"></script>
<script src="../shared/calc.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
:root{
  --bg:#09090d;--s1:#111116;--s2:#16161d;--s3:#1d1d26;
  --b1:#252532;--b2:#303040;
  --text:#c4c4d6;--dim:#686880;--faint:#30303f;
  --pri:#3a7ec4;--pri2:#1e4f88;--red:#b03030;--acc:#b89030;
  --mono:'IBM Plex Mono',monospace;--sans:'IBM Plex Sans',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body,#root{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);}
::-webkit-scrollbar{width:3px;} ::-webkit-scrollbar-thumb{background:var(--b2);}
.page{display:flex;flex-direction:column;height:100dvh;}
.bar{display:flex;align-items:center;gap:9px;padding:0 13px;height:44px;background:var(--s1);border-bottom:1px solid var(--b1);flex-shrink:0;}
.bar-lbl{font-family:var(--mono);font-size:9px;color:var(--faint);letter-spacing:1px;text-transform:uppercase;}
.tabs{display:flex;gap:0;border-bottom:1px solid var(--b1);flex-shrink:0;background:var(--s1);}
.tab{flex:1;padding:9px 0;text-align:center;font-family:var(--mono);font-size:11px;font-weight:600;letter-spacing:.5px;color:var(--dim);cursor:pointer;border-bottom:2px solid transparent;transition:color .15s,border-color .15s;}
.tab.active{color:var(--pri);border-bottom-color:var(--pri);}
.tab.rueck{color:var(--acc);}
.tab.rueck.active{color:var(--acc);border-bottom-color:var(--acc);}
.scroll{flex:1;overflow-y:auto;padding:12px 12px 80px;}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:0 12px;height:30px;border-radius:3px;border:none;cursor:pointer;font-family:var(--sans);font-size:12px;font-weight:500;white-space:nowrap;}
.bp{background:var(--pri2);color:#b8d4f0;border:1px solid #3a7ec440;} .bp:hover{background:var(--pri);color:#fff;}
.bo{background:transparent;color:var(--dim);border:1px solid var(--b2);} .bo:hover{background:var(--s3);color:var(--text);}
.bx{background:transparent;color:var(--red);border:1px solid #b0303028;} .bx:hover{background:#b0303018;}
.bsm{height:26px;padding:0 9px;font-size:11px;}
.ic{width:28px;height:28px;border-radius:3px;background:transparent;border:1px solid var(--b1);cursor:pointer;color:var(--dim);font-size:14px;display:inline-flex;align-items:center;justify-content:center;}
.ic:hover{background:var(--s3);color:var(--text);}
.fab{position:fixed;bottom:14px;right:14px;width:44px;height:44px;border-radius:50%;background:var(--pri2);border:1px solid var(--pri);cursor:pointer;font-size:20px;color:#b8d4f0;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 18px #1e4f8840;z-index:41;}
.field{margin-bottom:10px;} .field>label{display:block;font-family:var(--mono);font-size:9px;color:var(--dim);margin-bottom:4px;text-transform:uppercase;letter-spacing:.8px;}
.inp{width:100%;background:var(--s2);border:1px solid var(--b1);border-radius:3px;padding:7px 9px;color:var(--text);font-family:var(--sans);font-size:13px;outline:none;}
.inp:focus{border-color:var(--pri2);}
.irow{display:flex;gap:8px;} .irow .field{flex:1;}
.ov{position:fixed;inset:0;background:#000000b0;z-index:300;display:flex;align-items:flex-end;}
.sheet{background:var(--s1);border:1px solid var(--b1);border-top:2px solid var(--pri2);border-radius:12px 12px 0 0;width:100%;max-height:92dvh;overflow-y:auto;padding:17px 14px;}
.sheet-h{font-size:15px;font-weight:600;margin-bottom:13px;}
.sheet-f{display:flex;gap:7px;justify-content:flex-end;margin-top:13px;padding-top:10px;border-top:1px solid var(--b1);}
.empty{display:flex;flex-direction:column;align-items:center;padding:48px 20px;gap:8px;color:var(--faint);text-align:center;}
.tag{padding:2px 5px;border-radius:2px;font-family:var(--mono);font-size:10px;font-weight:600;}
.objr{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--b1);}
/* Gleise */
.gleise-box{background:var(--s2);border:1px solid var(--b1);border-radius:3px;padding:9px;margin-top:4px;}
.gleis-row{display:flex;align-items:center;gap:6px;margin-bottom:6px;}
.gleis-row:last-child{margin-bottom:0;}
.gleis-inp{flex:1;background:var(--bg);border:1px solid var(--b1);border-radius:2px;padding:5px 7px;color:var(--text);font-family:var(--mono);font-size:11px;outline:none;}
.gleis-inp:focus{border-color:var(--pri2);}
.gleis-inp.km{width:80px;flex:none;}
.rueck-hint{background:#1a1408;border:1px solid #4a3810;border-radius:3px;padding:10px 13px;margin-bottom:12px;font-size:12px;color:#c8a030;line-height:1.6;}
</style>
</head>
<body>
<div id="splash" style="position:fixed;inset:0;background:#09090d;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;font-family:'IBM Plex Mono',monospace;">
  <div style="font-size:20px;font-weight:600;color:#3a7ec4;letter-spacing:3px;">CCMC™ Web EBuLa</div>
  <div style="font-size:10px;color:#2a4a6a;letter-spacing:2px;">powered by CraftCraftMine Netzwerk™</div>
  <div style="margin-top:18px;width:48px;height:1px;background:linear-gradient(90deg,transparent,#3a7ec4,transparent);animation:sl 1.2s ease-in-out infinite;"></div>
</div>
<style>@keyframes sl{0%,100%{opacity:.2}50%{opacity:1}}</style>
<script>window.addEventListener('load',function(){setTimeout(function(){var s=document.getElementById('splash');if(!s)return;s.style.transition='opacity .5s ease';s.style.opacity='0';setTimeout(function(){s.remove();},550);},700);});</script>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback } = React;
const F = ({label,children}) => <div className="field"><label>{label}</label>{children}</div>;

/* ── Gleise-Editor (Unterkomponente für Stationen) ── */
function GleiseEditor({ gleise, onChange }) {
  const add = () => onChange([...gleise, { id: Date.now().toString(), name: '', km: null }]);
  const upd = (id, field, val) =>
    onChange(gleise.map(g => g.id===id ? {...g, [field]: val} : g));
  const del = id => onChange(gleise.filter(g => g.id !== id));

  return (
    <div className="gleise-box">
      <div style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--dim)',marginBottom:8,textTransform:'uppercase',letterSpacing:.8}}>
        Gleise / Bahnsteige ({gleise.length})
      </div>
      {gleise.map(g => (
        <div key={g.id} className="gleis-row">
          <input className="gleis-inp" value={g.name}
            onChange={e=>upd(g.id,'name',e.target.value)}
            placeholder="z. B. Gl. 1"/>
          <input className="gleis-inp km" value={g.km===null?'':String(g.km)}
            onChange={e=>upd(g.id,'km', e.target.value==='' ? null : parseFloat(e.target.value.replace(',','.')))}
            placeholder="km" inputMode="decimal" title="km-Position (leer = wie Bahnhof)"/>
          <button className="ic" style={{fontSize:12,color:'var(--red)'}} onClick={()=>del(g.id)}>✕</button>
        </div>
      ))}
      <button className="btn bo bsm" style={{marginTop:gleise.length?6:0}} onClick={add}>+ Gleis</button>
    </div>
  );
}

function Editor() {
  const [route,    setRoute]   = useState(null);
  const [dir,      setDir]     = useState('hin');   // 'hin' | 'rueck'
  const [showAdd,  setShowAdd] = useState(false);
  const [editing,  setEditing] = useState(null);
  const blank = {km:'0',type:'STATION',name:'',speed:'',speedEnd:'',gradient:'',notes:'',gleise:[]};
  const [form, setForm] = useState(blank);
  const fv = (k,v) => setForm(p=>({...p,[k]:v}));

  useEffect(() => {
    const id = decodeURIComponent(window.location.hash.replace('#',''));
    if (id) setRoute(DB.getById(id));
  }, []);

  /* Aktuelle Objektliste abhängig vom Tab */
  const activeObjs = route
    ? (dir==='rueck' ? (route.objects_rueck||[]) : (route.objects||[]))
    : [];

  /* Objekte speichern (richtungsabhängig) */
  const saveObjs = useCallback(objs => {
    const field = dir==='rueck' ? 'objects_rueck' : 'objects';
    const r = {...route, [field]: objs};
    DB.save(r); setRoute(r);
  }, [route, dir]);

  /* Wechsel zu Rück-Tab: ggf. von Hin übernehmen */
  const switchToRueck = () => {
    if (!route) return;
    let r = route;
    if (!r.objects_rueck) {
      r = DB.initRueck(route.id);
      setRoute(r);
    }
    setDir('rueck');
  };

  const saveObj = () => {
    const km = parseFloat(form.km.replace(',','.'));
    if (isNaN(km)) return;
    const obj = {
      id:       editing?.id || Date.now().toString(),
      km, type: form.type, name: form.name,
      speed:    parseInt(form.speed)||null,
      speedEnd: parseFloat(form.speedEnd)||null,
      gradient: form.gradient!=='' ? parseFloat(form.gradient.replace(',','.')): null,
      notes:    form.notes,
      gleise:   form.type==='STATION' ? (form.gleise||[]) : undefined,
    };
    if (obj.type !== 'STATION') delete obj.gleise;
    const objs = activeObjs;
    saveObjs((editing
      ? objs.map(o => o.id===editing.id ? obj : o)
      : [...objs, obj]
    ).sort((a,b) => a.km - b.km));
    setShowAdd(false); setEditing(null);
  };

  const openEdit = obj => {
    setEditing(obj); setShowAdd(true);
    setForm({
      km:       String(obj.km),
      type:     obj.type,
      name:     obj.name||'',
      speed:    String(obj.speed||''),
      speedEnd: String(obj.speedEnd||''),
      gradient: obj.gradient!=null ? String(obj.gradient) : '',
      notes:    obj.notes||'',
      gleise:   obj.gleise ? JSON.parse(JSON.stringify(obj.gleise)) : [],
    });
  };

  const openNew = () => {
    setEditing(null);
    setForm(blank);
    setShowAdd(true);
  };

  if (!route) return (
    <div style={{display:'flex',height:'100dvh',alignItems:'center',justifyContent:'center',flexDirection:'column',gap:12,color:'var(--faint)',fontFamily:'var(--mono)',fontSize:12}}>
      <div>Keine Strecke geladen.</div>
      <button onClick={()=>window.location.href='../'} style={{background:'var(--s1)',border:'1px solid var(--b1)',borderRadius:3,color:'var(--dim)',padding:'6px 14px',cursor:'pointer',fontFamily:'var(--mono)',fontSize:11}}>← Zurück</button>
    </div>
  );

  const needSpeed = ['SPEED','LA'].includes(form.type);
  const isGrade   = form.type === 'GRADE';
  const isSta     = form.type === 'STATION';

  return (
    <div className="page">

      {/* ── Bar ── */}
      <div className="bar">
        <button className="ic" onClick={()=>window.location.href='../'}> ←</button>
        <span style={{flex:1,fontWeight:600,fontSize:13,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
          {route.name}
        </span>
        <span className="bar-lbl">Editor</span>
        <span style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--faint)'}}>
          {activeObjs.length} Obj.
        </span>
      </div>

      {/* ── Hin / Rück Tabs ── */}
      <div className="tabs">
        <div className={`tab ${dir==='hin'?'active':''}`} onClick={()=>setDir('hin')}>
          ↓ HIN <span style={{fontSize:9,opacity:.6}}>(km {route.startKm}→{route.endKm})</span>
        </div>
        <div className={`tab rueck ${dir==='rueck'?'active':''}`} onClick={switchToRueck}>
          ↑ RÜCK
          {!route.objects_rueck && <span style={{fontSize:9,opacity:.5}}> (neu)</span>}
        </div>
      </div>

      {/* ── Inhalt ── */}
      <div className="scroll">

        {dir==='rueck' && route.objects_rueck && (
          <div className="rueck-hint">
            ↑ Rück-Richtung — unabhängig von Hin bearbeitbar.
            Die Objekte wurden einmalig von Hin übernommen.
            <button className="btn bsm" style={{marginLeft:10,background:'#2a2010',border:'1px solid #6a5020',color:'#d4a840',cursor:'pointer'}}
              onClick={()=>{
                if (!confirm('Rück-Richtung komplett von Hin neu übernehmen? Alle Änderungen gehen verloren.')) return;
                const r = {...route, objects_rueck: null};
                DB.save(r);
                const r2 = DB.initRueck(route.id);
                setRoute(r2);
              }}>
              ↺ Von Hin neu übernehmen
            </button>
          </div>
        )}

        {activeObjs.length === 0 ? (
          <div className="empty">
            <div style={{fontSize:12}}>
              {dir==='rueck'
                ? 'Rück-Richtung angelegt — Objekte von Hin übernommen.'
                : 'Noch keine Objekte — + drücken'}
            </div>
          </div>
        ) : activeObjs.map(obj => {
          const t = TYPES[obj.type]||TYPES.STATION;
          const det = [];
          if (obj.speed!=null)    det.push(obj.speed+' km/h');
          if (obj.speedEnd)       det.push('bis km '+obj.speedEnd);
          if (obj.gradient!=null) det.push((obj.gradient>0?'↗':'↘')+Math.abs(obj.gradient)+'‰');
          if (obj.notes)          det.push(obj.notes);
          if (obj.gleise?.length) det.push(`${obj.gleise.length} Gl.`);
          return (
            <div key={obj.id} className="objr">
              <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--dim)',width:52,flexShrink:0}}>
                {obj.km.toFixed(3)}
              </span>
              <span className="tag" style={{background:t.bg,color:t.clr,flexShrink:0}}>{t.s}</span>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontSize:13,fontWeight:500,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                  {obj.name||t.l}
                </div>
                {det.length>0 && (
                  <div style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--dim)'}}>
                    {det.join(' · ')}
                  </div>
                )}
              </div>
              <button className="ic" style={{fontSize:12,flexShrink:0}} onClick={()=>openEdit(obj)}>✎</button>
              <button className="ic" style={{fontSize:12,flexShrink:0,color:'var(--red)'}}
                onClick={()=>saveObjs(activeObjs.filter(o=>o.id!==obj.id))}>✕</button>
            </div>
          );
        })}
      </div>

      <button className="fab" onClick={openNew}>+</button>

      {/* ── Objekt-Sheet ── */}
      {showAdd && (
        <div className="ov" onClick={e=>e.target===e.currentTarget&&setShowAdd(false)}>
          <div className="sheet">
            <div className="sheet-h">{editing?'Objekt bearbeiten':'Objekt hinzufügen'}</div>

            <div className="irow">
              <F label="km-Position">
                <input className="inp" value={form.km}
                  onChange={e=>fv('km',e.target.value)}
                  inputMode="decimal" autoFocus placeholder="0.000"/>
              </F>
              <F label="Typ">
                <select className="inp" value={form.type} onChange={e=>fv('type',e.target.value)}>
                  {Object.entries(TYPES).map(([k,v])=><option key={k} value={k}>{v.l}</option>)}
                </select>
              </F>
            </div>

            <F label="Name / Bezeichnung (optional)">
              <input className="inp" value={form.name}
                onChange={e=>fv('name',e.target.value)}
                placeholder={isSta?'z. B. München Hbf':'Bezeichnung (optional)'}/>
            </F>

            {needSpeed && <>
              <F label="Geschwindigkeit km/h">
                <input className="inp" type="number" value={form.speed}
                  onChange={e=>fv('speed',e.target.value)}/>
              </F>
              {form.type==='LA' && (
                <F label="La-Ende km">
                  <input className="inp" value={form.speedEnd}
                    onChange={e=>fv('speedEnd',e.target.value)} inputMode="decimal"/>
                </F>
              )}
            </>}

            {isGrade && (
              <F label="Neigung ‰ (negativ = Gefälle, 0 = eben)">
                <input className="inp" value={form.gradient}
                  onChange={e=>fv('gradient',e.target.value)} inputMode="decimal"/>
              </F>
            )}

            <F label="Notizen (optional)">
              <input className="inp" value={form.notes}
                onChange={e=>fv('notes',e.target.value)}
                placeholder="z. B. Sicherungsart, Bemerkung…"/>
            </F>

            {/* Gleise — nur bei Stationen */}
            {isSta && (
              <F label="Gleise / Bahnsteige (optional)">
                <GleiseEditor
                  gleise={form.gleise||[]}
                  onChange={g=>fv('gleise',g)}/>
              </F>
            )}

            <div className="sheet-f">
              <button className="btn bo" onClick={()=>{setShowAdd(false);setEditing(null);}}>Abbrechen</button>
              <button className="btn bp" onClick={saveObj}>Speichern</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<Editor/>);
</script>
</body>
</html>
