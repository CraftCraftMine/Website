<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>CCMN™ Web EBuLa – Tutorial</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<script src="../shared/types.js"></script>
<script src="../shared/db.js"></script>
<script src="../shared/calc.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
:root{
  --bg:#09090d;--s1:#111116;--s2:#16161d;--s3:#1d1d26;
  --b1:#252532;--b2:#303040;
  --text:#c4c4d6;--dim:#686880;--faint:#30303f;
  --pri:#3a7ec4;--pri2:#1e4f88;--priL:#5090d4;--red:#b03030;--grn2:#38b060;
  --mono:'IBM Plex Mono',monospace;--sans:'IBM Plex Sans',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body,#root{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);}
::-webkit-scrollbar{width:3px;} ::-webkit-scrollbar-thumb{background:var(--b2);}

.page{display:flex;flex-direction:column;height:100dvh;}
.bar{display:flex;align-items:center;gap:9px;padding:0 13px;height:44px;background:var(--s1);border-bottom:1px solid var(--b1);flex-shrink:0;}
.brand{font-family:var(--mono);font-size:11px;letter-spacing:3px;color:var(--pri);}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:0 12px;height:30px;border-radius:3px;border:none;cursor:pointer;font-family:var(--sans);font-size:12px;font-weight:500;white-space:nowrap;}
.bp{background:var(--pri2);color:#b8d4f0;border:1px solid #3a7ec440;} .bp:hover{background:var(--pri);color:#fff;}
.bo{background:transparent;color:var(--dim);border:1px solid var(--b2);} .bo:hover{background:var(--s3);color:var(--text);}
.bsm{height:26px;padding:0 9px;font-size:11px;}
.ic{width:28px;height:28px;border-radius:3px;background:transparent;border:1px solid var(--b1);cursor:pointer;color:var(--dim);font-size:14px;display:inline-flex;align-items:center;justify-content:center;}
.ic:hover{background:var(--s3);color:var(--text);}
.scroll{flex:1;overflow-y:auto;padding:16px;}

/* ── Tutorial Cards ── */
.tut-card{
  background:var(--s1);border:1px solid var(--b1);border-radius:8px;
  margin-bottom:12px;overflow:hidden;
}
.tut-card-h{
  display:flex;align-items:center;gap:10px;padding:13px 14px;cursor:pointer;
}
.tut-num{
  width:26px;height:26px;border-radius:50%;border:1.5px solid var(--pri2);
  font-family:var(--mono);font-size:11px;color:var(--pri);flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
}
.tut-num.done{background:var(--pri2);color:#b8d4f0;border-color:var(--pri);}
.tut-title{font-size:13px;font-weight:600;flex:1;}
.tut-body{padding:0 14px 14px;}
.tut-txt{font-size:12px;color:var(--dim);line-height:1.7;margin-bottom:10px;}
.tut-img{
  background:var(--s2);border:1px solid var(--b1);border-radius:4px;
  padding:14px;margin-bottom:10px;font-family:var(--mono);font-size:11px;
  color:var(--faint);
}

/* Spotlight-Overlay */
@keyframes tring{
  0%,100%{outline-color:var(--pri);}
  50%{outline-color:var(--priL);box-shadow:0 0 12px var(--pri)44;}
}
.tut-spot{
  position:fixed;z-index:850;border-radius:4px;
  outline:3px solid var(--pri);outline-offset:4px;
  animation:tring 1.4s infinite;pointer-events:none;
}
/* 4-Panel Dimmer (erzeugt Spotlight-Loch ohne overflow) */
.dim-top,.dim-bot,.dim-l,.dim-r{
  position:fixed;background:#000000c0;z-index:840;pointer-events:all;
}

/* Tutorial-Karte (über Overlay) */
.tut-ov-card{
  position:fixed;z-index:860;
  background:var(--s1);border:1px solid var(--pri2);border-top:2px solid var(--pri);
  border-radius:8px;padding:15px;
  width:calc(100% - 24px);max-width:380px;
  box-shadow:0 8px 32px #00000080;
}
.tut-n{font-family:var(--mono);font-size:9px;color:var(--dim);margin-bottom:3px;text-transform:uppercase;letter-spacing:1px;}
.tut-ov-title{font-size:14px;font-weight:600;margin-bottom:7px;}
.tut-ov-txt{font-size:12px;color:var(--dim);line-height:1.65;margin-bottom:10px;}
.tut-bars{display:flex;gap:3px;margin-bottom:10px;}
.tut-bar{height:2px;flex:1;border-radius:1px;background:var(--b2);}
.tut-bar.on{background:var(--pri);}
.tut-nav{display:flex;gap:6px;justify-content:flex-end;align-items:center;}

/* Live EBuLa Demo */
.demo-device{
  background:#0c0c10;border:2px solid #2a2a2a;border-radius:6px;
  font-family:'IBM Plex Mono',monospace;overflow:hidden;margin-bottom:12px;
}
.demo-hdr{display:grid;grid-template-columns:60px 1fr 100px 80px;border-bottom:1px solid #1a1a1a;background:#080808;}
.demo-hc{padding:4px 6px;font-size:10px;border-right:1px solid #1a1a1a;}
.demo-hc:last-child{border-right:none;}
.demo-strip{overflow:hidden;}
.demo-row{display:grid;grid-template-columns:48px 16px 42px 1fr 48px 48px;border-bottom:1px solid #111;}
.demo-col{padding:2px 4px;font-size:10px;border-right:1px solid #111;display:flex;align-items:center;}
.demo-col:last-child{border-right:none;}

/* Footer */
.footer{flex-shrink:0;background:var(--s1);border-top:1px solid var(--b1);padding:10px 13px;}
.footer-logo{font-family:var(--mono);font-size:9px;color:var(--pri);letter-spacing:2px;margin-bottom:5px;}
.footer-txt{font-size:10px;color:var(--dim);line-height:1.6;}
</style>
</head>
<body><div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useMemo } = React;

/* ── Live EBuLa Demo Strip ── */
function LiveDemo() {
  const animRef = useRef(null);
  const [pct, setPct] = useState(0);
  const items = DEMO_ROUTE.objects.slice(0,8);
  const served = DEMO_ROUTE.timetables[0].stops;

  useEffect(() => {
    animRef.current = setInterval(() => {
      setPct(p => p >= 1 ? 0 : p + 0.004);
    }, 100);
    return () => clearInterval(animRef.current);
  }, []);

  const curKm = DEMO_ROUTE.startKm + (DEMO_ROUTE.endKm - DEMO_ROUTE.startKm) * pct;
  const nextStop = served.filter(s=>s.km>curKm).sort((a,b)=>a.km-b.km)[0];
  const timeApprox = secToTime((10*3600) + pct*26*60, true);

  return (
    <div className="demo-device">
      {/* Header */}
      <div className="demo-hdr">
        <div className="demo-hc" style={{color:'#555',fontSize:9}}>2026</div>
        <div className="demo-hc" style={{color:'#3a9a50',fontSize:9}}>RE 4711 · Demo</div>
        <div className="demo-hc" style={{color:'#555',fontSize:9,textAlign:'right'}}>22.02.2026</div>
        <div className="demo-hc" style={{color:'#c8c8d8',fontWeight:600,fontSize:11}}>{timeApprox}</div>
      </div>
      {/* Info */}
      <div style={{padding:'2px 6px',borderBottom:'1px solid #111',background:'#050505',fontSize:9,display:'flex',gap:10}}>
        <span style={{color:'#3a7ec4',fontWeight:600}}>ab km {curKm.toFixed(1)}</span>
        <span style={{color:'#555'}}>{nextStop?`→ ${nextStop.name}`:''}</span>
      </div>
      {/* Kopfzeile */}
      <div className="demo-row" style={{background:'#0a0a0a'}}>
        <div className="demo-col" style={{color:'#333',fontSize:8}}>V</div>
        <div className="demo-col"/>
        <div className="demo-col" style={{color:'#333',fontSize:8}}>km</div>
        <div className="demo-col" style={{color:'#333',fontSize:8}}>Bezeichnung</div>
        <div className="demo-col" style={{color:'#333',fontSize:8,justifyContent:'center'}}>an</div>
        <div className="demo-col" style={{color:'#333',fontSize:8,justifyContent:'center'}}>ab</div>
      </div>
      {/* Zeilen */}
      {items.map((item,i) => {
        const isSta = item.type==='STATION';
        const h     = isSta ? 40 : 22;
        const passed= item.km < curKm - 0.1;
        const isCur = Math.abs(item.km - curKm) < (isSta?0.5:0.2);
        const tp    = TYPES[item.type]||TYPES.STATION;
        const ttStop= served.find(s=>s.sid===item.id);
        return (
          <div key={item.id} className="demo-row"
            style={{height:h,background:isCur?'#0a180a':'transparent',opacity:passed?.4:1}}>
            {/* V */}
            <div className="demo-col" style={{position:'relative',justifyContent:'flex-end'}}>
              {item.type==='SPEED'&&<span style={{color:'#a89020',fontSize:9,fontWeight:600}}>{item.speed}</span>}
              {item.type==='LA'  &&<span style={{color:'#b03030',fontSize:9,fontWeight:600}}>La {item.speed}</span>}
            </div>
            {/* Gleis */}
            <div className="demo-col" style={{justifyContent:'center',position:'relative'}}>
              <div style={{position:'absolute',top:0,bottom:0,width:2,left:'50%',transform:'translateX(-50%)',background:passed?'#111':isCur?'#38b060':'#222'}}/>
              {isSta && <div style={{width:isCur?10:7,height:isCur?10:7,borderRadius:'50%',background:passed?'#222':'#c4c4d6',position:'relative',zIndex:2,border:`1px solid ${isCur?'#38b060':'#000'}`}}/>}
              {isCur && <div style={{position:'absolute',top:'50%',left:'50%',transform:'translate(-50%,-50%) rotate(45deg)',width:8,height:8,background:'#38b060',border:'1.5px solid #000',zIndex:10}}/>}
            </div>
            {/* km */}
            <div className="demo-col" style={{justifyContent:'flex-end',fontSize:9,color:isCur?'#38b060':'#444'}}>{item.km.toFixed(1)}</div>
            {/* Name */}
            <div className="demo-col" style={{fontSize:isSta?10:9,color:passed?'#333':isSta?'#c4c4d6':'#555',fontWeight:isSta?600:400,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
              {item.name||TYPES[item.type]?.l}
              {item.type==='GRADE'&&item.gradient!=null&&<span style={{color:'#247040'}}> {item.gradient>0?'↗':'↘'}{Math.abs(item.gradient)}‰</span>}
            </div>
            {/* An */}
            <div className="demo-col" style={{justifyContent:'center',fontSize:9,color:'#b89030'}}>{ttStop?.arr?.slice(0,5)||''}</div>
            {/* Ab */}
            <div className="demo-col" style={{justifyContent:'center',fontSize:9,color:'#b89030'}}>{ttStop?.dep?.slice(0,5)||''}</div>
          </div>
        );
      })}
      <div style={{padding:'4px 6px',fontSize:8,color:'#1a1a1a',fontFamily:'IBM Plex Mono',letterSpacing:2,textAlign:'center'}}>
        ══ Demo: {DEMO_ROUTE.name} ══
      </div>
    </div>
  );
}

/* ── Tutorial Inhalt ── */
const CHAPTERS = [
  {
    id:'overview',
    title:'Überblick: Was ist CCMN™ Web EBuLa?',
    steps:[
      {
        title:'Startseite',
        txt:'Auf der Startseite siehst du alle deine Strecken. Mit + legst du neue an. Das ☰-Menü hat Import, GitHub-Browser und Tutorial-Neustart.',
        highlight:null,
      },
      {
        title:'Navigation',
        txt:'Die App besteht aus mehreren Bereichen:\n• Startseite — Strecken verwalten\n• Editor — Streckenobjekte eintragen\n• Fahrpläne — Zugzeiten speichern\n• Ansicht — das EBuLa-Display mit Gerät',
        highlight:null,
      },
    ]
  },
  {
    id:'strecke',
    title:'Strecken erstellen & bearbeiten',
    steps:[
      {
        title:'Neue Strecke anlegen',
        txt:'Tippe auf + (unten rechts auf der Startseite). Pflichtfeld ist nur der Name. Optional kannst du Beschreibung, Strecken-Nr., Fahrzeugtyp, Spurweite und Autor angeben.',
        highlight:null,
      },
      {
        title:'Objekte im Editor',
        txt:'Im Editor trägst du alle Streckenpunkte ein — jedes an der richtigen km-Position:\n\n• Bf = Bahnhof / Haltepunkt\n• V = Geschwindigkeitswechsel\n• La = Langsamfahrstelle (mit Ende-km)\n• BÜ = Bahnübergang\n• Sig = Signal (Einfahrt / Ausfahrt)\n• Tu▸ / ▸Tu = Tunnel Anfang / Ende\n• ‰ = Steigung oder Gefälle',
        highlight:null,
      },
    ]
  },
  {
    id:'fahrplan',
    title:'Fahrpläne erstellen',
    steps:[
      {
        title:'Fahrplan anlegen',
        txt:'Über den Button „Fahrpläne" auf der Strecken-Karte öffnest du den Fahrplan-Manager. Dort legst du mit + neue Fahrpläne an.\n\nPro Strecke können mehrere Fahrpläne existieren — z. B. ein RE und ein IC auf der gleichen Strecke.',
        highlight:null,
      },
      {
        title:'Zeitbasiert vs. Ø-Geschwindigkeit',
        txt:'Zeitbasiert: Du trägst Ankunft und Abfahrt für jeden Halt ein (HH:MM:SS). Die Position wird per Interpolation zwischen den Ankerpunkten berechnet.\n\nØ-Geschwindigkeit: Nur Abfahrtszeit + Durchschnitts-km/h. Die Position wächst linear.',
        highlight:null,
      },
      {
        title:'Fahrplan-Nr.',
        txt:'In der EBuLa-Ansicht kannst du per Numpad (1–0) direkt zwischen Fahrplänen wechseln. Die Nummer entspricht der Reihenfolge in der Liste.',
        highlight:null,
      },
    ]
  },
  {
    id:'ansicht',
    title:'Die EBuLa-Ansicht — Layout & Bedienung',
    steps:[
      {
        title:'Live-Demo',
        txt:'So sieht die EBuLa-Ansicht aus — die Raute (◆) bewegt sich mit der Zeit. In der echten App läuft sie im 1:1-Echtzeittakt.',
        highlight:null,
        demo:true,
      },
      {
        title:'Spalten-Layout',
        txt:'Der Buchfahrplan-Streifen hat 6 Spalten:\n\n[V] Geschwindigkeiten mit Klammerlinie\n[▏] Gleislinie mit Bahnhofs-Punkten\n[km] km-Position\n[Bezeichnung] Name des Objekts\n[an] Ankunftszeit\n[ab] Abfahrtszeit\n\nDie grüne Raute (◆) ist deine aktuelle Position.',
        highlight:null,
      },
      {
        title:'Obere Buttons',
        txt:'☀ aus/an — Display-Helligkeit / An/Aus\nS — Streckeninfo-Overlay\ni — Info zum aktuellen Objekt\nSt — Störungsmeldung eingeben\nV>0 — Geschwindigkeitsbeschränkungen ein/aus\nV=0 — Nur Stationen anzeigen\n◑ — Nachtmodus (Grün-Filter)\nUD — Fahrtrichtung umkehren\n⛶ — Vollbild',
        highlight:null,
      },
      {
        title:'Rechte Buttons & Numpad',
        txt:'C — Zurück / Overlay schließen\n◄ / ► — Manuelles Scrollen\n▲ / ▼ — km-Versatz ±0,1\nE — Auto-Scroll ein/aus / Bestätigen\n\n1–0 = Fahrplan 1–10 direkt wählen\n⊙ = Auto-Scroll\n↺ = km-Versatz zurücksetzen\n\nDas Label unten rechts öffnet Licht & Kontrast.',
        highlight:null,
      },
    ]
  },
  {
    id:'github',
    title:'GitHub & Import / Export',
    steps:[
      {
        title:'Export',
        txt:'Mit „Export" auf der Strecken-Karte lädst du eine JSON-Datei herunter. Diese enthält Strecke + alle Fahrpläne.',
        highlight:null,
      },
      {
        title:'GitHub-Repo',
        txt:`Strecken können von GitHub importiert werden. Das Repo ${GH_REPO} muss public sein und eine index.json mit dieser Struktur enthalten:\n\n{\n  "routes": [\n    {\n      "name": "Streckenname",\n      "file": "strecke.json",\n      "desc": "Beschreibung"\n    }\n  ]\n}`,
        highlight:null,
        code:true,
      },
      {
        title:'Abwärtskompatibilität',
        txt:'Ältere EBuLa-Dateien werden beim Import automatisch auf das aktuelle Schema migriert. Fehlende Felder werden mit Standardwerten ergänzt. Du verlierst keine Daten.',
        highlight:null,
      },
    ]
  },
];

function TutorialPage() {
  const [openChap,   setOpenChap]   = useState(null);
  const [openStep,   setOpenStep]   = useState(0);

  const done = () => {
    DB.markTut();
    window.location.href = '../';
  };

  return (
    <div className="page">
      <div className="bar">
        <button className="ic" onClick={()=>window.location.href='../'}>←</button>
        <span style={{flex:1,fontFamily:'var(--mono)',fontSize:11,letterSpacing:2,color:'var(--pri)'}}>CCMN™ EBULA — TUTORIAL</span>
        <button className="btn bo bsm" onClick={done}>Fertig &amp; zurück</button>
      </div>

      <div className="scroll">
        <div style={{marginBottom:16}}>
          <div style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--faint)',marginBottom:8,letterSpacing:1}}>INTERAKTIVE ANLEITUNG</div>
          <div style={{fontSize:13,color:'var(--dim)',lineHeight:1.7}}>
            Tippe auf ein Kapitel um es zu öffnen. Die Live-Demo im Abschnitt „Ansicht" zeigt das EBuLa-Display in Aktion.
          </div>
        </div>

        {CHAPTERS.map((ch, ci) => (
          <div className="tut-card" key={ch.id}>
            <div className="tut-card-h" onClick={()=>setOpenChap(openChap===ci?null:ci)}>
              <div className={`tut-num ${DB.tutDone()?'done':''}`}>{ci+1}</div>
              <div className="tut-title">{ch.title}</div>
              <span style={{color:'var(--faint)',fontSize:14}}>{openChap===ci?'▲':'▼'}</span>
            </div>
            {openChap===ci && (
              <div className="tut-body">
                {ch.steps.map((step, si) => (
                  <div key={si} style={{marginBottom:si<ch.steps.length-1?16:0}}>
                    <div style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--pri)',letterSpacing:1,textTransform:'uppercase',marginBottom:5}}>
                      {ci+1}.{si+1} · {step.title}
                    </div>
                    {step.demo && <LiveDemo/>}
                    <div className="tut-txt" style={{whiteSpace:'pre-line'}}>
                      {step.txt}
                    </div>
                    {step.code && (
                      <div style={{background:'var(--bg)',border:'1px solid var(--b1)',borderRadius:3,padding:'10px',fontFamily:'var(--mono)',fontSize:10,color:'var(--faint)',whiteSpace:'pre-wrap',marginTop:6,lineHeight:1.6}}>
{`{
  "routes": [
    {
      "name": "Streckenname",
      "file": "strecke.json",
      "desc": "Beschreibung"
    }
  ]
}`}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        ))}

        <div style={{marginTop:12,display:'flex',gap:8,flexWrap:'wrap'}}>
          <button className="btn bp" onClick={done}>Tutorial abschließen &amp; zurück →</button>
          <button className="btn bo bsm" onClick={()=>{
            const r = DB.migrate({...DEMO_ROUTE, id:Date.now().toString()});
            DB.save(r);
            alert('Demo-Strecke „'+r.name+'" wurde zur Startseite hinzugefügt.');
          }}>Demo-Strecke hinzufügen</button>
        </div>

        <div style={{height:24}}/>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<TutorialPage/>);
</script>
</body>
</html>
