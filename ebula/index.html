<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>CCMN™ Web EBuLa</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
/* ═══════════════════════════════════════════
   CCMN™ WEB EBULA v4  —  BASE STYLES
═══════════════════════════════════════════ */
:root{
  --bg:#09090d; --s1:#111116; --s2:#16161d; --s3:#1d1d26;
  --b1:#252532; --b2:#303040; --b3:#404055;
  --text:#c4c4d6; --dim:#686880; --faint:#30303f;
  --pri:#3a7ec4; --pri2:#1e4f88; --priL:#5090d4;
  --acc:#b89030; --grn:#287840; --grn2:#38b060;
  --red:#b03030; --yel:#a89020; --red2:#c84040;
  --mono:'IBM Plex Mono',monospace; --sans:'IBM Plex Sans',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body,#root{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);font-size:14px;}
::-webkit-scrollbar{width:3px;} ::-webkit-scrollbar-thumb{background:var(--b2);}

.app{display:flex;flex-direction:column;height:100dvh;}
.page{display:flex;flex-direction:column;flex:1;min-height:0;}
.topbar{display:flex;align-items:center;gap:9px;padding:0 13px;height:44px;
  background:var(--s1);border-bottom:1px solid var(--b1);flex-shrink:0;}
.brand{font-family:var(--mono);font-size:11px;letter-spacing:3px;color:var(--pri);flex:1;}
.topbar-lbl{font-family:var(--mono);font-size:9px;color:var(--faint);letter-spacing:1px;text-transform:uppercase;}
.scroll{flex:1;overflow-y:auto;padding:12px;}

/* ── Buttons ── */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:0 12px;
  height:30px;border-radius:3px;border:none;cursor:pointer;
  font-family:var(--sans);font-size:12px;font-weight:500;white-space:nowrap;}
.bp{background:var(--pri2);color:#b8d4f0;border:1px solid #3a7ec440;}
.bp:hover{background:var(--pri);color:#fff;}
.bo{background:transparent;color:var(--dim);border:1px solid var(--b2);}
.bo:hover{background:var(--s3);color:var(--text);}
.bx{background:transparent;color:var(--red);border:1px solid #b0303028;}
.bx:hover{background:#b0303018;}
.bsm{height:26px;padding:0 9px;font-size:11px;}
.ic{width:28px;height:28px;border-radius:3px;background:transparent;border:1px solid var(--b1);
  cursor:pointer;color:var(--dim);font-size:13px;display:inline-flex;align-items:center;
  justify-content:center;transition:all .1s;}
.ic:hover{background:var(--s3);color:var(--text);border-color:var(--b2);}
.fab{position:fixed;bottom:72px;right:14px;width:44px;height:44px;border-radius:50%;
  background:var(--pri2);border:1px solid var(--pri)44;cursor:pointer;font-size:20px;
  color:#b8d4f0;display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 18px #1e4f8840;z-index:41;transition:transform .15s;}
.fab:hover{transform:scale(1.08);}

/* ── Form ── */
.field{margin-bottom:10px;}
.field>label{display:block;font-family:var(--mono);font-size:9px;color:var(--dim);
  margin-bottom:4px;text-transform:uppercase;letter-spacing:.8px;}
.inp{width:100%;background:var(--s2);border:1px solid var(--b1);border-radius:3px;
  padding:7px 9px;color:var(--text);font-family:var(--sans);font-size:13px;outline:none;}
.inp:focus{border-color:var(--pri2);}
select.inp{cursor:pointer;}
.irow{display:flex;gap:8px;} .irow .field{flex:1;}
.chk{display:flex;align-items:center;gap:7px;cursor:pointer;font-size:13px;padding:3px 0;}
.chk input{width:14px;height:14px;accent-color:var(--pri);cursor:pointer;}

/* ── Modal ── */
.ov{position:fixed;inset:0;background:#000000b0;z-index:300;display:flex;align-items:flex-end;}
.sheet{background:var(--s1);border:1px solid var(--b1);border-top:2px solid var(--pri2);
  border-radius:12px 12px 0 0;width:100%;max-height:92dvh;overflow-y:auto;padding:17px 14px;}
.sheet-h{font-size:15px;font-weight:600;margin-bottom:13px;}
.sheet-f{display:flex;gap:7px;justify-content:flex-end;margin-top:13px;
  padding-top:10px;border-top:1px solid var(--b1);}

/* ── Cards ── */
.rcard{background:var(--s1);border:1px solid var(--b1);border-radius:4px;margin-bottom:9px;}
.rcard-h{padding:11px 13px;}
.rcard-n{font-weight:600;font-size:14px;}
.rcard-m{font-family:var(--mono);font-size:10px;color:var(--faint);margin-top:3px;}
.rcard-a{display:flex;gap:6px;padding:7px 13px;background:var(--s2);
  border-top:1px solid var(--b1);flex-wrap:wrap;align-items:center;}

/* ── Tabs ── */
.tabs{display:flex;border-bottom:1px solid var(--b1);margin-bottom:13px;}
.tab{padding:8px 13px;font-family:var(--mono);font-size:10px;color:var(--dim);cursor:pointer;
  border-bottom:2px solid transparent;letter-spacing:.5px;text-transform:uppercase;}
.tab.on{color:var(--pri);border-bottom-color:var(--pri);}

/* ── Empty ── */
.empty{display:flex;flex-direction:column;align-items:center;padding:48px 20px;gap:8px;color:var(--faint);text-align:center;}

/* ── Footer ── */
.footer{flex-shrink:0;background:var(--s1);border-top:1px solid var(--b1);padding:10px 13px;}
.footer-logo{font-family:var(--mono);font-size:9px;color:var(--pri);letter-spacing:2px;margin-bottom:6px;}
.footer-txt{font-size:10px;color:var(--dim);line-height:1.65;}

/* ── Tags ── */
.tag{padding:1px 5px;border-radius:2px;font-family:var(--mono);font-size:10px;font-weight:600;}

/* ═══════════════════════════════════════════
   DRIVE / BUCHFAHRPLAN (authentisches Layout)
   Spalten: [V 56px][Gleis 22px][km 48px][Name flex][An 54px][Ab 54px]
═══════════════════════════════════════════ */
.drive{display:flex;flex-direction:column;height:100dvh;background:#07070b;}

/* HUD Zeile */
.hud{display:flex;align-items:stretch;background:var(--s1);border-bottom:2px solid var(--b1);flex-shrink:0;}
.hcell{display:flex;flex-direction:column;justify-content:center;padding:6px 10px;border-right:1px solid var(--b1);}
.hlbl{font-family:var(--mono);font-size:8px;color:var(--faint);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:1px;}
.hval{font-family:var(--mono);font-size:22px;font-weight:600;color:var(--pri);line-height:1;}
.hcenter{flex:1;display:flex;flex-direction:column;justify-content:center;padding:4px 10px;text-align:center;}
.hnext{font-size:13px;font-weight:600;}
.hnextd{font-family:var(--mono);font-size:10px;color:var(--acc);}
.hprev{font-family:var(--mono);font-size:9px;color:var(--faint);}
.htcell{display:flex;flex-direction:column;justify-content:center;align-items:flex-end;padding:5px 9px;gap:4px;}
.htime{font-family:var(--mono);font-size:18px;font-weight:600;color:var(--text);
  background:var(--s2);border:1px solid var(--b2);border-radius:3px;
  width:70px;text-align:center;padding:3px 4px;outline:none;}

/* Fortschritt */
.prog{height:2px;background:var(--s3);flex-shrink:0;}
.progf{height:100%;background:linear-gradient(90deg,var(--pri2),var(--pri));transition:width .5s linear;}

/* ── BFP Streifen ── */
.bfp{flex:1;overflow-y:auto;}

/* Kopfzeile */
.bfp-head{
  display:grid;
  grid-template-columns:56px 22px 48px 1fr 54px 54px;
  background:var(--s2);border-bottom:2px solid var(--b2);
  position:sticky;top:0;z-index:20;
}
.bfp-hcell{
  padding:4px 3px;font-family:var(--mono);font-size:8px;color:var(--faint);
  text-transform:uppercase;letter-spacing:.5px;border-right:1px solid var(--b1);
}
.bfp-hcell:last-child{border-right:none;}

/* Zeile */
.bfp-row{
  display:grid;
  grid-template-columns:56px 22px 48px 1fr 54px 54px;
  position:relative;
  border-bottom:1px solid var(--b1);
  transition:background .2s;
}
.bfp-row.sta{background:#0e0e1800;}
.bfp-row.cur{background:#0c1e0c;}
.bfp-row.passed{opacity:.55;}

/* V-Spalte (Geschwindigkeit / La) */
.col-v{
  position:relative;border-right:1px solid var(--b1);
  display:flex;align-items:flex-end;justify-content:flex-end;padding:0 4px 0 2px;
}
.vnum{font-family:var(--mono);font-weight:600;text-align:right;line-height:1;padding-bottom:2px;}
/* Klammerlinie (absolute in parent col-v) */
.vbracket-line{position:absolute;right:12px;width:1px;top:0;bottom:0;}
.vbracket-tick{position:absolute;right:12px;height:1px;width:8px;}

/* Gleis-Spalte */
.col-tr{
  position:relative;border-right:1px solid var(--b1);
  display:flex;align-items:center;justify-content:center;
}
.gleislinie{position:absolute;top:0;bottom:0;width:2px;left:50%;transform:translateX(-50%);}
/* Station-Symbol */
.bfsym{border-radius:50%;border:2px solid #07070b;position:relative;z-index:2;flex-shrink:0;}
/* Geschw.-Strich */
.vtick{position:absolute;top:50%;left:0;right:0;height:2px;z-index:1;}
/* BÜ-Strich */
.buetick{position:absolute;top:50%;left:0;right:0;height:1px;z-index:1;}
/* Tunnel-Marker */
.tu-cap{position:absolute;left:50%;transform:translateX(-50%);font-family:var(--mono);font-size:10px;z-index:3;}
/* Positions-Raute */
.pdiam{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%) rotate(45deg);
  width:11px;height:11px;background:var(--grn2);
  border:2px solid #07070b;z-index:10;
}
.parm{position:absolute;top:50%;height:1px;background:var(--grn2);opacity:.25;z-index:9;}

/* km-Spalte */
.col-km{
  border-right:1px solid var(--b1);
  display:flex;align-items:center;justify-content:flex-end;padding:0 5px;
}
.kmval{font-family:var(--mono);font-size:10px;color:var(--dim);}
.kmval.act{color:var(--pri);font-weight:600;}

/* Name-Spalte */
.col-name{
  border-right:1px solid var(--b1);
  display:flex;flex-direction:column;justify-content:center;
  padding:3px 6px;overflow:hidden;
}
.bfname{font-family:var(--mono);font-size:11px;font-weight:600;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bfsig{font-family:var(--mono);font-size:10px;color:var(--dim);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* Zeit-Spalten */
.col-an,.col-ab{display:flex;align-items:center;justify-content:center;padding:0 3px;}
.col-ab{border-left:none;}
.bftime{font-family:var(--mono);font-size:11px;color:var(--acc);}

/* Fußleiste */
.dfoot{display:flex;align-items:center;gap:7px;padding:7px 11px;
  background:var(--s1);border-top:1px solid var(--b1);flex-shrink:0;flex-wrap:wrap;}
.offwrap{display:flex;align-items:center;gap:3px;background:var(--s2);
  border:1px solid var(--b1);border-radius:3px;padding:3px 5px;}
.ob{background:var(--s3);border:1px solid var(--b2);border-radius:2px;color:var(--text);
  font-family:var(--mono);font-size:10px;padding:2px 5px;cursor:pointer;}
.ob:hover{background:var(--b2);}

/* ═══════════════════════════════════════════
   TUTORIAL SPOTLIGHT
═══════════════════════════════════════════ */
.tut-dim{position:fixed;inset:0;background:#000000b8;z-index:800;pointer-events:none;}
@keyframes tring{
  0%,100%{box-shadow:0 0 0 3px var(--pri),0 0 0 9999px #000000b8;}
  50%{box-shadow:0 0 0 4px var(--priL),0 0 0 9999px #000000b8,0 0 14px #3a7ec448;}
}
.tut-spot{
  position:fixed;z-index:810;border-radius:4px;pointer-events:none;
  animation:tring 1.4s infinite;
}
.tut-card{
  position:fixed;z-index:820;background:var(--s1);
  border:1px solid var(--pri2);border-top:2px solid var(--pri);
  border-radius:8px;padding:15px;
  width:calc(100% - 24px);max-width:390px;
  box-shadow:0 8px 32px #00000070;
}
.tut-n{font-family:var(--mono);font-size:9px;color:var(--dim);margin-bottom:3px;text-transform:uppercase;letter-spacing:1px;}
.tut-title{font-size:14px;font-weight:600;margin-bottom:7px;}
.tut-txt{font-size:12px;color:var(--dim);line-height:1.65;margin-bottom:10px;}
.tut-bars{display:flex;gap:3px;margin-bottom:10px;}
.tut-bar{height:2px;flex:1;border-radius:1px;background:var(--b2);}
.tut-bar.on{background:var(--pri);}
.tut-nav{display:flex;gap:6px;justify-content:flex-end;align-items:center;}
@keyframes tbounce{from{transform:translateY(0);}to{transform:translateY(-6px);}}
.tut-arrow{position:fixed;z-index:821;font-size:22px;animation:tbounce .8s infinite alternate;
  pointer-events:none;color:var(--priL);}

/* GitHub Browser */
.ghrow{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--b1);}
.ghrow:last-child{border-bottom:none;}
</style>
</head>
<body><div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useMemo, useCallback } = React;

/* ════════════════════════════════════════
   SCHEMA & KONSTANTEN
════════════════════════════════════════ */
const SCHEMA = 4;
const GH_REPO = 'CraftCraftMine/ebula-routes';
const GH_RAW  = `https://raw.githubusercontent.com/${GH_REPO}/main/`;

const TYPES = {
  STATION:{l:'Bahnhof / Haltepunkt', s:'Bf',  clr:'#a0a8c0',bg:'#191b2c'},
  SPEED:  {l:'Geschwindigkeit',       s:'V',   clr:'#a89020',bg:'#201e08'},
  LA:     {l:'Langsamfahrstelle',     s:'La',  clr:'#b03030',bg:'#1e0c0c'},
  BUE:    {l:'Bahnübergang',          s:'BÜ',  clr:'#b03030',bg:'#1e0c0c'},
  SIGNAL: {l:'Signal',                s:'Sig', clr:'#4a5060',bg:'#0c0e12'},
  TU_S:   {l:'Tunnelanfang',          s:'Tu▸', clr:'#3c4450',bg:'#0c0e12'},
  TU_E:   {l:'Tunnelende',            s:'▸Tu', clr:'#3c4450',bg:'#0c0e12'},
  GRADE:  {l:'Steigung / Gefälle',   s:'‰',   clr:'#247040',bg:'#08120a'},
};
const STA_H = 52, ROW_H = 28;

/* ════════════════════════════════════════
   DEMO-STRECKE (alle Objekttypen)
   Fiktive TSW-Strecke: Nordstadt – Südhafen (20 km)
════════════════════════════════════════ */
const DEMO_ROUTE = {
  id:'__demo__', version:SCHEMA,
  name:'Tutorial: Nordstadt – Südhafen',
  desc:'Übungsstrecke · Alle Objekttypen vorhanden',
  startKm:0, endKm:20,
  objects:[
    {id:'d01',km:0.0,  type:'STATION',name:'Nordstadt Hbf',     speed:null,speedEnd:null,gradient:null,notes:'Startbahnhof'},
    {id:'d02',km:0.8,  type:'SIGNAL', name:'Asig N1',           speed:null,speedEnd:null,gradient:null,notes:'Ausfahrsignal'},
    {id:'d03',km:1.5,  type:'SPEED',  name:'',                  speed:120, speedEnd:null,gradient:null,notes:''},
    {id:'d04',km:3.2,  type:'BUE',    name:'Bundesstraße B7',   speed:null,speedEnd:null,gradient:null,notes:''},
    {id:'d05',km:4.0,  type:'GRADE',  name:'',                  speed:null,speedEnd:null,gradient:15,  notes:'Steigung 15‰'},
    {id:'d06',km:5.5,  type:'LA',     name:'Baustelle',         speed:60,  speedEnd:6.5, gradient:null,notes:'Langsamfahrstelle'},
    {id:'d07',km:6.5,  type:'SPEED',  name:'',                  speed:120, speedEnd:null,gradient:null,notes:'La-Ende'},
    {id:'d08',km:7.0,  type:'GRADE',  name:'',                  speed:null,speedEnd:null,gradient:0,   notes:'eben'},
    {id:'d09',km:7.8,  type:'SIGNAL', name:'Esig W',            speed:null,speedEnd:null,gradient:null,notes:'Einfahrsignal'},
    {id:'d10',km:8.5,  type:'STATION',name:'Nordstadt-West Hp', speed:null,speedEnd:null,gradient:null,notes:'Haltepunkt'},
    {id:'d11',km:9.0,  type:'SIGNAL', name:'Asig W',            speed:null,speedEnd:null,gradient:null,notes:'Ausfahrsignal'},
    {id:'d12',km:9.8,  type:'TU_S',   name:'Westtunnel',        speed:null,speedEnd:null,gradient:null,notes:'1500 m lang'},
    {id:'d13',km:11.3, type:'TU_E',   name:'Westtunnel',        speed:null,speedEnd:null,gradient:null,notes:''},
    {id:'d14',km:12.0, type:'SPEED',  name:'',                  speed:160, speedEnd:null,gradient:null,notes:''},
    {id:'d15',km:14.3, type:'SIGNAL', name:'Esig H',            speed:null,speedEnd:null,gradient:null,notes:'Einfahrsignal'},
    {id:'d16',km:14.8, type:'STATION',name:'Hafenbrücke Hp',    speed:null,speedEnd:null,gradient:null,notes:'Haltepunkt'},
    {id:'d17',km:15.3, type:'SIGNAL', name:'Asig H',            speed:null,speedEnd:null,gradient:null,notes:'Ausfahrsignal'},
    {id:'d18',km:16.0, type:'GRADE',  name:'',                  speed:null,speedEnd:null,gradient:-10, notes:'Gefälle 10‰'},
    {id:'d19',km:17.5, type:'SPEED',  name:'',                  speed:80,  speedEnd:null,gradient:null,notes:'Einfahrt'},
    {id:'d20',km:18.0, type:'BUE',    name:'Hafenstraße',       speed:null,speedEnd:null,gradient:null,notes:''},
    {id:'d21',km:19.0, type:'GRADE',  name:'',                  speed:null,speedEnd:null,gradient:0,   notes:'eben'},
    {id:'d22',km:19.5, type:'SIGNAL', name:'Esig S',            speed:null,speedEnd:null,gradient:null,notes:'Einfahrsignal'},
    {id:'d23',km:20.0, type:'STATION',name:'Südhafen Hbf',      speed:null,speedEnd:null,gradient:null,notes:'Zielbahnhof'},
  ],
  timetables:[{
    id:'tt1', name:'RE 4711 (Demo)',
    mode:'TIME', departure:'10:00', avgSpeed:100,
    stops:[
      {sid:'d01',km:0.0, name:'Nordstadt Hbf',    served:true, arr:'',      dep:'10:00'},
      {sid:'d10',km:8.5, name:'Nordstadt-West Hp',served:true, arr:'10:08', dep:'10:09'},
      {sid:'d16',km:14.8,name:'Hafenbrücke Hp',   served:true, arr:'10:16', dep:'10:17'},
      {sid:'d23',km:20.0,name:'Südhafen Hbf',     served:true, arr:'10:26', dep:''},
    ]
  }]
};

/* ════════════════════════════════════════
   DB – localStorage + Schema-Migration
════════════════════════════════════════ */
const DB = {
  migrate(r){
    if (!r.version) r.version = 1;
    // v1→v2: timetables-Array hinzufügen
    if (!r.timetables) r.timetables = [];
    // v2→v3: stop.served = true falls fehlend
    r.timetables.forEach(tt => {
      if (!tt.stops) tt.stops = [];
      tt.stops.forEach(s => { if (s.served === undefined) s.served = true; });
      if (!tt.mode) tt.mode = 'TIME';
      if (!tt.departure) tt.departure = '';
      if (!tt.avgSpeed) tt.avgSpeed = 100;
    });
    // v3→v4: gradient-Feld in objects
    (r.objects||[]).forEach(o => {
      if (o.gradient === undefined) o.gradient = null;
    });
    r.version = SCHEMA;
    return r;
  },
  get(){
    try {
      const d = JSON.parse(localStorage.getItem('ccmn_e4') || '[]');
      return d.map(r => this.migrate(r));
    } catch { return []; }
  },
  set(d){ localStorage.setItem('ccmn_e4', JSON.stringify(d)); },
  save(route){
    const all = this.get();
    const idx = all.findIndex(r => r.id === route.id);
    if (idx >= 0) all[idx] = route; else all.push(route);
    this.set(all);
  },
  tutDone: () => localStorage.getItem('ccmn_tut5') === '1',
  markTut: () => localStorage.setItem('ccmn_tut5','1'),
  resetTut:() => localStorage.removeItem('ccmn_tut5'),
};

/* ════════════════════════════════════════
   ZEIT-UTILITIES
════════════════════════════════════════ */
const toS  = t => { if(!t||!t.includes(':'))return null; const[h,m]=t.split(':').map(Number); return h*3600+m*60; };
const fmtS = s => { s=((s%86400)+86400)%86400; return `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor(s%3600/60)).padStart(2,'0')}`; };
const tdiff= (a,b) => { let d=toS(b)-toS(a); return d<0?d+86400:d; };

function calcKm(timeStr, trip, servedStops) {
  const off = trip.offset || 0;
  const sk  = (trip.startKm || 0) + off;
  if (!timeStr || !trip) return sk;
  const cs = toS(timeStr);
  if (cs === null) return sk;

  if (trip.mode === 'SPEED') {
    const dep = toS(trip.departure);
    if (dep === null) return sk;
    return Math.max(sk, (tdiff(trip.departure, timeStr)/3600) * (trip.avgSpeed||80) + sk);
  }
  // TIME: Interpolation zwischen Ankern
  const anch = servedStops
    .filter(s => s.served && (s.dep || s.arr))
    .map(s => ({ km: s.km, sec: toS(s.dep || s.arr) }))
    .filter(a => a.sec !== null)
    .sort((a,b) => a.km - b.km);
  if (!anch.length) return sk;
  if (cs <= anch[0].sec) return anch[0].km + off;
  const last = anch[anch.length-1];
  if (cs >= last.sec) return last.km + off;
  for (let i=0;i<anch.length-1;i++) {
    let [as,bs,s_]=[anch[i].sec,anch[i+1].sec,cs];
    if(bs<as)bs+=86400; if(s_<as)s_+=86400;
    if(s_>=as&&s_<=bs)
      return anch[i].km + (anch[i+1].km-anch[i].km)*(s_-as)/(bs-as) + off;
  }
  return last.km + off;
}

/* ════════════════════════════════════════
   GESCHWINDIGKEITS-KLAMMERN berechnen
   Gibt segments[] zurück mit {speed,type,topPx,heightPx,color}
════════════════════════════════════════ */
function calcVSegs(items) {
  const segs = [];
  let curV = null, curType = null, curColor = null, curTop = 0;
  let top = 0;
  const isSta = t => t === 'STATION';

  items.forEach((item, i) => {
    const h = isSta(item.type) ? STA_H : ROW_H;
    if (item.type === 'SPEED' || item.type === 'LA') {
      if (curV !== null) segs.push({speed:curV,type:curType,color:curColor,top:curTop,height:top-curTop});
      curV = item.speed; curType = item.type;
      curColor = item.type==='LA' ? 'var(--red)' : 'var(--yel)';
      curTop = top;
    }
    top += h;
  });
  if (curV !== null) segs.push({speed:curV,type:curType,color:curColor,top:curTop,height:top-curTop});
  return segs;
}

/* ════════════════════════════════════════
   UI BASISKOMPONENTEN
════════════════════════════════════════ */
function Footer() {
  return (
    <div className="footer">
      <div className="footer-logo">CCMN™ WEB EBULA v4</div>
      <div className="footer-txt">
        <strong style={{color:'var(--text)'}}>Hobby-Projekt – Nicht kommerziell</strong><br/>
        Diese Website und das CraftCraftMine Netzwerk (CCMN™) sind ein privates, schulisches Projekt
        von Schülern für Schüler. Es besteht keinerlei Absicht auf Gewinnerzielung oder gewerbliche Nutzung.<br/>
        © 2026 CraftCraftMine Netzwerk · CCMN™ = CraftCraftMine Netzwerk™
      </div>
    </div>
  );
}

function Modal({title, onClose, onOk, okLabel='Speichern', children}) {
  return (
    <div className="ov" onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div className="sheet">
        <div className="sheet-h">{title}</div>
        {children}
        <div className="sheet-f">
          <button className="btn bo" onClick={onClose}>Abbrechen</button>
          {onOk && <button className="btn bp" onClick={onOk}>{okLabel}</button>}
        </div>
      </div>
    </div>
  );
}
const F = ({label,children}) => <div className="field"><label>{label}</label>{children}</div>;

/* ════════════════════════════════════════
   GITHUB BROWSER
════════════════════════════════════════ */
function GitHubBrowser({onImport, onClose}) {
  const [loading, setLoading] = useState(true);
  const [list, setList]       = useState([]);
  const [err, setErr]         = useState('');
  const [importing, setImp]   = useState(null);

  useEffect(() => {
    fetch(GH_RAW + 'index.json')
      .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(d => { setList(d.routes||[]); setLoading(false); })
      .catch(e => { setErr('Repo nicht erreichbar: '+e.message); setLoading(false); });
  }, []);

  const doImport = async (item) => {
    setImp(item.file);
    try {
      const res = await fetch(GH_RAW + item.file);
      if (!res.ok) throw new Error('HTTP '+res.status);
      const r = await res.json();
      r.id = Date.now();
      onImport(r);
    } catch(e) { alert('Fehler: '+e.message); }
    setImp(null);
  };

  return (
    <Modal title={`Strecken aus ${GH_REPO}`} onClose={onClose}>
      {loading && <div style={{color:'var(--dim)',fontFamily:'var(--mono)',fontSize:12,padding:'10px 0'}}>Lade…</div>}
      {err && <>
        <div style={{color:'var(--red)',fontSize:12,marginBottom:10}}>{err}</div>
        <div style={{fontSize:11,color:'var(--dim)',lineHeight:1.7}}>
          Repo noch nicht eingerichtet? Erstelle<br/>
          <code style={{color:'var(--pri)'}}>{GH_REPO}</code> auf GitHub (public)<br/>
          und füge eine <code style={{color:'var(--pri)'}}>index.json</code> hinzu.
        </div>
      </>}
      {list.length > 0 && list.map(item => (
        <div className="ghrow" key={item.file}>
          <div style={{flex:1}}>
            <div style={{fontWeight:600,fontSize:13}}>{item.name}</div>
            {item.desc && <div style={{fontSize:11,color:'var(--dim)'}}>{item.desc}</div>}
          </div>
          <button className="btn bp bsm" onClick={()=>doImport(item)} disabled={!!importing}>
            {importing===item.file ? '…' : 'Import'}
          </button>
        </div>
      ))}
      {!loading && !err && list.length===0 && (
        <div style={{color:'var(--dim)',fontSize:12}}>Keine Strecken im Repo gefunden.</div>
      )}
    </Modal>
  );
}

/* ════════════════════════════════════════
   FAHRPLAN-EDITOR (Modal)
════════════════════════════════════════ */
function TimetableEditorModal({route, existing, onSave, onClose}) {
  const stations = (route.objects||[]).filter(o=>o.type==='STATION');
  const [name, setName]   = useState(existing?.name || '');
  const [mode, setMode]   = useState(existing?.mode || 'TIME');
  const [dep,  setDep]    = useState(existing?.departure || '');
  const [avg,  setAvg]    = useState(String(existing?.avgSpeed || 100));
  const [stops, setStops] = useState(() => {
    if (existing) return existing.stops;
    return stations.map(s => ({sid:s.id,km:s.km,name:s.name||'',served:true,arr:'',dep:''}));
  });

  const setStop = (sid, field, val) =>
    setStops(ss => ss.map(s => s.sid===sid ? {...s,[field]:val} : s));

  const save = () => {
    const tt = {
      id: existing?.id || Date.now().toString(),
      name: name.trim() || 'Fahrplan ' + new Date().toLocaleTimeString(),
      mode, departure: dep, avgSpeed: parseFloat(avg)||100, stops
    };
    onSave(tt);
  };

  return (
    <Modal title={existing?'Fahrplan bearbeiten':'Neuer Fahrplan'} onClose={onClose} onOk={save}>
      <div className="irow">
        <F label="Bezeichnung"><input className="inp" value={name} onChange={e=>setName(e.target.value)} placeholder="z. B. RE 4711"/></F>
        <F label="Berechnung">
          <select className="inp" value={mode} onChange={e=>setMode(e.target.value)}>
            <option value="TIME">Zeitbasiert</option>
            <option value="SPEED">Ø-Geschwindigkeit</option>
          </select>
        </F>
      </div>
      <div className="irow">
        <F label="Abfahrtszeit"><input className="inp" value={dep} onChange={e=>setDep(e.target.value)} placeholder="HH:MM"/></F>
        {mode==='SPEED' && <F label="Ø km/h"><input className="inp" type="number" value={avg} onChange={e=>setAvg(e.target.value)}/></F>}
      </div>
      <div style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--faint)',textTransform:'uppercase',letterSpacing:1,marginBottom:8}}>Halte</div>
      {stops.map(s => (
        <div key={s.sid} style={{marginBottom:10,paddingBottom:10,borderBottom:'1px solid var(--b1)'}}>
          <label className="chk">
            <input type="checkbox" checked={!!s.served} onChange={e=>setStop(s.sid,'served',e.target.checked)}/>
            <span style={{fontWeight:600}}>{s.name}</span>
            <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--faint)'}}>km {s.km.toFixed(3)}</span>
          </label>
          {s.served && mode==='TIME' && (
            <div className="irow" style={{marginTop:6,paddingLeft:21}}>
              <F label="Ankunft"><input className="inp" value={s.arr} onChange={e=>setStop(s.sid,'arr',e.target.value)} placeholder="HH:MM"/></F>
              <F label="Abfahrt"><input className="inp" value={s.dep} onChange={e=>setStop(s.sid,'dep',e.target.value)} placeholder="HH:MM"/></F>
            </div>
          )}
        </div>
      ))}
    </Modal>
  );
}

/* ════════════════════════════════════════
   TUTORIAL SYSTEM
   Interaktiv mit Spotlight + echter Benutzerführung
   Demo-Animation: pre-calculated km-Fortschritt
════════════════════════════════════════ */
const TUT_STEPS = [
  {id:'welcome',
   title:'Willkommen bei CCMN™ Web EBuLa!',
   txt:'Ich führe dich jetzt interaktiv durch alle Funktionen — mit der Demostrecke „Nordstadt – Südhafen". Tippe auf Weiter um zu beginnen.',
   target:null, pos:'center', action:'Weiter'},
  {id:'new-route',
   title:'Strecke anlegen — tippe auf +',
   txt:'Um eine Strecke zu erstellen, tippe auf den + Button unten rechts. Er ist jetzt markiert.',
   target:'fab-btn', pos:'above', action:null, waitFor:'new-modal'},
  {id:'fill-form',
   title:'Name & Kilometer eingeben',
   txt:'Gib der Strecke einen Namen und die Start-/Endkilometer ein. Für die Demo ist alles vorausgefüllt — tippe auf „Erstellen".',
   target:'new-sheet', pos:'above', action:null, waitFor:'route-created'},
  {id:'route-card',
   title:'Deine Strecke ist angelegt!',
   txt:'Hier siehst du die Strecke. Mit „Editor" trägst du Objekte ein. Mit „Fahrpläne" verwaltest du gespeicherte Zugfahrten. „Fahrt starten" öffnet die EBuLa-Ansicht.',
   target:'first-card', pos:'below', action:'Verstanden'},
  {id:'editor-btn',
   title:'Editor — tippe auf „Editor"',
   txt:'Im Editor trägst du alle Streckenpunkte ein: Bahnhöfe, Geschwindigkeiten, Langsamfahrstellen, Bahnübergänge, Signale, Tunnel und Steigungen — jedes an der richtigen km-Position.',
   target:'first-editor-btn', pos:'below', action:null, waitFor:'screen-editor'},
  {id:'obj-list',
   title:'Objekte im Editor',
   txt:'Alle Objekte sind nach km sortiert. Links die km-Position, dann Typ-Kürzel und Name. Mit + fügst du neue hinzu. Wenn du alles eingetragen hast, tippe auf ← zurück.',
   target:'back-btn', pos:'below', action:null, waitFor:'screen-home'},
  {id:'timetable-btn',
   title:'Fahrpläne — tippe auf „Fahrpläne"',
   txt:'Fahrpläne speichern Zugzeiten für eine Strecke. Du kannst mehrere verschiedene Züge für dieselbe Strecke speichern und zwischen ihnen wählen.',
   target:'first-tt-btn', pos:'below', action:null, waitFor:'screen-timetables'},
  {id:'timetable-list',
   title:'Gespeicherte Fahrpläne',
   txt:'Hier siehst du alle Fahrpläne für diese Strecke. Mit „Neu" erstellst du einen neuen, mit ▶ startest du eine Fahrt mit diesem Fahrplan. Tippe auf ← zurück.',
   target:'back-btn', pos:'below', action:null, waitFor:'screen-home'},
  {id:'start-btn',
   title:'Fahrt starten — tippe auf „Fahrt starten"',
   txt:'Jetzt starten wir die eigentliche Fahrt. Wähle einen gespeicherten Fahrplan oder erstelle einen neuen auf der Stelle.',
   target:'first-start-btn', pos:'below', action:null, waitFor:'screen-start'},
  {id:'start-dialog',
   title:'Fahrplan auswählen oder neu erstellen',
   txt:'Du kannst einen gespeicherten Fahrplan wählen (Tab „Fahrpläne") oder schnell einen neuen erstellen (Tab „Neu"). Tippe auf „FAHRT BEGINNEN" mit dem Demo-Fahrplan.',
   target:'go-btn', pos:'above', action:null, waitFor:'screen-drive'},
  {id:'ebula-layout',
   title:'Das EBuLa-Layout — so sieht es aus',
   txt:'Links: Geschwindigkeiten mit Klammerlinie. Dann: Gleislinie mit Bahnhofssymbolen. Rechts der Gleislinie: km-Zahlen. Dann: Stations-/Signalnamen. Ganz rechts: Ankunft | Abfahrt.',
   target:'bfp-strip', pos:'right', action:'Weiter'},
  {id:'hud',
   title:'Die Informationsleiste oben',
   txt:'Aktuelle Strecken-km (blau), nächster Halt mit Zeiten und Entfernung (Mitte), Ingame-Zeit rechts (direkt eingebbar). ⊙ = Auto-Scroll, ⚙ = km-Versatz.',
   target:'drive-hud', pos:'below', action:'Weiter'},
  {id:'demo-run',
   title:'Jetzt läuft die Demo-Fahrt!',
   txt:'Die Positionsraute bewegt sich automatisch — das ist eine beschleunigte Vorschau. Im echten Spiel läuft die Zeit 1:1 in Echtzeit. Tippe auf ▶ START um die eigene Zeit laufen zu lassen.',
   target:'dfoot', pos:'above', action:'Tutorial beenden'},
];

function Tutorial({step, onNext, onSkip}) {
  const s = TUT_STEPS[step] || TUT_STEPS[0];
  const [spotRect, setSpotRect] = useState(null);
  const [cardStyle, setCardStyle] = useState({bottom:20,left:'50%',transform:'translateX(-50%)'});

  useEffect(() => {
    if (!s.target) { setSpotRect(null); setCardStyle({bottom:20,left:'50%',transform:'translateX(-50%)'}); return; }
    const update = () => {
      const el = document.getElementById(s.target);
      if (!el) { setSpotRect(null); return; }
      const r = el.getBoundingClientRect();
      const pad = 5;
      setSpotRect({top:r.top-pad,left:r.left-pad,width:r.width+pad*2,height:r.height+pad*2});
      // Karte positionieren
      const cardH = 220;
      if (r.top > window.innerHeight * 0.55) {
        setCardStyle({bottom: window.innerHeight-r.top+pad+8, left:'50%', transform:'translateX(-50%)'});
      } else {
        const topPos = r.bottom + pad + 10;
        setCardStyle({top: Math.min(topPos, window.innerHeight-cardH-10), left:'50%', transform:'translateX(-50%)'});
      }
    };
    update();
    const t = setInterval(update, 150);
    return () => clearInterval(t);
  }, [step, s.target]);

  const isLast = step === TUT_STEPS.length - 1;

  return (
    <>
      <div className="tut-dim" style={{pointerEvents: s.waitFor ? 'none' : 'all'}}/>
      {spotRect && (
        <div className="tut-spot" style={{top:spotRect.top,left:spotRect.left,width:spotRect.width,height:spotRect.height}}/>
      )}
      <div className="tut-card" style={{...cardStyle}}>
        <div className="tut-n">Schritt {step+1} / {TUT_STEPS.length}</div>
        <div className="tut-title">{s.title}</div>
        <div className="tut-txt">{s.txt}</div>
        <div className="tut-bars">
          {TUT_STEPS.map((_,i) => <div key={i} className={`tut-bar ${i<=step?'on':''}`}/>)}
        </div>
        <div className="tut-nav">
          <button className="btn bo bsm" onClick={onSkip}>Überspringen</button>
          {s.action && (
            <button className="btn bp bsm" onClick={isLast ? onSkip : onNext}>{s.action}</button>
          )}
          {s.waitFor && !s.action && (
            <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--dim)',textAlign:'right'}}>
              {s.target ? '↑ Das markierte Element antippen' : 'Mit der App interagieren'}
            </span>
          )}
        </div>
      </div>
    </>
  );
}

/* ════════════════════════════════════════
   HOME SCREEN
════════════════════════════════════════ */
function Home({go, tutStep, isTut, onTutEvent, setShowTut}) {
  const [routes, setRoutes] = useState(DB.get());
  const [showNew,  setShowNew]  = useState(false);
  const [showMenu, setShowMenu] = useState(false);
  const [showGH,   setShowGH]   = useState(false);
  const [form, setForm] = useState({name:'Demo: Nordstadt–Südhafen',desc:'',start:'0',end:'20'});
  const fv = (k,v) => setForm(p=>({...p,[k]:v}));
  const rf = () => setRoutes(DB.get());

  const openNew = () => {
    setShowNew(true);
    if (isTut) onTutEvent('new-modal');
  };
  const doCreate = () => {
    if (!form.name.trim()) return;
    const r = {id:Date.now(),version:SCHEMA,name:form.name.trim(),desc:form.desc.trim(),
      startKm:parseFloat(form.start)||0,endKm:parseFloat(form.end)||20,objects:[],timetables:[]};
    DB.save(r); rf(); setShowNew(false);
    setForm({name:'Demo: Nordstadt–Südhafen',desc:'',start:'0',end:'20'});
    if (isTut) onTutEvent('route-created');
  };
  const doDelete = id => { if(!confirm('Strecke löschen?'))return; DB.set(DB.get().filter(r=>r.id!==id)); rf(); };
  const doExport = r => {
    const a = document.createElement('a');
    a.href = 'data:application/json,' + encodeURIComponent(JSON.stringify(r,null,2));
    a.download = r.name.replace(/\s+/g,'-') + '.json'; a.click();
  };
  const doImportFile = e => {
    const f = e.target.files[0]; if(!f)return;
    const rd = new FileReader();
    rd.onload = ev => { try { const r=JSON.parse(ev.target.result); r.id=Date.now(); DB.save(DB.migrate?DB.migrate(r):r); rf(); } catch { alert('Ungültige Datei'); } };
    rd.readAsText(f);
  };
  const doImportGH = r => { DB.save(DB.get().includes(r)?r:{...r,id:Date.now()}); rf(); setShowGH(false); };

  const hasDemoRoute = routes.some(r=>r.id===DEMO_ROUTE.id);
  const addDemo = () => { DB.save({...DEMO_ROUTE,id:Date.now()}); rf(); };

  return (
    <div className="page">
      <div className="bar">
        <span className="brand">CCMN™ EBULA</span>
        <button className="ic" style={{fontSize:16}} onClick={()=>setShowMenu(m=>!m)}>☰</button>
      </div>

      {showMenu && (
        <div style={{background:'var(--s2)',borderBottom:'1px solid var(--b1)',padding:'8px 12px',display:'flex',gap:7,flexWrap:'wrap'}}>
          <label className="btn bo bsm" style={{cursor:'pointer'}}>
            Import Datei <input type="file" accept=".json" style={{display:'none'}} onChange={doImportFile}/>
          </label>
          <button className="btn bo bsm" onClick={()=>{setShowGH(true);setShowMenu(false);}}>GitHub ({GH_REPO.split('/')[1]})</button>
          <button className="btn bo bsm" onClick={addDemo} disabled={hasDemoRoute}>Demo-Strecke</button>
          <button className="btn bo bsm" onClick={()=>{DB.resetTut();setShowTut(true);setShowMenu(false);}}>Tutorial starten</button>
        </div>
      )}

      <div className="scroll" style={{paddingBottom:8}}>
        {routes.length===0 ? (
          <div className="empty">
            <div style={{fontSize:13,fontWeight:600}}>Keine Strecken vorhanden</div>
            <div style={{fontSize:11}}>+ tippen um eine neue anzulegen</div>
            <button className="btn bp bsm" style={{marginTop:8}} onClick={addDemo}>Demo-Strecke laden</button>
          </div>
        ) : routes.map((r,i) => (
          <div className="rcard" key={r.id} id={i===0?'first-card':undefined}>
            <div className="rcard-h">
              <div className="rcard-n">{r.name}</div>
              {r.desc && <div style={{fontSize:11,color:'var(--dim)',marginTop:1}}>{r.desc}</div>}
              <div className="rcard-m">
                km {r.startKm.toFixed(1)}–{r.endKm.toFixed(1)} · {(r.objects||[]).length} Obj. ·{' '}
                {(r.objects||[]).filter(o=>o.type==='STATION').length} Bf. ·{' '}
                {(r.timetables||[]).length} Fahrplan{(r.timetables||[]).length!==1?'pläne':'plan'}
              </div>
            </div>
            <div className="rcard-a">
              <button className="btn bo bsm" id={i===0?'first-editor-btn':undefined}
                onClick={()=>{go('editor',r.id);if(isTut)onTutEvent('screen-editor');}}>Editor</button>
              <button className="btn bo bsm" id={i===0?'first-tt-btn':undefined}
                onClick={()=>{go('timetables',r.id);if(isTut)onTutEvent('screen-timetables');}}>Fahrpläne</button>
              <button className="btn bp bsm" id={i===0?'first-start-btn':undefined}
                onClick={()=>{go('start',r.id);if(isTut)onTutEvent('screen-start');}}>Fahrt starten</button>
              <button className="btn bo bsm" style={{marginLeft:'auto'}} onClick={()=>doExport(r)}>Export</button>
              <button className="btn bx bsm" onClick={()=>doDelete(r.id)}>✕</button>
            </div>
          </div>
        ))}
      </div>

      <Footer/>
      <button className="fab" id="fab-btn" onClick={openNew}>+</button>

      {showNew && (
        <div className="ov" onClick={e=>e.target===e.currentTarget&&setShowNew(false)}>
          <div className="sheet" id="new-sheet">
            <div className="sheet-h">Neue Strecke</div>
            <F label="Name"><input className="inp" value={form.name} onChange={e=>fv('name',e.target.value)} placeholder="München – Augsburg"/></F>
            <F label="Beschreibung"><input className="inp" value={form.desc} onChange={e=>fv('desc',e.target.value)}/></F>
            <div className="irow">
              <F label="Start-km"><input className="inp" type="number" value={form.start} onChange={e=>fv('start',e.target.value)}/></F>
              <F label="End-km"><input className="inp" type="number" value={form.end} onChange={e=>fv('end',e.target.value)}/></F>
            </div>
            <div className="sheet-f">
              <button className="btn bo" onClick={()=>setShowNew(false)}>Abbrechen</button>
              <button className="btn bp" id="create-btn" onClick={doCreate}>Erstellen</button>
            </div>
          </div>
        </div>
      )}
      {showGH && <GitHubBrowser onImport={doImportGH} onClose={()=>setShowGH(false)}/>}
    </div>
  );
}

/* ════════════════════════════════════════
   EDITOR
════════════════════════════════════════ */
function Editor({routeId, go, isTut, onTutEvent}) {
  const [route, setRoute] = useState(null);
  const [showAdd, setShowAdd] = useState(false);
  const [editing, setEditing] = useState(null);
  const blank = {km:'0',type:'STATION',name:'',speed:'',speedEnd:'',gradient:'',notes:''};
  const [form, setForm] = useState(blank);
  const fv = (k,v) => setForm(p=>({...p,[k]:v}));

  useEffect(()=>{setRoute(DB.get().find(r=>r.id===routeId)||null);},[routeId]);

  const saveObjs = objs => {
    const r = {...route, objects:objs};
    DB.save(r); setRoute(r);
  };
  const saveObj = () => {
    const km = parseFloat(form.km.replace(',','.'));
    if(isNaN(km)) return;
    const obj = {id:editing?.id||Date.now().toString(),km,type:form.type,name:form.name,
      speed:parseInt(form.speed)||null, speedEnd:parseFloat(form.speedEnd)||null,
      gradient:parseFloat(form.gradient.replace(',','.'))||null, notes:form.notes};
    const objs = route.objects||[];
    saveObjs((editing ? objs.map(o=>o.id===editing.id?obj:o) : [...objs,obj]).sort((a,b)=>a.km-b.km));
    setShowAdd(false);
  };
  const openEdit = obj => {
    setEditing(obj); setShowAdd(true);
    setForm({km:String(obj.km),type:obj.type,name:obj.name||'',speed:String(obj.speed||''),
      speedEnd:String(obj.speedEnd||''),gradient:String(obj.gradient??''),notes:obj.notes||''});
  };
  if (!route) return null;
  const needSpeed = ['SPEED','LA'].includes(form.type);

  return (
    <div className="page">
      <div className="bar">
        <button className="ic" id="back-btn" onClick={()=>{go('home');if(isTut)onTutEvent('screen-home');}}>←</button>
        <span style={{flex:1,fontWeight:600,fontSize:13}}>{route.name}</span>
        <span className="topbar-lbl">Editor</span>
      </div>
      <div className="scroll" style={{paddingBottom:8}}>
        {(route.objects||[]).length===0
          ? <div className="empty"><div style={{fontSize:12}}>Noch keine Objekte — + drücken</div></div>
          : (route.objects||[]).map(obj=>{
              const t=TYPES[obj.type]||TYPES.STATION;
              const det=[];
              if(obj.speed!=null)det.push(obj.speed+' km/h');
              if(obj.speedEnd)det.push('bis km '+obj.speedEnd);
              if(obj.gradient!=null&&obj.gradient!==0)det.push((obj.gradient>0?'↗':'↘')+Math.abs(obj.gradient)+'‰');
              if(obj.notes)det.push(obj.notes);
              return (
                <div key={obj.id} style={{display:'flex',alignItems:'center',gap:8,padding:'8px 0',borderBottom:'1px solid var(--b1)'}}>
                  <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--dim)',width:50,flexShrink:0}}>{obj.km.toFixed(3)}</span>
                  <span className="tag" style={{background:t.bg,color:t.clr}}>{t.s}</span>
                  <div style={{flex:1}}>
                    <div style={{fontSize:13,fontWeight:500}}>{obj.name||t.l}</div>
                    {det.length>0&&<div style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--dim)'}}>{det.join(' · ')}</div>}
                  </div>
                  <button className="ic" style={{fontSize:12}} onClick={()=>openEdit(obj)}>✎</button>
                  <button className="ic" style={{fontSize:12}} onClick={()=>saveObjs((route.objects||[]).filter(o=>o.id!==obj.id))}>✕</button>
                </div>
              );
            })
        }
      </div>
      <Footer/>
      <button className="fab" id="fab-btn" onClick={()=>{setEditing(null);setForm(blank);setShowAdd(true);}}>+</button>

      {showAdd && (
        <Modal title={editing?'Bearbeiten':'Objekt hinzufügen'} onClose={()=>setShowAdd(false)} onOk={saveObj}>
          <div className="irow">
            <F label="km-Position"><input className="inp" value={form.km} onChange={e=>fv('km',e.target.value)} inputMode="decimal" placeholder="0.000"/></F>
            <F label="Typ"><select className="inp" value={form.type} onChange={e=>fv('type',e.target.value)}>
              {Object.entries(TYPES).map(([k,v])=><option key={k} value={k}>{v.l}</option>)}
            </select></F>
          </div>
          <F label="Name / Bezeichnung"><input className="inp" value={form.name} onChange={e=>fv('name',e.target.value)} placeholder={form.type==='STATION'?'München Hbf':'Bezeichnung'}/></F>
          {needSpeed && <>
            <F label="Geschwindigkeit km/h"><input className="inp" type="number" value={form.speed} onChange={e=>fv('speed',e.target.value)}/></F>
            {form.type==='LA' && <F label="La-Ende km"><input className="inp" value={form.speedEnd} onChange={e=>fv('speedEnd',e.target.value)} inputMode="decimal"/></F>}
          </>}
          {form.type==='GRADE' && <F label="Neigung ‰ (− = Gefälle)"><input className="inp" value={form.gradient} onChange={e=>fv('gradient',e.target.value)} inputMode="decimal"/></F>}
          <F label="Notizen"><input className="inp" value={form.notes} onChange={e=>fv('notes',e.target.value)}/></F>
        </Modal>
      )}
    </div>
  );
}

/* ════════════════════════════════════════
   FAHRPLAN-LISTE (Timetable Manager)
════════════════════════════════════════ */
function TimetableManager({routeId, go, isTut, onTutEvent}) {
  const [route, setRoute] = useState(null);
  const [showEditor, setShowEditor] = useState(false);
  const [editTT, setEditTT] = useState(null);

  useEffect(()=>{setRoute(DB.get().find(r=>r.id===routeId)||null);},[routeId]);
  if (!route) return null;

  const refresh = () => setRoute(DB.get().find(r=>r.id===routeId));
  const saveTT = tt => {
    const tts = route.timetables||[];
    const upd = tts.find(t=>t.id===tt.id) ? tts.map(t=>t.id===tt.id?tt:t) : [...tts,tt];
    DB.save({...route,timetables:upd}); refresh(); setShowEditor(false);
  };
  const delTT = id => { DB.save({...route,timetables:(route.timetables||[]).filter(t=>t.id!==id)}); refresh(); };
  const startDrive = tt => {
    go('drive', routeId, {
      trip:{id:Date.now(),mode:tt.mode,departure:tt.departure,avgSpeed:tt.avgSpeed,offset:0,startKm:route.startKm},
      timetable:tt.stops, route
    });
    if(isTut) onTutEvent('screen-drive');
  };

  return (
    <div className="page">
      <div className="bar">
        <button className="ic" id="back-btn" onClick={()=>{go('home');if(isTut)onTutEvent('screen-home');}}>←</button>
        <span style={{flex:1,fontWeight:600,fontSize:13}}>{route.name}</span>
        <span className="topbar-lbl">Fahrpläne</span>
      </div>
      <div className="scroll" style={{paddingBottom:8}}>
        {(route.timetables||[]).length===0
          ? <div className="empty"><div style={{fontSize:12}}>Noch keine Fahrpläne — Neu drücken</div></div>
          : (route.timetables||[]).map(tt => (
            <div className="rcard" key={tt.id}>
              <div className="rcard-h">
                <div className="rcard-n">{tt.name}</div>
                <div className="rcard-m">
                  {tt.mode==='TIME'?'Zeitbasiert':'Ø '+tt.avgSpeed+' km/h'} · ab {tt.departure||'–'} ·{' '}
                  {(tt.stops||[]).filter(s=>s.served).length} Halte
                </div>
              </div>
              <div className="rcard-a">
                <button className="btn bp bsm" onClick={()=>startDrive(tt)}>▶ Fahrt</button>
                <button className="btn bo bsm" onClick={()=>{setEditTT(tt);setShowEditor(true);}}>Bearbeiten</button>
                <button className="btn bx bsm" style={{marginLeft:'auto'}} onClick={()=>delTT(tt.id)}>✕</button>
              </div>
            </div>
          ))}
        <div style={{marginTop:8}}>
          <button className="btn bp" onClick={()=>{setEditTT(null);setShowEditor(true);}}>+ Neuer Fahrplan</button>
        </div>
      </div>
      <Footer/>
      {showEditor && (
        <TimetableEditorModal route={route} existing={editTT} onSave={saveTT} onClose={()=>setShowEditor(false)}/>
      )}
    </div>
  );
}

/* ════════════════════════════════════════
   FAHRT STARTEN (Tabs: Fahrpläne | Neu)
════════════════════════════════════════ */
function StartDialog({routeId, go, isTut, onTutEvent}) {
  const route = DB.get().find(r=>r.id===routeId);
  const stations = (route?.objects||[]).filter(o=>o.type==='STATION');
  const [tab, setTab] = useState((route?.timetables||[]).length>0 ? 'saved' : 'new');
  const [selTT, setSelTT] = useState((route?.timetables||[])[0]?.id||null);
  const [mode, setMode]   = useState('TIME');
  const [dep,  setDep]    = useState('');
  const [avg,  setAvg]    = useState('100');
  const [stops, setStops] = useState(()=>stations.map(s=>({sid:s.id,km:s.km,name:s.name||'',served:true,arr:'',dep:''})));
  const setStop = (sid,f,v) => setStops(ss=>ss.map(s=>s.sid===sid?{...s,[f]:v}:s));

  if (!route) return null;
  const savedTTs = route.timetables||[];

  const startSaved = () => {
    const tt = savedTTs.find(t=>t.id===selTT);
    if (!tt) return;
    go('drive',routeId,{
      trip:{id:Date.now(),mode:tt.mode,departure:tt.departure,avgSpeed:tt.avgSpeed,offset:0,startKm:route.startKm},
      timetable:tt.stops, route
    });
    if(isTut)onTutEvent('screen-drive');
  };
  const startNew = () => {
    go('drive',routeId,{
      trip:{id:Date.now(),mode,departure:dep,avgSpeed:parseFloat(avg)||100,offset:0,startKm:route.startKm},
      timetable:stops, route
    });
    if(isTut)onTutEvent('screen-drive');
  };

  return (
    <div className="page">
      <div className="bar">
        <button className="ic" onClick={()=>go('home')}>←</button>
        <span style={{flex:1,fontWeight:600,fontSize:13}}>{route.name}</span>
        <span className="topbar-lbl">Fahrt starten</span>
      </div>
      <div className="scroll" style={{paddingBottom:80}}>
        <div className="tabs">
          {savedTTs.length>0&&<div className={`tab ${tab==='saved'?'on':''}`} onClick={()=>setTab('saved')}>Fahrpläne ({savedTTs.length})</div>}
          <div className={`tab ${tab==='new'?'on':''}`} onClick={()=>setTab('new')}>Neu</div>
        </div>

        {tab==='saved' && (
          <div>
            {savedTTs.map(tt=>(
              <label key={tt.id} className="chk" style={{marginBottom:10,padding:'10px',background:selTT===tt.id?'var(--s3)':'var(--s1)',border:'1px solid '+(selTT===tt.id?'var(--pri2)':'var(--b1)'),borderRadius:4}}>
                <input type="radio" checked={selTT===tt.id} onChange={()=>setSelTT(tt.id)} style={{accentColor:'var(--pri)',flexShrink:0}}/>
                <div>
                  <div style={{fontWeight:600,fontSize:13}}>{tt.name}</div>
                  <div style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--dim)'}}>
                    ab {tt.departure||'–'} · {(tt.stops||[]).filter(s=>s.served).length} Halte
                  </div>
                </div>
              </label>
            ))}
          </div>
        )}

        {tab==='new' && (
          <div>
            <div className="irow">
              <F label="Abfahrtszeit"><input className="inp" value={dep} onChange={e=>setDep(e.target.value)} placeholder="HH:MM"/></F>
              <F label="Berechnung"><select className="inp" value={mode} onChange={e=>setMode(e.target.value)}>
                <option value="TIME">Zeitbasiert</option>
                <option value="SPEED">Ø-Geschwindigkeit</option>
              </select></F>
            </div>
            {mode==='SPEED'&&<F label="Ø km/h"><input className="inp" type="number" value={avg} onChange={e=>setAvg(e.target.value)}/></F>}
            {stops.map((s,i)=>(
              <div key={s.sid} style={{marginBottom:11,paddingBottom:11,borderBottom:i<stops.length-1?'1px solid var(--b1)':'none'}}>
                <label className="chk">
                  <input type="checkbox" checked={!!s.served} onChange={e=>setStop(s.sid,'served',e.target.checked)}/>
                  <span style={{fontWeight:600}}>{s.name}</span>
                  <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--faint)'}}>km {s.km.toFixed(3)}</span>
                </label>
                {s.served&&mode==='TIME'&&<div className="irow" style={{marginTop:6,paddingLeft:21}}>
                  <F label="Ankunft"><input className="inp" value={s.arr} onChange={e=>setStop(s.sid,'arr',e.target.value)} placeholder="HH:MM"/></F>
                  <F label="Abfahrt"><input className="inp" value={s.dep} onChange={e=>setStop(s.sid,'dep',e.target.value)} placeholder="HH:MM"/></F>
                </div>}
              </div>
            ))}
          </div>
        )}
      </div>

      <div style={{position:'fixed',bottom:0,left:0,right:0,padding:'10px 13px',background:'var(--s1)',borderTop:'1px solid var(--b1)'}}>
        <button className="btn bp" id="go-btn" style={{width:'100%',height:40,fontSize:14,letterSpacing:.8}}
          onClick={tab==='saved'?startSaved:startNew}>
          ▶  FAHRT BEGINNEN
        </button>
      </div>
    </div>
  );
}

/* ════════════════════════════════════════
   BUCHFAHRPLAN-ANSICHT
   Authentisches Layout wie echte EBuLa:
   [V 56px][Gleis 22px][km 48px][Name flex][An 54px][Ab 54px]
════════════════════════════════════════ */
function DriveView({routeId, tripData, go, tutAnimPct}) {
  const {route, timetable, trip:initTrip} = tripData;
  const [trip,  setTrip]  = useState(initTrip);
  const timeSec = useRef(toS(initTrip.departure)||0);
  const [timeStr,setTimeStr] = useState(initTrip.departure||'00:00');
  const [running, setRunning] = useState(false);
  const [autoScroll, setAutoScroll] = useState(true);
  const [showOff, setShowOff] = useState(false);
  const tickRef   = useRef(null);
  const scrollRef = useRef(null);

  // 1:1 Echtzeit-Timer — 1 real second = 1 ingame second
  useEffect(()=>{
    clearInterval(tickRef.current);
    if (running) {
      tickRef.current = setInterval(()=>{
        timeSec.current += 1;
        setTimeStr(fmtS(timeSec.current));
      }, 1000);
    }
    return ()=>clearInterval(tickRef.current);
  },[running]);

  // Alle Objekte + Timetable-Daten zusammenführen
  const items = useMemo(()=>{
    const objs = [...(route.objects||[])];
    (timetable||[]).forEach(s=>{
      const idx=objs.findIndex(o=>o.id===s.sid||o.id===s.id||o.km===s.km);
      if(idx>=0)objs[idx]={...objs[idx],ttArr:s.arr,ttDep:s.dep,ttServed:s.served};
    });
    return objs.sort((a,b)=>a.km-b.km);
  },[route,timetable]);

  const served = (timetable||[]).filter(s=>s.served);
  // Tutorial-Animation: direkte km-Vorgabe, sonst normal
  const curKm = tutAnimPct !== undefined
    ? route.startKm + (route.endKm-route.startKm)*tutAnimPct
    : calcKm(timeStr, trip, served);

  const prog = Math.max(0,Math.min(1,(curKm-route.startKm)/(route.endKm-route.startKm)));
  const nextStop = served.filter(s=>s.km>curKm).sort((a,b)=>a.km-b.km)[0];
  const prevStop = served.filter(s=>s.km<=curKm).sort((a,b)=>b.km-a.km)[0];

  // Auto-scroll
  useEffect(()=>{
    if(!autoScroll||!scrollRef.current)return;
    let top=0;
    for(const it of items){
      if(it.km>curKm)break;
      top += it.type==='STATION'?STA_H:ROW_H;
    }
    scrollRef.current.scrollTo({top:top-scrollRef.current.clientHeight*.4,behavior:'smooth'});
  },[curKm,autoScroll]);

  const adjOff = d => setTrip(t=>({...t,offset:(t.offset||0)+d}));
  const manTime = v => { setRunning(false); timeSec.current=toS(v)||0; setTimeStr(v); };

  // Geschwindigkeits-Klammern vorberechnen
  const vSegs = useMemo(()=>calcVSegs(items),[items]);

  // Höhe bis zu einem Item
  const itemTop = idx => {
    let t=0;
    for(let i=0;i<idx;i++) t+=items[i].type==='STATION'?STA_H:ROW_H;
    return t;
  };

  return (
    <div className="drive">
      {/* ── HUD ── */}
      <div className="hud" id="drive-hud">
        <div className="hcell" style={{paddingLeft:10}}>
          <button className="ic" style={{width:24,height:20,fontSize:11,marginBottom:4}}
            onClick={()=>{clearInterval(tickRef.current);go('home');}}>←</button>
          <div className="hlbl">KM</div>
          <div className="hval">{curKm.toFixed(1)}</div>
        </div>
        <div className="hcenter">
          {prevStop&&<div className="hprev">↑ {prevStop.name||prevStop.stationName}</div>}
          {nextStop
            ?<><div className="hnext">→ {nextStop.name||nextStop.stationName}</div>
               <div className="hnextd">
                 {nextStop.ttArr&&'an '+nextStop.ttArr}
                 {nextStop.ttArr&&nextStop.ttDep&&'  '}
                 {nextStop.ttDep&&'ab '+nextStop.ttDep}
                 {'  ·  '}{Math.max(0,nextStop.km-curKm).toFixed(1)} km
               </div></>
            :<div style={{fontSize:11,color:'var(--faint)',fontFamily:'var(--mono)'}}>Kein weiterer Halt</div>}
        </div>
        <div className="htcell">
          <div className="hlbl" style={{textAlign:'right'}}>INGAME-ZEIT</div>
          <input className="htime" value={timeStr} onChange={e=>manTime(e.target.value)}/>
          <div style={{display:'flex',gap:4}}>
            <button className="ic" style={{width:26,height:22,fontSize:11,color:autoScroll?'var(--grn2)':'var(--faint)'}}
              onClick={()=>setAutoScroll(a=>!a)} title="Auto-Scroll">⊙</button>
            <button className="ic" style={{width:26,height:22,fontSize:11,color:showOff?'var(--acc)':'var(--faint)'}}
              onClick={()=>setShowOff(s=>!s)}>⚙</button>
          </div>
        </div>
      </div>

      <div className="prog"><div className="progf" style={{width:prog*100+'%'}}/></div>

      {/* ── BUCHFAHRPLAN STREIFEN ── */}
      <div className="bfp" ref={scrollRef} id="bfp-strip">
        {/* Kopfzeile */}
        <div className="bfp-head">
          <div className="bfp-hcell" style={{textAlign:'right',paddingRight:4}}>V</div>
          <div className="bfp-hcell"/>
          <div className="bfp-hcell" style={{textAlign:'right',paddingRight:4}}>km</div>
          <div className="bfp-hcell">Bezeichnung</div>
          <div className="bfp-hcell" style={{textAlign:'center'}}>an</div>
          <div className="bfp-hcell" style={{textAlign:'center',borderRight:'none'}}>ab</div>
        </div>

        {/* Gesamtcontainer für V-Klammern (position:relative) */}
        <div style={{position:'relative'}}>
          {/* Geschwindigkeits-Klammern als absolute Elemente */}
          {vSegs.map((seg,si)=>(
            <div key={si} style={{
              position:'absolute', top:seg.top, height:seg.height,
              left:0, width:56, pointerEvents:'none', overflow:'hidden'
            }}>
              {/* Vertikale Linie */}
              <div style={{
                position:'absolute',top:0,bottom:0,right:10,width:1,
                background:seg.color,opacity:.5
              }}/>
              {/* Horizontale Einzugslinie oben */}
              <div style={{
                position:'absolute',top:0,right:10,height:1,width:10,
                background:seg.color,opacity:.7
              }}/>
              {/* Geschwindigkeitszahl */}
              <div style={{
                position:'absolute',top:2,right:12,
                fontFamily:'var(--mono)',fontWeight:600,fontSize:11,
                color:seg.color,textAlign:'right',lineHeight:1
              }}>{seg.speed}</div>
            </div>
          ))}

          {/* Zeilen */}
          {items.map((item,i)=>{
            const isSta = item.type==='STATION';
            const isL   = ['SPEED','LA','BUE'].includes(item.type);
            const isR   = ['SIGNAL','TU_S','TU_E','GRADE'].includes(item.type);
            const tp    = TYPES[item.type]||TYPES.STATION;
            const h     = isSta ? STA_H : ROW_H;
            const passed= item.km < curKm - 0.1;
            const isCur = !isSta && Math.abs(item.km - curKm) < 0.25;
            const isCurSta = isSta && Math.abs(item.km - curKm) < 0.4;
            const servedSta = isSta && item.ttServed;
            const hasTimes = servedSta && (item.ttArr||item.ttDep);

            return (
              <div key={item.id||i} className={`bfp-row ${isSta?'sta':''} ${(isCur||isCurSta)?'cur':''}`}
                style={{height:h}}>
                {/* V-Spalte — Inhalt kommt von absoluten Klammern, hier nur Border */}
                <div className="col-v" style={{height:h}}>
                  {/* BÜ-Zusatz */}
                  {item.type==='BUE'&&<span style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--red)',position:'absolute',right:14,top:'50%',transform:'translateY(-50%)'}}>BÜ</span>}
                </div>

                {/* Gleis-Spalte */}
                <div className="col-tr" style={{height:h}}>
                  {/* Gleislinie */}
                  <div className="gleislinie" style={{background:passed?'var(--b1)':isCur||isCurSta?'var(--grn2)':'var(--b3)'}}/>
                  {/* Bahnhof-Symbol */}
                  {isSta&&<div className="bfsym" style={{
                    width:servedSta?13:8,height:servedSta?13:8,
                    background:servedSta?(passed?'var(--dim)':'var(--text)'):'var(--b2)'
                  }}/>}
                  {/* V/La Querstrich */}
                  {(item.type==='SPEED')&&<div className="vtick" style={{background:'var(--yel)',opacity:.8}}/>}
                  {(item.type==='LA')&&<div className="vtick" style={{background:'var(--red)',opacity:.8}}/>}
                  {/* BÜ */}
                  {item.type==='BUE'&&<div className="buetick" style={{background:'var(--red)',opacity:.6}}/>}
                  {/* Tunnel-Caps */}
                  {item.type==='TU_S'&&<div className="tu-cap" style={{top:2,color:'var(--b3)'}}>⊢</div>}
                  {item.type==='TU_E'&&<div className="tu-cap" style={{bottom:2,color:'var(--b3)'}}>⊣</div>}
                  {/* Positions-Raute */}
                  {(isCur||isCurSta)&&<>
                    <div className="pdiam"/>
                    <div className="parm" style={{right:'calc(50% + 6px)',width:56}}/>
                    <div className="parm" style={{left:'calc(50% + 6px)',width:96}}/>
                  </>}
                </div>

                {/* km-Spalte */}
                <div className="col-km" style={{height:h}}>
                  <span className={`kmval ${(isCur||isCurSta)?'act':''}`}>
                    {item.km%1===0?item.km.toFixed(1):item.km.toFixed(1)}
                  </span>
                </div>

                {/* Name-Spalte */}
                <div className="col-name" style={{height:h}}>
                  {isSta ? (
                    <div className="bfname" style={{color:passed?'var(--dim)':'var(--text)',fontSize:servedSta?11:10}}>
                      {item.name||'Bahnhof'}
                      {!servedSta&&<span style={{fontWeight:400,color:'var(--faint)',marginLeft:4,fontSize:9}}>(Durchfahrt)</span>}
                    </div>
                  ) : isR ? (
                    <div className="bfsig">
                      {item.type==='SIGNAL'&&(item.name||'Signal')}
                      {item.type==='TU_S'&&`⊢ ${item.name||'Tunnel'}`}
                      {item.type==='TU_E'&&`${item.name||'Tunnel'} ⊣`}
                      {item.type==='GRADE'&&item.gradient!=null&&`${item.gradient>0?'↗':'↘'} ${Math.abs(item.gradient)}‰${item.name?' '+item.name:''}`}
                    </div>
                  ) : item.notes ? (
                    <div className="bfsig">{item.notes}</div>
                  ) : null}
                </div>

                {/* Ankunft */}
                <div className="col-an" style={{height:h,borderLeft:'1px solid var(--b1)'}}>
                  {hasTimes&&item.ttArr&&<span className="bftime">{item.ttArr}</span>}
                </div>
                {/* Abfahrt */}
                <div className="col-ab" style={{height:h,borderLeft:'1px solid var(--b1)'}}>
                  {hasTimes&&item.ttDep&&<span className="bftime">{item.ttDep}</span>}
                </div>
              </div>
            );
          })}
          {/* Streckenende */}
          <div style={{height:80,display:'flex',alignItems:'flex-start',paddingTop:12,paddingLeft:84}}>
            <span style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--faint)',letterSpacing:2}}>══ STRECKENENDE km {route.endKm} ══</span>
          </div>
        </div>
      </div>

      {/* ── FUSSZEILE ── */}
      <div className="dfoot" id="dfoot">
        <button className={`btn bsm ${running?'bx':'bp'}`} style={{letterSpacing:.5}}
          onClick={()=>setRunning(r=>!r)}>
          {running?'⏹ STOP':'▶ START'}
        </button>
        {showOff&&(
          <div className="offwrap">
            <span style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--faint)'}}>km±</span>
            <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--acc)',minWidth:30,textAlign:'center'}}>
              {(trip.offset||0)>=0?'+':''}{(trip.offset||0).toFixed(1)}
            </span>
            {[-1,-.1,.1,1].map(d=><button key={d} className="ob" onClick={()=>adjOff(d)}>{d>0?'+':''}{d}</button>)}
            <button className="ob" onClick={()=>setTrip(t=>({...t,offset:0}))}>↺</button>
          </div>
        )}
        <span style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--faint)',marginLeft:'auto'}}>
          {route.name} · {Math.max(0,route.endKm-curKm).toFixed(1)} km
        </span>
      </div>
    </div>
  );
}

/* ════════════════════════════════════════
   APP ROOT — Screen- & Tutorial-Manager
════════════════════════════════════════ */
function App() {
  const [screen,   setScreen]   = useState('home');
  const [routeId,  setRouteId]  = useState(null);
  const [tripData, setTripData] = useState(null);
  const [tutStep,  setTutStep]  = useState(0);
  const [tutActive,setTutActive]= useState(!DB.tutDone());
  const [tutAnimPct, setTutAnimPct] = useState(undefined);
  const animRef = useRef(null);

  const go = useCallback((s, rid, extra) => {
    setScreen(s);
    if (rid  !== undefined) setRouteId(rid);
    if (extra!== undefined) setTripData(extra);
  }, []);

  // Tutorial-Events aus Subscreens
  const onTutEvent = useCallback((event) => {
    if (event === 'restart') { setTutStep(0); setTutActive(true); setScreen('home'); return; }
    setTutStep(prev => {
      const s = TUT_STEPS[prev];
      if (s && s.waitFor === event) {
        const next = prev + 1;
        if (next >= TUT_STEPS.length) { DB.markTut(); setTutActive(false); return prev; }
        // Tutorial-Schritt 12 = drive → Animations-Demo starten
        if (TUT_STEPS[next]?.id === 'demo-run') {
          startDemoAnim();
        }
        return next;
      }
      return prev;
    });
  }, []);

  const tutNext = () => {
    const next = tutStep + 1;
    if (next >= TUT_STEPS.length) { DB.markTut(); setTutActive(false); setTutAnimPct(undefined); clearInterval(animRef.current); return; }
    setTutStep(next);
    if (TUT_STEPS[next]?.id === 'demo-run') startDemoAnim();
  };
  const tutSkip = () => { DB.markTut(); setTutActive(false); setTutAnimPct(undefined); clearInterval(animRef.current); };

  // Demo-Animation: bewegt Position von 0→1 über 8 Sekunden
  const startDemoAnim = () => {
    clearInterval(animRef.current);
    let pct = 0;
    setTutAnimPct(0);
    animRef.current = setInterval(() => {
      pct += 1/80; // 8s × 100ms
      setTutAnimPct(Math.min(pct, 0.99));
      if (pct >= 1) clearInterval(animRef.current);
    }, 100);
  };

  // Demo-Route für Tutorial
  const getDemoTripData = () => ({
    trip: { id:'tut', mode:'TIME', departure:'10:00', avgSpeed:100, offset:0, startKm:0 },
    timetable: DEMO_ROUTE.timetables[0].stops,
    route: DEMO_ROUTE
  });

  // Wenn Tutorial zu screen-drive führt → Demo-Route laden
  useEffect(() => {
    const s = TUT_STEPS[tutStep];
    if (tutActive && s?.id === 'ebula-layout' && screen !== 'drive') {
      go('drive', DEMO_ROUTE.id, getDemoTripData());
    }
  }, [tutStep, tutActive]);

  const isTut = tutActive;

  if (screen === 'drive' && tripData) {
    return <>
      <DriveView routeId={routeId} tripData={tripData}
        go={(s,r,e)=>{setTutAnimPct(undefined);clearInterval(animRef.current);go(s,r,e);}}
        tutAnimPct={isTut && TUT_STEPS[tutStep]?.id==='demo-run' ? tutAnimPct : undefined}/>
      {tutActive && <Tutorial step={tutStep} onNext={tutNext} onSkip={tutSkip}/>}
    </>;
  }

  return (
    <div className="app">
      {screen==='home'       && <Home go={go} tutStep={tutStep} isTut={isTut} onTutEvent={onTutEvent} setShowTut={v=>{if(v){setTutStep(0);setTutActive(true);}}}/>}
      {screen==='editor'     && <Editor routeId={routeId} go={go} isTut={isTut} onTutEvent={onTutEvent}/>}
      {screen==='timetables' && <TimetableManager routeId={routeId} go={go} isTut={isTut} onTutEvent={onTutEvent}/>}
      {screen==='start'      && <StartDialog routeId={routeId} go={go} isTut={isTut} onTutEvent={onTutEvent}/>}
      {tutActive && <Tutorial step={tutStep} onNext={tutNext} onSkip={tutSkip}/>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
