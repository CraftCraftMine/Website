<!--
  Project:     CCMC™ Web EBuLa
  Part of:     CraftCraftMine Netzwerk™ (CCMN™)
  Copyright:   (c) 2026 CraftCraftMine Netzwerk™ – All rights reserved.
  Description: Privates Hobby-Projekt für Train Sim World Simulationen.
               Nicht für kommerzielle Zwecke bestimmt.
  Support:     support@craftcraftmine.net
  Info:        https://craftcraftmine.net/ueberuns
-->
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>CCMC™ Web EBuLa</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<script src="shared/types.js"></script>
<script src="shared/db.js"></script>
<script src="shared/calc.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
:root{
  --bg:#09090d;--s1:#111116;--s2:#16161d;--s3:#1d1d26;
  --b1:#252532;--b2:#303040;
  --text:#c4c4d6;--dim:#686880;--faint:#30303f;
  --pri:#3a7ec4;--pri2:#1e4f88;--red:#b03030;
  --mono:'IBM Plex Mono',monospace;--sans:'IBM Plex Sans',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body,#root{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);}
::-webkit-scrollbar{width:3px;} ::-webkit-scrollbar-thumb{background:var(--b2);}
.page{display:flex;flex-direction:column;height:100dvh;}
.bar{display:flex;align-items:center;gap:9px;padding:0 13px;height:44px;background:var(--s1);border-bottom:1px solid var(--b1);flex-shrink:0;}
.brand{font-family:var(--mono);font-size:11px;letter-spacing:3px;color:var(--pri);flex:1;}
.scroll{flex:1;overflow-y:auto;padding:12px 12px 80px;}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:0 12px;height:30px;border-radius:3px;border:none;cursor:pointer;font-family:var(--sans);font-size:12px;font-weight:500;white-space:nowrap;}
.bp{background:var(--pri2);color:#b8d4f0;border:1px solid #3a7ec440;} .bp:hover{background:var(--pri);color:#fff;}
.bo{background:transparent;color:var(--dim);border:1px solid var(--b2);} .bo:hover{background:var(--s3);color:var(--text);}
.bx{background:transparent;color:var(--red);border:1px solid #b0303028;} .bx:hover{background:#b0303018;}
.bsm{height:26px;padding:0 9px;font-size:11px;}
.ic{width:28px;height:28px;border-radius:3px;background:transparent;border:1px solid var(--b1);cursor:pointer;color:var(--dim);font-size:14px;display:inline-flex;align-items:center;justify-content:center;}
.ic:hover{background:var(--s3);color:var(--text);}
.fab{position:fixed;bottom:74px;right:14px;width:44px;height:44px;border-radius:50%;background:var(--pri2);border:1px solid var(--pri);cursor:pointer;font-size:20px;color:#b8d4f0;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 18px #1e4f8840;z-index:41;}
.field{margin-bottom:10px;} .field>label{display:block;font-family:var(--mono);font-size:9px;color:var(--dim);margin-bottom:4px;text-transform:uppercase;letter-spacing:.8px;}
.inp{width:100%;background:var(--s2);border:1px solid var(--b1);border-radius:3px;padding:7px 9px;color:var(--text);font-family:var(--sans);font-size:13px;outline:none;}
.inp:focus{border-color:var(--pri2);} textarea.inp{resize:vertical;min-height:60px;}
.irow{display:flex;gap:8px;} .irow .field{flex:1;}
.ov{position:fixed;inset:0;background:#000000b0;z-index:300;display:flex;align-items:flex-end;}
.sheet{background:var(--s1);border:1px solid var(--b1);border-top:2px solid var(--pri2);border-radius:12px 12px 0 0;width:100%;max-height:92dvh;overflow-y:auto;padding:17px 14px;}
.sheet-h{font-size:15px;font-weight:600;margin-bottom:13px;}
.sheet-f{display:flex;gap:7px;justify-content:flex-end;margin-top:13px;padding-top:10px;border-top:1px solid var(--b1);}
.rcard{background:var(--s1);border:1px solid var(--b1);border-radius:4px;margin-bottom:9px;}
.rcard-h{padding:11px 13px;}
.rcard-n{font-weight:600;font-size:14px;}
.rcard-m{font-family:var(--mono);font-size:10px;color:var(--faint);margin-top:3px;line-height:1.6;}
.rcard-a{display:flex;gap:6px;padding:7px 13px;background:var(--s2);border-top:1px solid var(--b1);flex-wrap:wrap;align-items:center;}
.empty{display:flex;flex-direction:column;align-items:center;padding:52px 20px;gap:8px;color:var(--faint);text-align:center;}
.footer{flex-shrink:0;background:var(--s1);border-top:1px solid var(--b1);padding:10px 13px;}
.footer-logo{font-family:var(--mono);font-size:9px;color:var(--pri);letter-spacing:2px;margin-bottom:5px;}
.footer-txt{font-size:10px;color:var(--dim);line-height:1.6;}
.gh-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--b1);}
.gh-row:last-child{border-bottom:none;}
.warn-banner{background:#1a1408;border:1px solid #4a3810;border-radius:3px;padding:8px 11px;margin-top:7px;font-size:11px;color:#b89030;line-height:1.6;}
</style>
</head>
<body>
<div id="splash" style="position:fixed;inset:0;background:#09090d;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;font-family:'IBM Plex Mono',monospace;">
  <div style="font-size:20px;font-weight:600;color:#3a7ec4;letter-spacing:3px;">CCMC™ Web EBuLa</div>
  <div style="font-size:10px;color:#2a4a6a;letter-spacing:2px;">powered by CraftCraftMine Netzwerk™</div>
  <div style="margin-top:18px;width:48px;height:1px;background:linear-gradient(90deg,transparent,#3a7ec4,transparent);animation:sl 1.2s ease-in-out infinite;"></div>
</div>
<style>@keyframes sl{0%,100%{opacity:.2}50%{opacity:1}}</style>
<script>
  window.addEventListener('load', function() {
    setTimeout(function() {
      var s = document.getElementById('splash');
      if (!s) return;
      s.style.transition = 'opacity .5s ease';
      s.style.opacity = '0';
      setTimeout(function(){ s.remove(); }, 550);
    }, 700);
  });
</script>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;
const F = ({label, req, children}) => (
  <div className="field">
    <label>{label}{req && <span style={{color:'var(--red)',marginLeft:3}}>*</span>}</label>
    {children}
  </div>
);

function getMigrationHints(route) {
  const h = [];
  if (!route.author)     h.push('Kein Autor');
  if (!route.streckenNr) h.push('Keine Strecken-Nr.');
  if (!route.zugTyp)     h.push('Kein Fahrzeugtyp');
  if ((route.timetables||[]).length === 0) h.push('Noch keine Fahrpl\xe4ne');
  (route.timetables||[]).forEach(tt => {
    if (!tt.zugNummer) h.push('FP "'+ tt.name +'": Keine Zugnr.');
  });
  return h;
}

function GHBrowser({onImport, onClose}) {
  const [loading, setLoading] = useState(true);
  const [list, setList] = useState([]);
  const [err, setErr] = useState('');
  const [imp, setImp] = useState(null);
  const [impErr, setImpErr] = useState('');

  useEffect(() => {
    // GitHub Contents API — listet ALLE Dateien automatisch, kein index.json nötig
    fetch(`https://api.github.com/repos/${GH_REPO}/contents/`,
      { headers: { 'Accept': 'application/vnd.github.v3+json' } })
      .then(r => {
        if (!r.ok) throw new Error(`GitHub API: HTTP ${r.status}`);
        return r.json();
      })
      .then(files => {
        const jsonFiles = files
          .filter(f => f.type === 'file' && f.name.endsWith('.json') && f.name !== 'index.json');
        // Namen direkt aus den JSONs lesen (parallel) – kein Ableiten aus Dateiname
        return Promise.all(jsonFiles.map(f =>
          fetch(f.download_url)
            .then(r => r.ok ? r.json() : null)
            .then(json => ({
              file:         f.name,
              download_url: f.download_url,
              name:         (json && json.name) || f.name.replace('.json','').replace(/[-_]+/g,' ').trim(),
              desc:         (json && json.desc) || '',
            }))
            .catch(() => ({
              file:         f.name,
              download_url: f.download_url,
              name:         f.name.replace('.json','').replace(/[-_]+/g,' ').trim(),
              desc:         '',
            }))
        ));
      })
      .then(routes => { setList(routes); setLoading(false); })
      .catch(e => { setErr(e.message); setLoading(false); });
  }, []);

  const doImp = async item => {
    setImp(item.file);
    setImpErr('');
    try {
      // download_url ist der direkte raw-Link aus der API — immer korrekt
      const url = item.download_url || (GH_RAW + item.file);
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status} beim Laden von ${item.file}`);
      const text = await res.text();
      let parsed;
      try { parsed = JSON.parse(text); }
      catch(e) { throw new Error(`Ungültiges JSON in ${item.file}: ${e.message}`); }
      const r = DB.migrate(parsed);
      if (!r) throw new Error('Migration fehlgeschlagen (unbekanntes Format)');
      // Duplikat-Schutz: gleicher Name → ID beibehalten, Route aktualisieren
      const norm = s => s.toLowerCase().replace(/[^a-z0-9]/g,'');
      const existing = DB.get().find(x => norm(x.name) === norm(r.name));
      r.id = existing ? existing.id : Date.now().toString();
      onImport(r);
    } catch(e) {
      setImpErr(`${item.file}: ${e.message}`);
    }
    setImp(null);
  };

  return (
    <div className="ov" onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div className="sheet">
        <div className="sheet-h">GitHub: {GH_REPO}</div>

        {loading && <div style={{color:'var(--dim)',fontSize:12,padding:'8px 0'}}>Verbinde mit GitHub…</div>}

        {err && (
          <div style={{color:'var(--red)',fontSize:11,lineHeight:1.8,marginBottom:8,background:'#1a0a0a',border:'1px solid #3a1010',borderRadius:3,padding:'8px 11px'}}>
            <strong>Fehler:</strong> {err}<br/>
            <span style={{color:'var(--faint)'}}>
              Repo muss public sein. GitHub API-Rate-Limit: 60 Req/h ohne Token.
            </span>
          </div>
        )}

        {impErr && (
          <div style={{color:'var(--red)',fontSize:11,lineHeight:1.8,marginBottom:8,background:'#1a0a0a',border:'1px solid #3a1010',borderRadius:3,padding:'8px 11px'}}>
            <strong>Import-Fehler:</strong> {impErr}
          </div>
        )}

        {!loading && !err && list.length === 0 && (
          <div style={{color:'var(--dim)',fontSize:12}}>Keine .json Dateien im Repo gefunden.</div>
        )}

        {list.map(item => {
          const normN = s => s.toLowerCase().replace(/[^a-z0-9]/g,'');
          const alreadyLoaded = DB.get().some(r => normN(r.name) === normN(item.name));
          return (
            <div className="gh-row" key={item.file}>
              <div style={{flex:1}}>
                <div style={{fontWeight:600,fontSize:13}}>{item.name}</div>
                <div style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--faint)'}}>
                  {item.file}
                  {alreadyLoaded && <span style={{color:'var(--acc)',marginLeft:6}}>✓ bereits geladen</span>}
                </div>
              </div>
              <button className="btn bp bsm" onClick={()=>doImp(item)} disabled={!!imp}>
                {imp === item.file ? '…' : alreadyLoaded ? 'Aktualisieren' : 'Import'}
              </button>
            </div>
          );
        })}

        <div className="sheet-f">
          <span style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--faint)',alignSelf:'center'}}>
            {list.length} Strecke{list.length!==1?'n':''} gefunden
          </span>
          <button className="btn bo" onClick={onClose}>Schließen</button>
        </div>
      </div>
    </div>
  );
}

function RouteSheet({onClose, onCreate, existing}) {
  const isEdit = !!existing;
  const [form, setForm] = useState({
    name:       existing?.name       || '',
    desc:       existing?.desc       || '',
    author:     existing?.author     || '',
    start:      String(existing?.startKm   ?? '0'),
    end:        String(existing?.endKm     ?? '100'),
    zugTyp:     existing?.zugTyp     || '',
    streckenNr: existing?.streckenNr || '',
    spurweite:  String(existing?.spurweite ?? '1435'),
  });
  const fv = (k,v) => setForm(p=>({...p,[k]:v}));
  const ok = () => {
    if (!form.name.trim()) return;
    const ae = checkReservedAuthor(form.author);
    if (ae) { alert(ae); return; }
    onCreate({
      ...(existing || {}),
      version:    EBULA_VERSION,
      id:         existing?.id || Date.now().toString(),
      name:       form.name.trim(),
      desc:       form.desc.trim(),
      author:     form.author.trim(),
      startKm:    parseFloat(form.start)||0,
      endKm:      parseFloat(form.end)||100,
      zugTyp:     form.zugTyp.trim(),
      streckenNr: form.streckenNr.trim(),
      spurweite:  parseInt(form.spurweite)||1435,
      objects:    existing?.objects    || [],
      timetables: existing?.timetables || [],
      createdAt:  existing?.createdAt  || new Date().toISOString(),
    });
  };
  return (
    <div className="ov" onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div className="sheet">
        <div className="sheet-h">{isEdit ? 'Strecke bearbeiten' : 'Neue Strecke'}</div>
        <F label="Name" req>
          <input className="inp" value={form.name} autoFocus onChange={e=>fv('name',e.target.value)} placeholder="München – Augsburg"/>
        </F>
        <F label="Beschreibung (optional)">
          <textarea className="inp" value={form.desc} onChange={e=>fv('desc',e.target.value)} placeholder="Kurze Beschreibung…"/>
        </F>
        <div className="irow">
          <F label="Start-km"><input className="inp" type="number" value={form.start} onChange={e=>fv('start',e.target.value)}/></F>
          <F label="End-km"><input className="inp" type="number" value={form.end} onChange={e=>fv('end',e.target.value)}/></F>
        </div>
        <div style={{fontFamily:'var(--mono)',fontSize:9,color:'var(--faint)',textTransform:'uppercase',letterSpacing:1,margin:'6px 0 8px'}}>Optional — Zusätzliche Infos</div>
        <div className="irow">
          <F label="Autor"><input className="inp" value={form.author} onChange={e=>fv('author',e.target.value)} placeholder="Dein Name"/></F>
          <F label="Strecken-Nr."><input className="inp" value={form.streckenNr} onChange={e=>fv('streckenNr',e.target.value)} placeholder="z. B. 5900"/></F>
        </div>
        <div className="irow">
          <F label="Fahrzeugtyp"><input className="inp" value={form.zugTyp} onChange={e=>fv('zugTyp',e.target.value)} placeholder="z. B. BR 642"/></F>
          <F label="Spurweite mm"><input className="inp" type="number" value={form.spurweite} onChange={e=>fv('spurweite',e.target.value)}/></F>
        </div>
        <div className="sheet-f">
          <button className="btn bo" onClick={onClose}>Abbrechen</button>
          <button className="btn bp" onClick={ok} disabled={!form.name.trim()}>{isEdit ? 'Speichern' : 'Erstellen'}</button>
        </div>
      </div>
    </div>
  );
}

function Home() {
  const [routes, setRoutes]       = useState(DB.get());
  const [showNew, setShowNew]     = useState(false);
  const [editRoute, setEditRoute] = useState(null);
  const [showMenu, setShowMenu]   = useState(false);
  const [showGH, setShowGH]       = useState(false);
  const rf = () => setRoutes(DB.get());

  const doCreate = r => { DB.save(r); rf(); setShowNew(false); setEditRoute(null); };
  const doDel = id => { if(!confirm('Strecke löschen?'))return; DB.delete(id); rf(); };
  const doExp = r => {
    const d = { ...JSON_META, ...r };
    const a = document.createElement('a');
    a.href = 'data:application/json,' + encodeURIComponent(JSON.stringify(d,null,2));
    a.download = r.name.replace(/\s+/g,'-') + '.json'; a.click();
  };
  const doImpFile = e => {
    const f = e.target.files[0]; if (!f) return;
    const rd = new FileReader();
    rd.onload = ev => {
      try { const r = DB.migrate(JSON.parse(ev.target.result)); r.id = Date.now().toString(); DB.save(r); rf(); }
      catch { alert('Ungültige JSON-Datei'); }
    };
    rd.readAsText(f);
  };
  const doImpGH = r => { DB.save(r); rf(); setShowGH(false); };
  const addDemo = () => { const r = DB.migrate({...DEMO_ROUTE, id: Date.now().toString()}); DB.save(r); rf(); };
  const openAnsicht = r => {
    const hash = encodeURIComponent(r.name.toLowerCase().replace(/\s+/g,'-'));
    window.location.href = `ansicht/#${hash}`;
  };

  return (
    <div className="page">
      <div className="bar">
        <span className="brand">CCMC™ WEB EBULA</span>
        <button className="btn bp bsm" onClick={()=>window.location.href='ansicht/'} title="EBuLa ohne Strecke starten">▶ EBuLa starten</button>
        <button className="ic" title="Tutorial" onClick={()=>window.location.href='tutorial/'}>?</button>
        <button className="ic" style={{fontSize:16}} onClick={()=>setShowMenu(m=>!m)}>☰</button>
      </div>

      {showMenu && (
        <div style={{background:'var(--s2)',borderBottom:'1px solid var(--b1)',padding:'8px 12px',display:'flex',gap:7,flexWrap:'wrap'}}>
          <label className="btn bo bsm" style={{cursor:'pointer'}}>
            Import <input type="file" accept=".json" style={{display:'none'}} onChange={doImpFile}/>
          </label>
          <button className="btn bo bsm" onClick={()=>{setShowGH(true);setShowMenu(false);}}>GitHub</button>
          <button className="btn bo bsm" onClick={()=>{addDemo();setShowMenu(false);}}>Demo-Strecke laden</button>
          <button className="btn bo bsm" onClick={()=>{DB.resetTut();window.location.href='tutorial/';}}>Tutorial starten</button>
        </div>
      )}

      <div className="scroll">
        {routes.length === 0 ? (
          <div className="empty">
            <div style={{fontSize:13,fontWeight:600}}>Keine Strecken vorhanden</div>
            <div style={{fontSize:11}}>+ drücken um eine neue anzulegen</div>
            <button className="btn bp bsm" style={{marginTop:8}} onClick={addDemo}>Demo-Strecke laden</button>
            <button className="btn bo bsm" onClick={()=>window.location.href='tutorial/'}>Tutorial starten</button>
          </div>
        ) : routes.map(r => {
          const hints = getMigrationHints(r);
          return (
            <div className="rcard" key={r.id}>
              <div className="rcard-h">
                <div className="rcard-n">{r.name}</div>
                {r.desc && <div style={{fontSize:11,color:'var(--dim)',marginTop:2}}>{r.desc}</div>}
                <div className="rcard-m">
                  km {r.startKm}–{r.endKm} · {(r.objects||[]).length} Obj. · {(r.objects||[]).filter(o=>o.type==='STATION').length} Bf. · {(r.timetables||[]).length} Fahrpläne
                  {r.author && ` · ${r.author}`}
                  {r.streckenNr && ` · Str. ${r.streckenNr}`}
                  {r.createdAt && ` · ${new Date(r.createdAt).toLocaleDateString('de-DE')}`}
                </div>
                {hints.length > 0 && (
                  <div className="warn-banner">⚠ Fehlende Felder: {hints.join(' · ')}</div>
                )}
              </div>
              <div className="rcard-a">
                <button className="btn bo bsm" onClick={()=>window.location.href=`editor/#${r.id}`}>Editor</button>
                <button className="btn bo bsm" onClick={()=>window.location.href=`fahrplaene/#${r.id}`}>Fahrpläne</button>
                <button className="btn bp bsm" onClick={()=>openAnsicht(r)}>▶ Ansicht</button>
                <button className="btn bo bsm" onClick={()=>setEditRoute(r)} title="Streckendaten bearbeiten">✎</button>
                <button className="btn bo bsm" style={{marginLeft:'auto'}} onClick={()=>doExp(r)}>Export</button>
                <button className="btn bx bsm" onClick={()=>doDel(r.id)}>✕</button>
              </div>
            </div>
          );
        })}
      </div>

      <div className="footer">
        <div className="footer-logo">CCMC™ WEB EBULA · CraftCraftMine Netzwerk™</div>
        <div className="footer-txt">
          Privates Hobby-Projekt für Train Sim World Simulationen. Nicht für kommerzielle Zwecke bestimmt.<br/>
          © 2026 CraftCraftMine Netzwerk™ · CCMC™ = CraftCraftMine Code™ · Teil des CraftCraftMine Netzwerk™<br/>
          Support: <a href="mailto:support@craftcraftmine.net" style={{color:'var(--pri)'}}>support@craftcraftmine.net</a>
          {'  ·  '}<a href="https://craftcraftmine.net/ueberuns" style={{color:'var(--pri)'}} target="_blank">craftcraftmine.net/ueberuns</a>
        </div>
      </div>

      <button className="fab" onClick={()=>setShowNew(true)}>+</button>
      {showNew   && <RouteSheet onClose={()=>setShowNew(false)}  onCreate={doCreate}/>}
      {editRoute && <RouteSheet onClose={()=>setEditRoute(null)} onCreate={doCreate} existing={editRoute}/>}
      {showGH    && <GHBrowser  onImport={doImpGH} onClose={()=>setShowGH(false)}/>}
    </div>
  );
}
ReactDOM.createRoot(document.getElementById('root')).render(<Home/>);
</script>
</body>
</html>
