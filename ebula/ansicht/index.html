<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>CCMN™ Web EBuLa – Ansicht</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<script src="../shared/types.js"></script>
<script src="../shared/db.js"></script>
<script src="../shared/calc.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
/* ════════════════════════════════════════
   EBULA DEVICE STYLES
════════════════════════════════════════ */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body,#root{height:100%;overflow:hidden;background:#111;}

/* Landscape-Pflicht */
.portrait-warn{
  display:none;position:fixed;inset:0;background:#000;z-index:9999;
  align-items:center;justify-content:center;flex-direction:column;gap:16px;
  font-family:'IBM Plex Mono',monospace;color:#666;font-size:14px;text-align:center;
}
@media (orientation:portrait) and (max-width:900px){
  .portrait-warn{display:flex;}
}

/* ── Device Frame ── */
.device{
  width:100vw;height:100dvh;
  background: linear-gradient(145deg,#2a2a2a,#1a1a1a);
  display:flex;flex-direction:column;
  font-family:'IBM Plex Mono',monospace;
  user-select:none;
  overflow:hidden;
}

/* ── Obere Button-Reihe ── */
.top-btns{
  display:flex;align-items:center;gap:5px;
  padding:6px 8px 4px;
  background:linear-gradient(180deg,#222,#1a1a1a);
  border-bottom:1px solid #333;
  flex-shrink:0;
}
.top-btn{
  display:flex;align-items:center;justify-content:center;
  min-width:36px;height:30px;padding:0 6px;
  background:linear-gradient(180deg,#3a3a3a,#2a2a2a);
  border:1px solid #444;border-bottom:2px solid #111;
  border-radius:4px;cursor:pointer;
  font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:600;
  color:#aaa;letter-spacing:.5px;
  transition:all .1s;
  flex-shrink:0;
}
.top-btn:active{transform:translateY(1px);border-bottom-width:1px;background:#222;}
.top-btn.active{background:linear-gradient(180deg,#1a3a1a,#0f2a0f);color:#4dca70;border-color:#2a6a2a;}
.top-btn.warn{background:linear-gradient(180deg,#3a1a1a,#2a0f0f);color:#ca4d4d;border-color:#6a2a2a;}
.top-btn.wide{min-width:80px;}
.top-btn.icon{font-size:14px;}
.top-spacer{flex:1;}

/* ── Mittlerer Bereich ── */
.mid{display:flex;flex:1;min-height:0;}

/* ── Display ── */
.display{
  flex:1;display:flex;flex-direction:column;min-width:0;
  background:#000;border:2px solid #333;margin:0 4px;
  /* Helligkeit/Kontrast via CSS-Filter */
}

/* Header des Displays (wie echte EBuLa) */
.disp-header{
  display:grid;
  grid-template-columns:60px 1fr 110px 90px;
  border-bottom:1px solid #333;
  flex-shrink:0;background:#0a0a0a;
}
.disp-hcell{
  padding:3px 6px;border-right:1px solid #333;
  font-family:'IBM Plex Mono',monospace;font-size:11px;
  display:flex;align-items:center;
}
.disp-hcell:last-child{border-right:none;}
.disp-year{color:#888;font-size:10px;}
.disp-status{color:#c84040;font-weight:600;font-size:11px;justify-content:center;}
.disp-status.ok{color:#3a9a50;}
.disp-date{color:#888;font-size:10px;justify-content:flex-end;}
.disp-time{color:#c8c8d8;font-size:13px;font-weight:600;justify-content:center;}

/* Info-Zeile (km, nächster Halt) */
.disp-info{
  display:flex;align-items:center;
  padding:2px 6px;border-bottom:1px solid #222;
  background:#060606;flex-shrink:0;
  font-size:10px;min-height:20px;
}
.disp-info-left{color:#3a7ec4;font-weight:600;flex-shrink:0;margin-right:10px;}
.disp-info-right{color:#888;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* BFP Streifen */
.bfp{
  flex:1;overflow-y:auto;overflow-x:hidden;background:#000;
  /* Immer scrollen, kein user-scroll wenn auto-scroll */
}
.bfp::-webkit-scrollbar{width:3px;}
.bfp::-webkit-scrollbar-thumb{background:#222;}

/* BFP Kopfzeile */
.bfp-head{
  display:grid;
  grid-template-columns:52px 18px 46px 1fr 52px 52px;
  background:#0c0c0c;border-bottom:1px solid #2a2a2a;
  position:sticky;top:0;z-index:20;
}
.bfp-hc{
  padding:3px 3px;font-size:8px;color:#444;text-transform:uppercase;
  letter-spacing:.4px;border-right:1px solid #222;text-align:center;
}
.bfp-hc:last-child{border-right:none;}

/* BFP Zeile */
.bfp-row{
  display:grid;
  grid-template-columns:52px 18px 46px 1fr 52px 52px;
  border-bottom:1px solid #111;
  position:relative;
}
.bfp-row.is-sta{background:#08081200;}
.bfp-row.is-cur{background:#0a180a;}

/* V-Spalte */
.cv{
  border-right:1px solid #1a1a1a;position:relative;
  display:flex;align-items:center;justify-content:flex-end;padding-right:3px;
}
/* Track-Spalte */
.ct{
  border-right:1px solid #1a1a1a;position:relative;
  display:flex;align-items:center;justify-content:center;
}
.gleislinie{position:absolute;top:0;bottom:0;width:2px;left:50%;transform:translateX(-50%);z-index:0;}
.bfsym{border-radius:50%;position:relative;z-index:2;}
.vtick{position:absolute;left:0;right:0;height:2px;top:50%;z-index:1;}
.pdiam{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%) rotate(45deg);
  width:10px;height:10px;z-index:10;
  border:2px solid #000;background:#38b060;
}
.parm{position:absolute;top:50%;height:1px;z-index:9;background:#38b060;opacity:.3;}
/* km-Spalte */
.ck{
  border-right:1px solid #1a1a1a;
  display:flex;align-items:center;justify-content:flex-end;padding:0 4px;
}
.kmv{font-size:10px;color:#555;}
.kmv.act{color:#3a7ec4;font-weight:600;}
.kmv.cur{color:#38b060;}
/* Name-Spalte */
.cn{
  border-right:1px solid #1a1a1a;padding:3px 5px;
  display:flex;flex-direction:column;justify-content:center;overflow:hidden;
}
.bfname{font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bfnote{font-size:9px;color:#444;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
/* Zeit-Spalten */
.ca,.cd{
  display:flex;align-items:center;justify-content:center;
  border-right:1px solid #1a1a1a;
}
.cd{border-right:none;}
.bftime{font-size:10px;color:#b89030;}

/* Status-Leiste */
.disp-status-bar{
  display:flex;align-items:center;gap:8px;padding:2px 6px;
  border-top:1px solid #1a1a1a;background:#060606;flex-shrink:0;
  font-size:9px;color:#444;min-height:18px;
}
.sb-pill{background:#0e0e0e;border:1px solid #222;border-radius:2px;padding:1px 5px;color:#555;}
.sb-pill.hi{color:#3a7ec4;}

/* ── Rechte Buttons ── */
.right-btns{
  display:flex;flex-direction:column;gap:4px;padding:4px 6px 4px 4px;justify-content:center;
  flex-shrink:0;
}
.right-btn{
  width:36px;height:36px;
  background:linear-gradient(180deg,#3a3a3a,#2a2a2a);
  border:1px solid #444;border-bottom:2px solid #111;border-radius:4px;
  cursor:pointer;font-size:12px;color:#888;
  display:flex;align-items:center;justify-content:center;
  transition:all .1s;font-family:'IBM Plex Mono',monospace;font-weight:600;
}
.right-btn:active{transform:translateY(1px);border-bottom-width:1px;background:#222;}
.right-btn.c-btn{color:#c84040;border-color:#5a3a3a;}
.right-btn.e-btn{color:#3a9a50;border-color:#3a5a3a;}

/* ── Untere Reihe (Numpad + vEBuLa) ── */
.bottom-row{
  display:flex;align-items:center;gap:4px;padding:4px 8px 6px;
  background:linear-gradient(180deg,#1a1a1a,#222);
  border-top:1px solid #333;flex-shrink:0;
}
.num-btn{
  width:34px;height:28px;
  background:linear-gradient(180deg,#333,#252525);
  border:1px solid #3a3a3a;border-bottom:2px solid #111;border-radius:3px;
  cursor:pointer;font-family:'IBM Plex Mono',monospace;font-size:11px;
  color:#777;display:flex;align-items:center;justify-content:center;
  transition:all .1s;
}
.num-btn:active{transform:translateY(1px);border-bottom-width:1px;background:#1a1a1a;}
.num-btn.active{color:#3a7ec4;border-color:#1a3a6a;background:linear-gradient(180deg,#0c1a2a,#081422);}
.vebula-label{
  margin-left:auto;padding:4px 8px;
  background:#0a0a0a;border:1px solid #222;border-radius:3px;
  font-family:'IBM Plex Mono',monospace;font-size:8px;
  color:#3a5a7a;letter-spacing:1px;text-align:center;line-height:1.4;
  cursor:pointer;
}

/* ── Overlays ── */
.overlay{
  position:absolute;inset:0;background:#000000e0;z-index:50;
  display:flex;align-items:center;justify-content:center;
  font-family:'IBM Plex Mono',monospace;
}
.ov-box{
  background:#0e0e0e;border:1px solid #333;border-top:2px solid #3a7ec4;
  border-radius:4px;padding:16px;max-width:320px;width:90%;
}
.ov-title{font-size:12px;color:#3a7ec4;margin-bottom:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;}
.ov-body{font-size:11px;color:#888;line-height:1.7;}
.ov-body strong{color:#aaa;}

/* Störungs-Eingabe */
.st-input{
  width:100%;background:#060606;border:1px solid #333;border-radius:3px;
  padding:6px 8px;color:#c84040;font-family:'IBM Plex Mono',monospace;font-size:11px;
  outline:none;margin-top:8px;
}

/* Display AUS */
.disp-off{background:#000!important;}
.disp-off>*{visibility:hidden;}

/* Nachtmodus */
.night .display{filter:sepia(1) hue-rotate(120deg) saturate(.3) brightness(.7);}

/* V-Klammern Container */
.vclamps{position:absolute;top:0;left:0;width:52px;pointer-events:none;z-index:5;}
</style>
</head>
<body>

<!-- Querformat-Warnung -->
<div class="portrait-warn">
  <div style="font-size:32px">↻</div>
  <div>Bitte Gerät drehen<br/><span style="font-size:11px;color:#444">CCMN™ Web EBuLa braucht Querformat</span></div>
</div>

<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useMemo, useCallback } = React;

/* ════════════════════════════════════════
   HAUPT-KOMPONENT
════════════════════════════════════════ */
function EBuLaDisplay() {
  // Route + Timetable aus URL-Hash oder State laden
  const [route,    setRoute]    = useState(null);
  const [tripData, setTripData] = useState(null);
  const [loading,  setLoading]  = useState(true);
  const [errMsg,   setErrMsg]   = useState('');

  // EBuLa-Gerät State
  const [displayOn,   setDisplayOn]   = useState(true);
  const [nightMode,   setNightMode]   = useState(false);
  const [brightness,  setBrightness]  = useState(100); // %
  const [contrast,    setContrast]    = useState(100); // %
  const [showV,       setShowV]       = useState(true);  // V>0 toggle
  const [stationOnly, setStationOnly] = useState(false); // V=0
  const [reversed,    setReversed]    = useState(false); // UD
  const [activeOverlay, setOv]        = useState(null);  // 'info'|'strecke'|'stoerung'|'einstellungen'
  const [stoerung,    setStoerung]    = useState('');
  const [stoerungActive, setStoerungActive] = useState(false);
  const [activeTTIdx, setActiveTTIdx] = useState(0);

  // Fahrt-State
  const timeSec   = useRef(0);
  const [timeStr, setTimeStr] = useState('00:00:00');
  const [running,  setRunning]  = useState(false);
  const [offset,   setOffset]   = useState(0);
  const [autoScroll, setAutoScroll] = useState(true);
  const tickRef    = useRef(null);
  const bfpRef     = useRef(null);

  // Einstellungen laden
  useEffect(() => {
    const s = DB.getSettings();
    if (s.brightness) setBrightness(s.brightness);
    if (s.contrast)   setContrast(s.contrast);
    if (s.nightMode)  setNightMode(s.nightMode);
  }, []);

  // Route aus Hash oder localStorage laden
  useEffect(() => {
    const hash = getRouteHashName();
    let r = null;

    if (hash) {
      // Versuche nach Name
      r = DB.getByName(hash);
      // Falls nicht gefunden: Demo-Route
      if (!r && hash === 'demo') r = DEMO_ROUTE;
    }
    // Kein Hash: zuletzt gewählte Route
    if (!r) {
      const all = DB.get();
      if (all.length > 0) r = all[all.length-1];
    }

    if (!r) { setLoading(false); setErrMsg('Keine Route gefunden.'); return; }

    setRoute(r);
    // Ersten Fahrplan laden
    if ((r.timetables||[]).length > 0) {
      loadTripFromTT(r, r.timetables[0], 0);
    } else {
      setTripData(null);
    }
    setLoading(false);
  }, []);

  const loadTripFromTT = (r, tt, idx) => {
    const dep = tt.departure || '00:00:00';
    timeSec.current = timeToSec(dep) || 0;
    setTimeStr(secToTime(timeSec.current));
    setActiveTTIdx(idx);
    setTripData({
      trip: { mode:tt.mode, departure:dep, avgSpeed:tt.avgSpeed||100, offset:0, startKm:r.startKm||0 },
      timetable: tt.stops || [],
      tt
    });
    DB.setActiveTTId(r.id, tt.id);
  };

  // Fahrplan wechseln per Numpad
  const selectTT = useCallback((idx) => {
    if (!route || !route.timetables) return;
    const tt = route.timetables[idx];
    if (!tt) return;
    setRunning(false);
    loadTripFromTT(route, tt, idx);
  }, [route]);

  // Timer — 1:1 Echtzeit
  useEffect(() => {
    clearInterval(tickRef.current);
    if (running) {
      tickRef.current = setInterval(() => {
        timeSec.current += 1;
        setTimeStr(secToTime(timeSec.current));
      }, 1000);
    }
    return () => clearInterval(tickRef.current);
  }, [running]);

  // Berechnungen
  const served = useMemo(() =>
    (tripData?.timetable || []).filter(s => s.served !== false),
    [tripData]);

  const curKm = useMemo(() => {
    if (!tripData) return route?.startKm || 0;
    return calcKm(timeStr, {...tripData.trip, offset}, served);
  }, [timeStr, tripData, offset, served]);

  const items = useMemo(() => {
    if (!route) return [];
    let objs = [...(route.objects || [])];
    // Timetable-Zeiten einmergen
    (tripData?.timetable || []).forEach(s => {
      const idx = objs.findIndex(o => o.id === s.sid || (o.km === s.km && o.type === 'STATION'));
      if (idx >= 0) objs[idx] = { ...objs[idx], ttArr: s.arr, ttDep: s.dep, ttServed: s.served !== false };
    });
    // Station-Only Filter
    if (stationOnly) objs = objs.filter(o => o.type === 'STATION');
    // V ausblenden
    if (!showV) objs = objs.filter(o => o.type !== 'SPEED' && o.type !== 'LA');
    // Richtung
    if (reversed) objs = [...objs].reverse();
    return objs;
  }, [route, tripData, stationOnly, showV, reversed]);

  const vSegs = useMemo(() => stationOnly ? [] : calcVSegs(items), [items, stationOnly]);
  const nextStop = useMemo(() => findNextStop(served, curKm), [served, curKm]);
  const prevStop = useMemo(() => findPrevStop(served, curKm), [served, curKm]);
  const curItem  = useMemo(() => findCurrentItem(items, curKm), [items, curKm]);

  const prog = route
    ? Math.max(0, Math.min(1, (curKm - route.startKm) / (route.endKm - route.startKm)))
    : 0;

  // Auto-Scroll
  useEffect(() => {
    if (!autoScroll || !bfpRef.current) return;
    let top = 0;
    for (const it of items) {
      if (it.km > curKm) break;
      top += it.type === 'STATION' ? STA_H : ROW_H;
    }
    bfpRef.current.scrollTo({ top: top - bfpRef.current.clientHeight * 0.4, behavior: 'smooth' });
  }, [curKm, autoScroll, items]);

  // Einstellungen speichern wenn geändert
  useEffect(() => {
    DB.saveSettings({ brightness, contrast, nightMode });
  }, [brightness, contrast, nightMode]);

  const manualScroll = (dir) => {
    if (!bfpRef.current) return;
    setAutoScroll(false);
    bfpRef.current.scrollBy({ top: dir * 80, behavior: 'smooth' });
  };

  const adjOffset = d => setOffset(o => +(o + d).toFixed(1));

  // Aktuelle Zeit als Datum
  const now = new Date();
  const dispDate = `${String(now.getDate()).padStart(2,'0')}.${String(now.getMonth()+1).padStart(2,'0')}.${now.getFullYear()}`;

  // Fahrplan-Status
  const ttValid = !!(tripData && (served.length > 0));
  const createdYear = tripData?.tt?.createdAt ? new Date(tripData.tt.createdAt).getFullYear() : '–';

  // Display-Filter
  const dispFilter = `brightness(${brightness}%) contrast(${contrast}%)`;

  if (loading) {
    return (
      <div className="device" style={{alignItems:'center',justifyContent:'center',color:'#333',fontFamily:'IBM Plex Mono',fontSize:12}}>
        Lade…
      </div>
    );
  }

  if (errMsg && !route) {
    return (
      <div className="device" style={{alignItems:'center',justifyContent:'center',flexDirection:'column',gap:12,color:'#555',fontFamily:'IBM Plex Mono',fontSize:11}}>
        <div style={{color:'#c84040'}}>{errMsg}</div>
        <button onClick={()=>window.location.href='../'}
          style={{background:'#1a1a1a',border:'1px solid #333',borderRadius:3,color:'#888',padding:'6px 14px',cursor:'pointer',fontFamily:'IBM Plex Mono',fontSize:11}}>
          ← Zurück
        </button>
      </div>
    );
  }

  /* ── RENDER ── */
  return (
    <div className={`device ${nightMode?'night':''}`}>

      {/* ── Obere Buttons ── */}
      <div className="top-btns">
        <button className={`top-btn ${!displayOn?'active':''}`}
          onClick={()=>setDisplayOn(d=>!d)} title="Display An/Aus">
          ☀<br/><span style={{fontSize:8}}>{displayOn?'an':'aus'}</span>
        </button>

        <button className="top-btn" onClick={()=>setOv(v=>v==='strecke'?null:'strecke')} title="Streckeninfo">S</button>
        <button className="top-btn" onClick={()=>setOv(v=>v==='info'?null:'info')} title="Objektinfo">i</button>

        <button className={`top-btn wide ${stoerungActive?'warn':''}`}
          onClick={()=>setOv(v=>v==='stoerung'?null:'stoerung')} title="Störungsmeldung">
          {stoerungActive ? `St: ${stoerung.slice(0,8)}…` : 'St'}
        </button>

        <button className={`top-btn ${showV?'':'active'}`}
          onClick={()=>setShowV(v=>!v)} title="Geschw.-Beschränkungen ein/aus">
          V&gt;0
        </button>

        <button className={`top-btn ${stationOnly?'active':''}`}
          onClick={()=>setStationOnly(s=>!s)} title="Nur Stationen">
          V=0
        </button>

        <div className="top-spacer"/>

        {/* Helligkeit */}
        <button className="top-btn icon" onClick={()=>setBrightness(b=>Math.min(150,b+10))} title="Heller">☀</button>
        {/* Kontrast / Nacht */}
        <button className={`top-btn icon ${nightMode?'active':''}`}
          onClick={()=>setNightMode(n=>!n)} title="Nachtmodus">◑</button>

        <button className={`top-btn ${reversed?'active':''}`}
          onClick={()=>setReversed(r=>!r)} title="Richtung umkehren">UD</button>

        {/* Fullscreen */}
        <button className="top-btn icon" title="Vollbild"
          onClick={()=>{
            if(!document.fullscreenElement) document.documentElement.requestFullscreen?.();
            else document.exitFullscreen?.();
          }}>⛶</button>
      </div>

      {/* ── Mittlerer Bereich ── */}
      <div className="mid">

        {/* ── Display ── */}
        <div className={`display ${!displayOn?'disp-off':''}`} style={{filter:dispFilter}}>

          {/* EBuLa Header */}
          <div className="disp-header">
            <div className="disp-hcell disp-year">{createdYear}</div>
            <div className={`disp-hcell disp-status ${ttValid?'ok':''}`}>
              {ttValid ? (tripData.tt?.name || 'Fahrplan aktiv') : 'Kein Fahrplan'}
            </div>
            <div className="disp-hcell disp-date">{dispDate}</div>
            <div className="disp-hcell disp-time">{timeStr}</div>
          </div>

          {/* Info-Zeile */}
          <div className="disp-info">
            <span className="disp-info-left">
              ab km {curKm.toFixed(1)}{tripData?.trip?.avgSpeed ? ` · ${tripData.trip.avgSpeed} km/h` : ''}
            </span>
            <span className="disp-info-right">
              {nextStop
                ? `Nächster Halt: ${nextStop.name || '–'} · ${Math.max(0,nextStop.km-curKm).toFixed(1)} km`
                : prevStop ? `Ziel: ${prevStop.name} erreicht` : ''}
            </span>
          </div>

          {/* Fortschritts-Linie */}
          <div style={{height:1,background:'#0e0e0e',flexShrink:0}}>
            <div style={{height:'100%',width:prog*100+'%',background:'#1a3a1a'}}/>
          </div>

          {/* BFP Streifen */}
          <div className="bfp" ref={bfpRef}>

            {/* Kopfzeile */}
            <div className="bfp-head">
              <div className="bfp-hc" style={{textAlign:'right',paddingRight:4}}>V</div>
              <div className="bfp-hc"/>
              <div className="bfp-hc">km</div>
              <div className="bfp-hc" style={{textAlign:'left'}}>Bezeichnung</div>
              <div className="bfp-hc">an</div>
              <div className="bfp-hc">ab</div>
            </div>

            {/* V-Klammern */}
            <div className="vclamps">
              {vSegs.map((seg, si) => (
                <div key={si} style={{position:'absolute',top:seg.top,height:seg.height,width:52,overflow:'hidden',pointerEvents:'none'}}>
                  {/* Vertikale Linie */}
                  <div style={{position:'absolute',top:2,bottom:2,right:10,width:1,background:seg.color,opacity:.6}}/>
                  {/* Oben-Strich */}
                  <div style={{position:'absolute',top:2,right:10,height:1,width:8,background:seg.color,opacity:.8}}/>
                  {/* Unten-Strich */}
                  <div style={{position:'absolute',bottom:2,right:10,height:1,width:8,background:seg.color,opacity:.8}}/>
                  {/* Geschwindigkeitszahl */}
                  <div style={{position:'absolute',top:3,right:12,fontFamily:'IBM Plex Mono',fontWeight:600,fontSize:10,color:seg.color,textAlign:'right',lineHeight:1}}>
                    {seg.speed}
                  </div>
                </div>
              ))}

              {/* Zeilen-Wrapper für absolute V-Klammern */}
              <div style={{position:'relative'}}>
                {items.map(it => (
                  <div key={it.id||it.km} style={{height:it.type==='STATION'?STA_H:ROW_H}}/>
                ))}
              </div>
            </div>

            {/* Zeilen */}
            {items.map((item, i) => {
              const isSta  = item.type === 'STATION';
              const isR    = ['SIGNAL','TU_S','TU_E','GRADE'].includes(item.type);
              const tp     = TYPES[item.type] || TYPES.STATION;
              const h      = isSta ? STA_H : ROW_H;
              const passed = reversed ? item.km > curKm + 0.1 : item.km < curKm - 0.1;
              const isCur  = Math.abs(item.km - curKm) < (isSta ? 0.5 : 0.2);
              const served_ = isSta && item.ttServed;

              return (
                <div key={item.id||i} className={`bfp-row ${isSta?'is-sta':''} ${isCur?'is-cur':''}`}
                  style={{height:h, opacity: passed ? 0.45 : 1}}>

                  {/* V-Spalte (leer, Klammern kommen von absoluten Divs) */}
                  <div className="cv" style={{height:h}}>
                    {item.type==='BUE' && (
                      <span style={{fontFamily:'IBM Plex Mono',fontSize:8,color:'#a03030',position:'absolute',right:2,top:'50%',transform:'translateY(-50%)'}}>BÜ</span>
                    )}
                  </div>

                  {/* Gleis-Spalte */}
                  <div className="ct" style={{height:h}}>
                    <div className="gleislinie" style={{
                      background: passed ? '#111' : isCur ? '#38b060' : '#2a2a2a'
                    }}/>
                    {isSta && (
                      <div className="bfsym" style={{
                        width: served_ ? 12 : 7,
                        height: served_ ? 12 : 7,
                        background: served_ ? (passed ? '#333' : '#c4c4d6') : '#1a1a1a',
                        border: `2px solid ${isCur ? '#38b060' : '#000'}`,
                      }}/>
                    )}
                    {item.type === 'SPEED' && <div className="vtick" style={{background:'#a89020',opacity:.8}}/>}
                    {item.type === 'LA'    && <div className="vtick" style={{background:'#b03030',opacity:.8}}/>}
                    {item.type === 'BUE'   && <div className="vtick" style={{background:'#b03030',opacity:.5,height:1}}/>}
                    {item.type === 'TU_S'  && <div style={{position:'absolute',top:2,left:'50%',transform:'translateX(-50%)',fontFamily:'IBM Plex Mono',fontSize:10,color:'#333',zIndex:3}}>⊢</div>}
                    {item.type === 'TU_E'  && <div style={{position:'absolute',bottom:2,left:'50%',transform:'translateX(-50%)',fontFamily:'IBM Plex Mono',fontSize:10,color:'#333',zIndex:3}}>⊣</div>}
                    {isCur && <>
                      <div className="pdiam"/>
                      <div className="parm" style={{right:'calc(50% + 5px)',width:50}}/>
                      <div className="parm" style={{left:'calc(50% + 5px)',width:80}}/>
                    </>}
                  </div>

                  {/* km-Spalte */}
                  <div className="ck" style={{height:h}}>
                    <span className={`kmv ${isCur?'cur':''}`}>{item.km.toFixed(1)}</span>
                  </div>

                  {/* Name-Spalte */}
                  <div className="cn" style={{height:h}}>
                    {isSta ? (
                      <>
                        <div className="bfname" style={{color:passed?'#444':served_?'#c4c4d6':'#555'}}>
                          {item.name||'Bahnhof'}
                          {!served_ && <span style={{color:'#333',fontWeight:400,fontSize:9}}> (Df)</span>}
                        </div>
                        {item.notes && <div className="bfnote">{item.notes}</div>}
                      </>
                    ) : isR ? (
                      <div className="bfnote" style={{color:tp.clr}}>
                        {item.type==='SIGNAL' && (item.name||'Signal')}
                        {item.type==='TU_S'   && `⊢ ${item.name||'Tunnel'}`}
                        {item.type==='TU_E'   && `${item.name||'Tunnel'} ⊣`}
                        {item.type==='GRADE'  && item.gradient!=null && `${item.gradient>0?'↗':'↘'} ${Math.abs(item.gradient)}‰${item.name?' '+item.name:''}`}
                      </div>
                    ) : item.notes ? <div className="bfnote">{item.notes}</div> : null}
                  </div>

                  {/* Ankunft */}
                  <div className="ca" style={{height:h,borderLeft:'1px solid #1a1a1a'}}>
                    {isSta && served_ && item.ttArr && (
                      <span className="bftime">{item.ttArr.slice(0,5)}</span>
                    )}
                  </div>

                  {/* Abfahrt */}
                  <div className="cd" style={{height:h,borderLeft:'1px solid #1a1a1a'}}>
                    {isSta && served_ && item.ttDep && (
                      <span className="bftime">{item.ttDep.slice(0,5)}</span>
                    )}
                  </div>
                </div>
              );
            })}

            {/* Streckenende */}
            <div style={{height:80,display:'flex',alignItems:'flex-start',paddingTop:10,paddingLeft:120}}>
              <span style={{fontFamily:'IBM Plex Mono',fontSize:8,color:'#2a2a2a',letterSpacing:2}}>
                ══ STRECKENENDE km {route?.endKm} ══
              </span>
            </div>
          </div>

          {/* Status-Leiste */}
          <div className="disp-status-bar">
            <span className="sb-pill">RW {reversed?'↑':'↓'}</span>
            <span className="sb-pill hi">km {curKm.toFixed(3)}</span>
            {tripData?.trip?.mode==='SPEED' && <span className="sb-pill">Ø {tripData.trip.avgSpeed} km/h</span>}
            <span className="sb-pill">GSM-R</span>
            {stoerungActive && <span className="sb-pill" style={{color:'#c84040',borderColor:'#5a2a2a'}}>{stoerung}</span>}
            <span style={{marginLeft:'auto',color:'#2a2a2a'}}>
              {offset !== 0 ? `km±${offset>0?'+':''}${offset.toFixed(1)}` : ''}
            </span>
          </div>

          {/* Overlays */}
          {activeOverlay === 'strecke' && route && (
            <div className="overlay" onClick={()=>setOv(null)}>
              <div className="ov-box">
                <div className="ov-title">S — Streckeninfo</div>
                <div className="ov-body">
                  <strong>{route.name}</strong><br/>
                  {route.desc && <>{route.desc}<br/></>}
                  km {route.startKm} → {route.endKm}<br/>
                  Länge: {route.endKm - route.startKm} km<br/>
                  Richtung: {reversed ? '↑ Umgekehrt' : '↓ Normal'}<br/>
                  {route.createdAt && <>Erstellt: {new Date(route.createdAt).toLocaleDateString('de-DE')}<br/></>}
                  Objekte: {(route.objects||[]).length}<br/>
                  Fahrpläne: {(route.timetables||[]).length}
                </div>
              </div>
            </div>
          )}

          {activeOverlay === 'info' && (
            <div className="overlay" onClick={()=>setOv(null)}>
              <div className="ov-box">
                <div className="ov-title">i — Objektinfo</div>
                <div className="ov-body">
                  <strong>Position:</strong> km {curKm.toFixed(3)}<br/>
                  {curItem && <>
                    <strong>Aktuelles Objekt:</strong> {curItem.name||TYPES[curItem.type]?.l||curItem.type}<br/>
                    Typ: {TYPES[curItem.type]?.s} · km {curItem.km.toFixed(3)}<br/>
                    {curItem.notes && <>{curItem.notes}<br/></>}
                  </>}
                  {nextStop && <>
                    <br/><strong>Nächster Halt:</strong> {nextStop.name}<br/>
                    km {nextStop.km.toFixed(1)} · noch {Math.max(0,nextStop.km-curKm).toFixed(1)} km<br/>
                    {nextStop.ttArr && <>an {nextStop.ttArr}<br/></>}
                    {nextStop.ttDep && <>ab {nextStop.ttDep}<br/></>}
                  </>}
                </div>
              </div>
            </div>
          )}

          {activeOverlay === 'stoerung' && (
            <div className="overlay" onClick={e=>e.target===e.currentTarget&&setOv(null)}>
              <div className="ov-box">
                <div className="ov-title">St — Störungsmeldung</div>
                <div className="ov-body">
                  Gib eine Störungsmeldung ein. Sie wird in der Statusleiste angezeigt.
                  <input className="st-input" value={stoerung} maxLength={40}
                    onChange={e=>setStoerung(e.target.value)}
                    placeholder="z. B. Gleisschaden bei km 5,5"
                    autoFocus
                  />
                  <div style={{display:'flex',gap:8,marginTop:10,justifyContent:'flex-end'}}>
                    <button onClick={()=>{setStoerungActive(false);setStoerung('');setOv(null);}}
                      style={{background:'#1a1a1a',border:'1px solid #333',borderRadius:3,color:'#888',padding:'5px 10px',cursor:'pointer',fontFamily:'IBM Plex Mono',fontSize:10}}>
                      Löschen
                    </button>
                    <button onClick={()=>{setStoerungActive(!!stoerung.trim());setOv(null);}}
                      style={{background:'#1a1a2a',border:'1px solid #2a2a4a',borderRadius:3,color:'#3a7ec4',padding:'5px 10px',cursor:'pointer',fontFamily:'IBM Plex Mono',fontSize:10}}>
                      Bestätigen E
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {activeOverlay === 'einstellungen' && (
            <div className="overlay" onClick={e=>e.target===e.currentTarget&&setOv(null)}>
              <div className="ov-box">
                <div className="ov-title">Licht & Kontrast</div>
                <div className="ov-body">
                  <div style={{marginBottom:10}}>
                    <label style={{display:'block',marginBottom:4,color:'#666',fontSize:10}}>Helligkeit {brightness}%</label>
                    <input type="range" min={30} max={150} value={brightness} onChange={e=>setBrightness(+e.target.value)}
                      style={{width:'100%',accentColor:'#3a7ec4'}}/>
                  </div>
                  <div style={{marginBottom:10}}>
                    <label style={{display:'block',marginBottom:4,color:'#666',fontSize:10}}>Kontrast {contrast}%</label>
                    <input type="range" min={50} max={200} value={contrast} onChange={e=>setContrast(+e.target.value)}
                      style={{width:'100%',accentColor:'#3a7ec4'}}/>
                  </div>
                  <label style={{display:'flex',alignItems:'center',gap:8,cursor:'pointer',fontSize:11}}>
                    <input type="checkbox" checked={nightMode} onChange={e=>setNightMode(e.target.checked)} style={{accentColor:'#3a7ec4'}}/>
                    Nachtmodus (Grün-Filter)
                  </label>
                  <div style={{marginTop:12,display:'flex',gap:8,justifyContent:'flex-end'}}>
                    <button onClick={()=>{setBrightness(100);setContrast(100);setNightMode(false);}}
                      style={{background:'#1a1a1a',border:'1px solid #333',borderRadius:3,color:'#888',padding:'5px 10px',cursor:'pointer',fontFamily:'IBM Plex Mono',fontSize:10}}>
                      Zurücksetzen
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* ── Rechte Buttons ── */}
        <div className="right-btns">
          <button className="right-btn c-btn" title="Zurück / Abbrechen"
            onClick={()=>{ if(activeOverlay){setOv(null);} else { setRunning(false); window.location.href='../'; } }}>
            C
          </button>
          <div style={{height:4}}/>
          <button className="right-btn" title="Scroll Hoch" onClick={()=>manualScroll(-3)}>◄</button>
          <button className="right-btn" title="Scroll Runter" onClick={()=>manualScroll(3)}>►</button>
          <div style={{height:4}}/>
          <button className="right-btn" title="km −0.1" onClick={()=>adjOffset(-0.1)}>▲</button>
          <button className="right-btn" title="km +0.1" onClick={()=>adjOffset(+0.1)}>▼</button>
          <div style={{height:4}}/>
          <button className="right-btn e-btn" title="Bestätigen / Auto-Scroll"
            onClick={()=>{ if(activeOverlay==='stoerung'){setStoerungActive(!!stoerung.trim());setOv(null);} else {setAutoScroll(a=>!a);} }}>
            E
          </button>
        </div>
      </div>

      {/* ── Untere Reihe ── */}
      <div className="bottom-row">
        {/* START/STOP */}
        <button className={`num-btn ${running?'active':''}`} style={{width:48}}
          onClick={()=>setRunning(r=>!r)}>
          {running ? '⏹' : '▶'}
        </button>

        {/* Numpad 1–0 → Fahrplan wählen */}
        {[1,2,3,4,5,6,7,8,9,0].map((n, i) => {
          const ttIdx = n === 0 ? 9 : n - 1;
          const hasTT = route && (route.timetables||[]).length > ttIdx;
          return (
            <button key={n} className={`num-btn ${activeTTIdx===ttIdx&&hasTT?'active':''}`}
              style={{opacity:hasTT?1:.3}}
              onClick={()=>selectTT(ttIdx)}
              title={hasTT ? route.timetables[ttIdx].name : `Fahrplan ${n} (nicht vorhanden)`}>
              {n}
            </button>
          );
        })}

        {/* Auto-Scroll Indicator */}
        <button className={`num-btn ${autoScroll?'active':''}`} style={{width:28,fontSize:10}}
          title="Auto-Scroll" onClick={()=>setAutoScroll(a=>!a)}>
          ⊙
        </button>

        {/* km-Versatz Reset */}
        <button className="num-btn" style={{fontSize:10}} title="km-Versatz zurücksetzen" onClick={()=>setOffset(0)}>↺</button>

        {/* vEBuLa Label */}
        <div className="vebula-label" onClick={()=>setOv(v=>v==='einstellungen'?null:'einstellungen')}>
          CCMN™<br/>Web EBuLa
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<EBuLaDisplay/>);
</script>
</body>
</html>
