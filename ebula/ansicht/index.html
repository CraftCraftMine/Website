<!--
  Project:     CCMC‚Ñ¢ Web EBuLa
  Part of:     CraftCraftMine Netzwerk‚Ñ¢ (CCMN‚Ñ¢)
  Copyright:   (c) 2026 CraftCraftMine Netzwerk‚Ñ¢ ‚Äì All rights reserved.
  Description: Privates Hobby-Projekt f√ºr Train Sim World Simulationen.
               Nicht f√ºr kommerzielle Zwecke bestimmt.
  Support:     support@craftcraftmine.net
  Info:        https://craftcraftmine.net/ueberuns
-->
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>CCMC‚Ñ¢ Web EBuLa ‚Äì Anzeige</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="../shared/types.js"></script>
<script src="../shared/db.js"></script>
<script src="../shared/calc.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
/* ‚îÄ‚îÄ Basis ‚îÄ‚îÄ */
:root{
  --bg:#09090d; --s1:#0d0d12; --b1:#1e1e2a; --b2:#2a2a3a;
  --text:#c8c8d8; --dim:#606070; --faint:#282830;
  --pri:#3a7ec4; --pri2:#1e4f88; --red:#c04040; --yel:#b89020;
  --mono:'IBM Plex Mono',monospace;
  --brightness:1; --contrast:1;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body,#root{height:100%;overflow:hidden;background:var(--bg);}
body{font-family:var(--mono);}

/* ‚îÄ‚îÄ EBuLa-Shell ‚îÄ‚îÄ */
.ebula{
  display:flex;flex-direction:column;height:100dvh;
  background:#050508;
  filter:brightness(var(--brightness)) contrast(var(--contrast));
}

/* ‚îÄ‚îÄ Kopfzeile (Zug / Strecke / Datum / Zeit) ‚îÄ‚îÄ */
.e-head{
  flex-shrink:0;
  display:grid;grid-template-columns:80px 1fr 100px 80px;
  background:#0a0a10;border-bottom:1px solid #1a1a28;height:32px;
  font-size:13px;font-weight:600;color:#d0d0e0;
}
.e-head>div{
  display:flex;align-items:center;justify-content:center;
  border-right:1px solid #1a1a28;padding:0 6px;
}
.e-head>div:last-child{border-right:none;}

/* ‚îÄ‚îÄ Status-Zeile oben (ab km X,X : Y km/h) ‚îÄ‚îÄ */
.e-status-top{
  flex-shrink:0;height:22px;background:#08080e;
  border-bottom:1px solid #1a1a28;
  display:flex;align-items:center;padding:0 8px;
  font-size:10px;color:var(--dim);justify-content:space-between;
}

/* ‚îÄ‚îÄ BFP-Streifen (Mitte, scrollt) ‚îÄ‚îÄ */
.e-bfp-wrap{
  flex:1;overflow:hidden;position:relative;
}
.e-bfp{
  position:absolute;width:100%;
  display:flex;flex-direction:column;
}

/* ‚îÄ‚îÄ Positions-Raute (Ortsmarke) ‚îÄ‚îÄ */
.e-marker{
  position:absolute;left:0;right:0;pointer-events:none;z-index:20;
  display:flex;align-items:center;
}
.e-marker-line{
  position:absolute;left:0;right:0;height:1px;background:#f0c020;opacity:.7;
}
.e-marker-diamond{
  position:absolute;right:calc(8% + 2px);
  width:10px;height:10px;background:#f0c020;transform:rotate(45deg);
  box-shadow:0 0 6px #f0c020aa;
}

/* ‚îÄ‚îÄ BFP-Zeile ‚îÄ‚îÄ */
.bfp-row{
  display:flex;flex-shrink:0;
  border-bottom:1px solid #111118;
  position:relative;
}
.bfp-row.sta{background:#0a0c14;min-height:52px;}
.bfp-row.row{background:#060609;min-height:28px;}
.bfp-row.past{opacity:.45;}

/* Spalten */
.col-v{   width:40px; flex-shrink:0; display:flex;align-items:center;justify-content:flex-end;padding-right:4px; font-size:11px;font-weight:700;}
.col-km{  width:52px; flex-shrink:0; display:flex;align-items:center;justify-content:flex-end;padding-right:6px; font-size:11px;color:#8888a0;}
.col-g{   width:12px; flex-shrink:0; display:flex;align-items:stretch;justify-content:center;}
.col-txt{ flex:1;     display:flex;flex-direction:column;justify-content:center;padding:3px 6px;}
.col-arr{ width:52px; flex-shrink:0; display:flex;align-items:center;justify-content:center; font-size:11px;}
.col-dep{ width:52px; flex-shrink:0; display:flex;align-items:center;justify-content:center; font-size:11px;color:#a0c0e0;}

/* Gleis-Grafik-Linie */
.track-line{width:2px;background:#404058;margin:0 auto;flex:1;}
.track-sta{ width:4px;background:#8090c0;margin:0 auto;flex:1;}

/* V-Klammer Balken */
.v-bar{
  position:absolute;left:0;top:0;bottom:0;width:4px;
}

/* Text in BFP-Zeile */
.txt-name{font-size:13px;font-weight:600;color:#d8d8f0;}
.txt-sta{ font-size:13px;font-weight:700;color:#e0e8ff;}
.txt-sub{ font-size:10px;color:var(--dim);margin-top:1px;}
.txt-sig{ font-size:11px;color:#505868;}
.txt-v{   font-size:10px;font-weight:700;}

/* ‚îÄ‚îÄ Geschwindigkeitswiederholung (unterer Balken) ‚îÄ‚îÄ */
.e-vmax{
  flex-shrink:0;height:28px;
  display:flex;align-items:center;padding:0 10px;gap:10px;
  background:#07070d;border-top:1px solid #1a1a28;
  font-size:11px;
}
.e-vmax-label{color:var(--dim);font-size:10px;}
.e-vmax-val{
  font-size:16px;font-weight:700;
  padding:2px 10px;border-radius:2px;min-width:52px;text-align:center;
}
.e-vmax-tag{font-size:9px;color:var(--dim);margin-left:2px;}

/* ‚îÄ‚îÄ Status-Zeile unten ‚îÄ‚îÄ */
.e-status-bot{
  flex-shrink:0;height:22px;background:#05050a;
  border-top:1px solid #1a1a28;
  display:flex;align-items:center;padding:0 8px;gap:12px;
  font-size:10px;color:var(--dim);
}

/* ‚îÄ‚îÄ Softkey-Leiste ‚îÄ‚îÄ */
.e-softkeys{
  flex-shrink:0;height:36px;background:#0a0a14;border-top:1px solid #1a1a28;
  display:flex;
}
.sk{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  border-right:1px solid #1a1a28;cursor:pointer;gap:1px;
  user-select:none;-webkit-user-select:none;
  transition:background .1s;
}
.sk:last-child{border-right:none;}
.sk:active{background:#1a1a2a;}
.sk-label{font-size:9px;color:#5060a0;letter-spacing:.5px;}
.sk-val{  font-size:11px;font-weight:600;color:#8090c0;}
.sk.act .sk-label{color:#6080c0;}
.sk.act .sk-val{  color:#a0c0f0;}

/* ‚îÄ‚îÄ Numpad ‚îÄ‚îÄ */
.e-numpad{
  flex-shrink:0;display:grid;grid-template-columns:repeat(5,1fr);
  background:#080810;border-top:1px solid #1a1a28;
}
.np{
  height:38px;display:flex;flex-direction:column;align-items:center;justify-content:center;
  border-right:1px solid #111118;border-bottom:1px solid #111118;
  cursor:pointer;user-select:none;-webkit-user-select:none;gap:1px;
  transition:background .08s;
}
.np:active{background:#1a1a28;}
.np-main{font-size:14px;font-weight:700;color:#9090b0;}
.np-sub{ font-size:8px;color:#404060;letter-spacing:.3px;}
.np.act .np-main{color:#a0c0f0;}
.np.act .np-sub{ color:#5070a0;}

/* ‚îÄ‚îÄ Eingabe-Overlay (Zugnummer etc.) ‚îÄ‚îÄ */
.input-ov{
  position:fixed;inset:0;background:#000000c0;z-index:500;
  display:flex;align-items:center;justify-content:center;
}
.input-box{
  background:#0d0d18;border:1px solid var(--pri2);border-radius:4px;
  padding:20px 24px;min-width:240px;
}
.input-title{font-size:13px;color:#8090c0;margin-bottom:8px;letter-spacing:1px;}
.input-val{
  font-size:22px;font-weight:700;color:#d0d8f0;
  min-height:36px;border-bottom:2px solid var(--pri2);padding-bottom:4px;
  margin-bottom:12px;letter-spacing:2px;
}
.input-hint{font-size:10px;color:var(--dim);line-height:1.6;}

/* ‚îÄ‚îÄ Streckenauswahl-Overlay ‚îÄ‚îÄ */
.route-ov{
  position:fixed;inset:0;background:#000000c0;z-index:500;
  display:flex;flex-direction:column;
}
.route-box{
  background:#0d0d18;border:1px solid var(--pri2);
  flex:1;overflow-y:auto;
}
.route-head{
  padding:14px 16px;border-bottom:1px solid #1a1a28;
  font-size:12px;color:#7080b0;letter-spacing:1px;
}
.route-item{
  padding:12px 16px;border-bottom:1px solid #111118;cursor:pointer;
  display:flex;flex-direction:column;gap:3px;
}
.route-item:active{background:#1a1a28;}
.route-name{font-size:13px;font-weight:600;color:#d0d0e0;}
.route-sub{ font-size:10px;color:var(--dim);}
.route-tts{padding:6px 16px 12px 28px;}
.tt-item{
  padding:8px 10px;margin-bottom:4px;border-radius:3px;cursor:pointer;
  background:#0a0a14;border:1px solid #1a1a28;
  display:flex;align-items:center;gap:8px;
}
.tt-item:active{background:#181828;}
.tt-nr{font-size:12px;font-weight:700;color:#a0c0e0;width:80px;}
.tt-name{font-size:11px;color:var(--dim);}
.route-close{
  flex-shrink:0;padding:12px 16px;background:#080810;border-top:1px solid #1a1a28;
  font-size:11px;color:#5060a0;text-align:center;cursor:pointer;
}

/* ‚îÄ‚îÄ Nachtmodus ‚îÄ‚îÄ */
.ebula.night{filter:brightness(calc(var(--brightness) * 0.4)) contrast(var(--contrast)) sepia(.3);}
</style>
</head>
<body>
<div id="splash" style="position:fixed;inset:0;background:#050508;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;font-family:'IBM Plex Mono',monospace;">
  <div style="font-size:18px;font-weight:700;color:#3a7ec4;letter-spacing:4px;">CCMC&#x2122; Web EBuLa</div>
  <div style="font-size:9px;color:#1a3050;letter-spacing:3px;">powered by CraftCraftMine Netzwerk&#x2122;</div>
  <div style="margin-top:20px;width:60px;height:1px;background:linear-gradient(90deg,transparent,#3a7ec4,transparent);animation:sl 1.4s ease-in-out infinite;"></div>
</div>
<style>@keyframes sl{0%,100%{opacity:.15}50%{opacity:1}}</style>
<script>window.addEventListener('load',function(){setTimeout(function(){var s=document.getElementById('splash');if(!s)return;s.style.transition='opacity .6s';s.style.opacity='0';setTimeout(function(){s.remove();},650);},800);});</script>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

/* ‚îÄ‚îÄ Konstanten ‚îÄ‚îÄ */
const MARKER_OFFSET = 0.38; // Raute bei 38% von oben

/* ‚îÄ‚îÄ Hilfsfunktionen ‚îÄ‚îÄ */
function fmtKm(k) {
  if (k == null) return '';
  return k.toFixed(1);
}
function fmtTime(t) {
  if (!t) return '';
  const p = t.split(':');
  return p.length >= 2 ? p[0]+':'+p[1] : t;
}
function fmtTimeFull(t) { return t ? t.slice(0,5) : ''; }
function nowTime() {
  const d = new Date();
  return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+':'+String(d.getSeconds()).padStart(2,'0');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Haupt-Komponente: EBuLa
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function EBuLa() {
  /* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
  const [route,    setRoute]    = useState(null);
  const [tt,       setTT]       = useState(null);    // aktiver Fahrplan
  const [time,     setTime]     = useState(nowTime());
  const [running,  setRunning]  = useState(false);
  const [bright,   setBright]   = useState(1.0);
  const [night,    setNight]    = useState(false);
  const [gw,       setGw]       = useState('r');     // r=Regelgleis, l=Gegengleis
  const [showRoutes, setShowRoutes] = useState(false);
  const [openRoute,  setOpenRoute]  = useState(null); // expanded route in picker
  const [inputMode,  setInputMode]  = useState(null); // 'zug'|'offset'|null
  const [inputVal,   setInputVal]   = useState('');
  const [offset,     setOffset]     = useState(0);

  const bfpRef   = useRef(null);
  const wrapRef  = useRef(null);
  const allRoutes = DB.get();

  /* ‚îÄ‚îÄ Uhr ‚îÄ‚îÄ */
  useEffect(() => {
    if (!running) return;
    const iv = setInterval(() => setTime(nowTime()), 1000);
    return () => clearInterval(iv);
  }, [running]);

  /* ‚îÄ‚îÄ Route aus URL-Hash laden ‚îÄ‚îÄ */
  useEffect(() => {
    const hash = decodeURIComponent(window.location.hash.replace('#',''));
    if (!hash) return;
    const r = DB.getByName(hash) || DB.get().find(r2 =>
      r2.name.toLowerCase().replace(/\s+/g,'-') === hash
    );
    if (!r) return;
    setRoute(r);
    // Zuletzt gew√§hlten Fahrplan laden
    const ttId = DB.getActiveTTId(r.id);
    if (ttId) {
      const found = (r.timetables||[]).find(t => t.id === ttId);
      if (found) setTT(found);
    } else if ((r.timetables||[]).length > 0) {
      setTT(r.timetables[0]);
    }
  }, []);

  /* ‚îÄ‚îÄ Berechnungen ‚îÄ‚îÄ */
  const items  = route ? [...(route.objects||[])].sort((a,b) => a.km - b.km) : [];
  const served = tt ? (tt.stops||[]).filter(s => s.served !== false) : [];

  const curKm = (route && tt)
    ? calcKm(time, { ...tt, startKm: route.startKm, offset }, served)
    : null;

  const vmax = (route && items.length)
    ? calcCurrentVmax(items, curKm || route.startKm)
    : null;

  const nextStop = (tt && curKm !== null)
    ? findNextStop(served, curKm, tt.richtung || 1)
    : null;

  /* ‚îÄ‚îÄ BFP-Scroll: Raute bleibt bei MARKER_OFFSET von oben ‚îÄ‚îÄ */
  // In echter EBuLa: Zukunft oben, Vergangenheit unten ‚Üí Streifen scrollt nach oben
  // ‚Üí Items sind von oben nach unten nach km sortiert;
  //   wir brauchen den px-Offset des current-Items und scrollen so dass
  //   dieser Punkt bei MARKER_OFFSET*wrapHeight liegt.

  function calcItemTop(items2, targetKm) {
    let top = 0;
    for (const item of items2) {
      const h = item.type === 'STATION' ? STA_H : ROW_H;
      if (item.km >= targetKm) {
        // Interpoliere innerhalb des Segments
        const prev = items2[items2.indexOf(item) - 1];
        if (prev) {
          const ratio = (targetKm - prev.km) / (item.km - prev.km);
          return top - (prev.type === 'STATION' ? STA_H : ROW_H) * ratio;
        }
        return top;
      }
      top += h;
    }
    return top;
  }

  useEffect(() => {
    if (!wrapRef.current || !bfpRef.current || curKm === null || !items.length) return;
    const wh = wrapRef.current.clientHeight;
    const markerY = wh * MARKER_OFFSET;
    const itemTop = calcItemTop(items, curKm);
    const scrollTop = itemTop - markerY;
    bfpRef.current.style.transform = `translateY(${-scrollTop}px)`;
  }, [curKm, items, time]);

  /* ‚îÄ‚îÄ Numpad-Kontext ‚îÄ‚îÄ */
  // Im Grundbild: Softkeys (Zug, FSD, GW, -, +, *, Offset, -, St, UD)
  // Im Eingabe-Modus: 1-9, 0 = echte Ziffern; E=Enter, C=Clear

  function handleNumpad(key) {
    if (inputMode) {
      // Ziffern-Modus
      if (key >= '0' && key <= '9') setInputVal(v => v + key);
      else if (key === 'C') setInputVal('');
      else if (key === 'E') confirmInput();
      return;
    }
    // Softkey-Modus
    switch(key) {
      case '1': openZugInput(); break;
      case '2': /* FSD ‚Äì Fahrplankopf */ break;
      case '3': setGw(g => g==='r'?'l':'r'); break;
      case '4': adjustBright(-0.1); break;
      case '5': adjustBright(+0.1); break;
      case '6': setRunning(r => !r); break;
      case '7': setTime(nowTime()); break;
      case '8': openOffsetInput(); break;
      case '9': /* GNT */ break;
      case '0': setNight(n => !n); break;
      default: break;
    }
  }

  function openZugInput() {
    setInputMode('zug');
    setInputVal('');
  }
  function openOffsetInput() {
    setInputMode('offset');
    setInputVal(String(offset));
  }
  function confirmInput() {
    if (inputMode === 'zug') {
      // Zugnummer eingeben ‚Üí passenden Fahrplan suchen
      const nr = inputVal.trim();
      if (route && nr) {
        const found = (route.timetables||[]).find(t =>
          t.zugNummer && t.zugNummer.toLowerCase().replace(/\s+/g,'') === nr.toLowerCase().replace(/\s+/g,'')
        );
        if (found) { setTT(found); DB.setActiveTTId(route.id, found.id); }
        else alert('Zugnummer ' + nr + ' nicht gefunden.');
      }
    } else if (inputMode === 'offset') {
      setOffset(parseFloat(inputVal.replace(',','.')) || 0);
    }
    setInputMode(null);
    setInputVal('');
  }

  function adjustBright(d) {
    setBright(b => Math.min(1.5, Math.max(0.3, Math.round((b+d)*10)/10)));
  }

  /* ‚îÄ‚îÄ Streckenauswahl ‚îÄ‚îÄ */
  function selectTT(r2, tt2) {
    setRoute(r2);
    setTT(tt2);
    DB.setActiveTTId(r2.id, tt2.id);
    window.location.hash = encodeURIComponent(r2.name.toLowerCase().replace(/\s+/g,'-'));
    setShowRoutes(false);
    setOpenRoute(null);
  }

  /* ‚îÄ‚îÄ V-Segment Farbe pro Zeile ‚îÄ‚îÄ */
  function getVSegColor(item, items2) {
    // Finde das zuletzt g√ºltige SPEED/LA vor oder an diesem Punkt
    let cur = null;
    for (const i of items2) {
      if (i.km > item.km + 0.001) break;
      if (i.type === 'SPEED' || i.type === 'LA') cur = i;
    }
    if (!cur) return null;
    return cur.type === 'LA' ? '#b03030' : '#8a7020';
  }

  /* ‚îÄ‚îÄ Render BFP-Zeilen ‚îÄ‚îÄ */
  function renderRows() {
    const rows = [];
    items.forEach((item, idx) => {
      const isSta = item.type === 'STATION';
      const h     = isSta ? STA_H : ROW_H;
      const isPast = curKm !== null && item.km < curKm - 0.05;
      const isCur  = curKm !== null && Math.abs(item.km - curKm) < 0.5;

      // V-Klammer-Farbe
      const vCol = getVSegColor(item, items);

      // Zeiten aus Fahrplan
      const stop = served.find(s => s.sid === item.id);

      // Gleis-S√§ule
      const trackEl = isSta
        ? <div className="track-sta"/>
        : <div className="track-line"/>;

      // V-Wert anzeigen (nur bei SPEED/LA)
      let vDisplay = null;
      if (item.type === 'SPEED' || item.type === 'LA') {
        const col = item.type === 'LA' ? '#c04040' : '#a89020';
        vDisplay = <span style={{color:col,fontSize:10,fontWeight:700}}>{item.speed}</span>;
      }

      // Text je Typ
      let textEl;
      if (isSta) {
        textEl = (
          <div className="col-txt">
            <div className="txt-sta">{item.name}</div>
            {item.notes && <div className="txt-sub">{item.notes}</div>}
          </div>
        );
      } else if (item.type === 'SIGNAL' || item.type === 'TU_S' || item.type === 'TU_E') {
        const T = TYPES[item.type];
        textEl = (
          <div className="col-txt">
            <div className="txt-sig" style={{color:T.clr}}>
              <span style={{fontSize:9,marginRight:4}}>{T.s}</span>
              {item.name || ''}
            </div>
          </div>
        );
      } else if (item.type === 'GRADE') {
        const sign = item.gradient > 0 ? '‚Üó' : item.gradient < 0 ? '‚Üò' : '‚Üí';
        textEl = (
          <div className="col-txt">
            <div className="txt-sub" style={{color:'#308050'}}>{sign} {Math.abs(item.gradient||0)}&permil;</div>
          </div>
        );
      } else {
        textEl = <div className="col-txt"><div className="txt-sub">&nbsp;</div></div>;
      }

      rows.push(
        <div key={item.id}
          className={`bfp-row ${isSta?'sta':'row'}${isPast?' past':''}`}
          style={{height:h, minHeight:h, maxHeight:h}}>
          {/* V-Klammer-Balken */}
          {vCol && <div className="v-bar" style={{background:vCol, opacity:.85}}/>}
          {/* V-Spalte */}
          <div className="col-v" style={{paddingLeft:6}}>{vDisplay}</div>
          {/* km-Spalte */}
          <div className="col-km">{fmtKm(item.km)}</div>
          {/* Grafik-Spalte */}
          <div className="col-g">{trackEl}</div>
          {/* Text */}
          {textEl}
          {/* Ankunft */}
          <div className="col-arr" style={{color: stop?'#a0a8b8':'var(--faint)'}}>
            {stop && stop.arr ? fmtTime(stop.arr) : ''}
          </div>
          {/* Abfahrt */}
          <div className="col-dep" style={{color: stop?'#90b0d8':'var(--faint)'}}>
            {stop && stop.dep ? fmtTime(stop.dep) : ''}
          </div>
        </div>
      );
    });
    return rows;
  }

  /* ‚îÄ‚îÄ Softkey-Labels (kontextsensitiv) ‚îÄ‚îÄ */
  const SK = inputMode ? [
    {l:'',v:''},
    {l:'',v:''},
    {l:'',v:''},
    {l:'C',v:'L√∂schen'},
    {l:'E',v:'Enter'},
  ] : [
    {l:'1',v:'Zug',   act: false},
    {l:'2',v:'FSD',   act: false},
    {l:'3',v:`GW/${gw}`, act: gw==='l'},
    {l:'4/5',v:`‚òÄ ${Math.round(bright*100)}%`, act:false},
    {l:'0',v:night?'üåô':'‚òÄ', act:night},
  ];

  /* ‚îÄ‚îÄ Numpad-Tasten (immer 10, 2 Reihen √† 5) ‚îÄ‚îÄ */
  const NP = inputMode ? [
    {k:'1',m:'1',s:''},{k:'2',m:'2',s:''},{k:'3',m:'3',s:''},{k:'4',m:'4',s:''},{k:'5',m:'5',s:''},
    {k:'6',m:'6',s:''},{k:'7',m:'7',s:''},{k:'8',m:'8',s:''},{k:'9',m:'9',s:''},{k:'0',m:'0',s:''},
  ] : [
    {k:'1',m:'Zug',s:'Auswahl'}, {k:'2',m:'FSD',s:'Kopf'},
    {k:'3',m:'GW',s:gw==='r'?'/r ‚Üí/l':'/l ‚Üí/r'},
    {k:'4',m:'‚òÄ-',s:'Dunkler'}, {k:'5',m:'‚òÄ+',s:'Heller'},
    {k:'6',m:running?'‚è∏':'‚ñ∂',s:running?'Stop':'Start'},
    {k:'7',m:'Zeit',s:'Jetzt'},  {k:'8',m:'Ofs',s:'km-Ofs.'},
    {k:'9',m:'GNT',s:'Bogen'},   {k:'0',m:'üåô',s:'Nacht'},
  ];

  /* ‚îÄ‚îÄ Zug-Auswahl Overlay ‚îÄ‚îÄ */
  const RouteOverlay = () => (
    <div className="route-ov" onClick={e=>e.target.classList.contains('route-ov')&&setShowRoutes(false)}>
      <div className="route-box">
        <div className="route-head">CCMC&#x2122; WEB EBULA ‚Äî STRECKENAUSWAHL</div>
        {allRoutes.length === 0 && (
          <div style={{padding:'20px 16px',color:'var(--dim)',fontSize:12}}>
            Keine Strecken gespeichert. Zuerst auf der Startseite anlegen.
          </div>
        )}
        {allRoutes.map(r2 => (
          <div key={r2.id}>
            <div className="route-item" onClick={()=>setOpenRoute(openRoute===r2.id ? null : r2.id)}>
              <div className="route-name">{r2.name}</div>
              <div className="route-sub">
                km {r2.startKm}‚Äì{r2.endKm} ¬∑ {(r2.timetables||[]).length} Fahrpl√§ne
                {r2.streckenNr ? ` ¬∑ Str. ${r2.streckenNr}` : ''}
              </div>
            </div>
            {openRoute === r2.id && (
              <div className="route-tts">
                {(r2.timetables||[]).length === 0 && (
                  <div style={{fontSize:11,color:'var(--dim)',padding:'6px 0'}}>Keine Fahrpl√§ne ‚Äî erst anlegen</div>
                )}
                {/* Direktstart ohne Fahrplan */}
                <div className="tt-item" onClick={()=>{setRoute(r2);setTT(null);window.location.hash=encodeURIComponent(r2.name.toLowerCase().replace(/\s+/g,'-'));setShowRoutes(false);}}>
                  <span className="tt-nr" style={{color:'var(--dim)'}}>‚Äî Leer ‚Äî</span>
                  <span className="tt-name">Nur Strecke, kein Fahrplan</span>
                </div>
                {(r2.timetables||[]).map(tt2 => (
                  <div key={tt2.id} className="tt-item" onClick={()=>selectTT(r2,tt2)}>
                    <span className="tt-nr">{tt2.zugNummer||tt2.name}</span>
                    <span className="tt-name">{tt2.name} ¬∑ ab {fmtTimeFull(tt2.departure)}</span>
                  </div>
                ))}
              </div>
            )}
          </div>
        ))}
      </div>
      <div className="route-close" onClick={()=>{setShowRoutes(false);setOpenRoute(null);}}>[ C ] Schlie√üen</div>
    </div>
  );

  /* ‚îÄ‚îÄ Eingabe-Overlay ‚îÄ‚îÄ */
  const InputOverlay = () => (
    <div className="input-ov">
      <div className="input-box">
        <div className="input-title">{inputMode==='zug'?'ZUGNUMMER EINGEBEN':'KM-OFFSET'}</div>
        <div className="input-val">{inputVal || '\u2588'}</div>
        <div className="input-hint">
          {inputMode==='zug'
            ? 'Ziffern ‚Üí Zugnummer ¬∑ E = Laden ¬∑ C = L√∂schen'
            : 'Ziffern ‚Üí Offset in km ¬∑ E = √úbernehmen ¬∑ C = Abbrechen'}
        </div>
      </div>
    </div>
  );

  /* ‚îÄ‚îÄ Kein Fahrplan: Leere EBuLa ‚îÄ‚îÄ */
  const noData = !route || items.length === 0;

  /* ‚îÄ‚îÄ Kopfzeile ‚îÄ‚îÄ */
  const headZug    = tt ? (tt.zugNummer || '‚Äî') : '‚Äî';
  const headRoute  = route ? route.name : 'CCMC‚Ñ¢ Web EBuLa';
  const headDate   = new Date().toLocaleDateString('de-DE', {day:'2-digit',month:'2-digit',year:'numeric'});
  const headTime   = time.slice(0,5);

  /* ‚îÄ‚îÄ Vmax-Anzeige ‚îÄ‚îÄ */
  const vmaxCol = vmax
    ? (vmax.type === 'LA' ? '#c04040' : '#a89020')
    : '#303040';

  /* ‚îÄ‚îÄ Render ‚îÄ‚îÄ */
  return (
    <div className={`ebula${night?' night':''}`}
      style={{'--brightness':bright,'--contrast':1}}>

      {/* Kopfzeile */}
      <div className="e-head">
        <div style={{fontWeight:700,color:'#a0c0e0'}}>{headZug}</div>
        <div style={{fontSize:11,color:'#9090b0',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{headRoute}</div>
        <div style={{fontSize:11,color:'#606080'}}>{headDate}</div>
        <div style={{fontWeight:700,color:'#c0d0e8'}}>{headTime}</div>
      </div>

      {/* Status oben */}
      <div className="e-status-top">
        <span>
          {curKm !== null
            ? `ab km ${curKm.toFixed(1)}: ${vmax ? vmax.speed+' km/h' : '‚Äî'}`
            : 'Keine Position'}
          {gw === 'l' && <span style={{color:'#c04040',marginLeft:8}}>‚óÄ GEGENGLEIS</span>}
        </span>
        <span style={{color:'var(--pri)'}}>
          {nextStop ? `N√§chster Halt: ${nextStop.name}` : ''}
        </span>
      </div>

      {/* BFP-Streifen */}
      <div className="e-bfp-wrap" ref={wrapRef}>
        {/* Ortsmarke */}
        <div className="e-marker" style={{top:`${MARKER_OFFSET*100}%`}}>
          <div className="e-marker-line"/>
          <div className="e-marker-diamond"/>
        </div>

        {/* Leere EBuLa */}
        {noData && (
          <div style={{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'100%',gap:8,color:'#303040',fontFamily:'var(--mono)'}}>
            <div style={{fontSize:14,letterSpacing:2}}>CCMC&#x2122; WEB EBULA</div>
            <div style={{fontSize:10,color:'#222230'}}>Taste 1 = Strecke &amp; Zug w√§hlen</div>
          </div>
        )}

        {/* BFP-Inhalt */}
        {!noData && (
          <div className="e-bfp" ref={bfpRef}
            style={{paddingTop: `${MARKER_OFFSET * (wrapRef.current?.clientHeight || 300)}px`}}>
            {renderRows()}
            <div style={{height:200}}/>{/* Puffer unten */}
          </div>
        )}
      </div>

      {/* Geschwindigkeitswiederholung */}
      <div className="e-vmax">
        <span className="e-vmax-label">Vmax</span>
        <span className="e-vmax-val" style={{
          color: vmax ? vmaxCol : '#303040',
          background: vmax ? vmaxCol+'18' : 'transparent',
          border: `1px solid ${vmax ? vmaxCol+'44' : '#1a1a28'}`,
        }}>
          {vmax ? vmax.speed : '‚Äî'}
        </span>
        {vmax && <span className="e-vmax-tag">km/h{vmax.type==='LA'?' (La)':''}</span>}
        <span style={{marginLeft:'auto',fontSize:10,color:'var(--dim)'}}>
          {running ? '‚ñ∂ l√§uft' : '‚è∏ gestoppt'}
          {offset !== 0 && ` ¬∑ ofs ${offset>0?'+':''}${offset} km`}
        </span>
      </div>

      {/* Status unten */}
      <div className="e-status-bot">
        <span>Zeit</span>
        <span>GW /{gw}</span>
        <span>{route?.streckenNr ? 'Str. '+route.streckenNr : 'CCMC‚Ñ¢'}</span>
        <span style={{color:'#3a4060'}}>+0.0 min</span>
        <span style={{marginLeft:'auto',color:'#2a3050'}}>support@craftcraftmine.net</span>
      </div>

      {/* Softkeys */}
      <div className="e-softkeys">
        {SK.map((s,i) => (
          <div key={i} className={`sk${s.act?' act':''}`} onClick={()=>handleNumpad(s.l)}>
            <div className="sk-label">{s.l}</div>
            <div className="sk-val">{s.v}</div>
          </div>
        ))}
        {/* Strecken-Button extra */}
        <div className="sk" style={{background:'#0c0c1a',borderLeft:'1px solid #1a1a28'}}
          onClick={()=>setShowRoutes(true)}>
          <div className="sk-label">STR</div>
          <div className="sk-val" style={{fontSize:9}}>Strecke</div>
        </div>
        <div className="sk" style={{background:'#0c0c1a'}} onClick={()=>window.location.href='../'}>
          <div className="sk-label">‚Üê</div>
          <div className="sk-val" style={{fontSize:9}}>Home</div>
        </div>
      </div>

      {/* Numpad */}
      <div className="e-numpad">
        {NP.map((n,i) => (
          <div key={i} className="np" onClick={()=>handleNumpad(n.k)}>
            <div className="np-main">{n.m}</div>
            <div className="np-sub">{n.s}</div>
          </div>
        ))}
      </div>

      {/* Overlays */}
      {showRoutes && <RouteOverlay/>}
      {inputMode  && <InputOverlay/>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<EBuLa/>);
</script>
</body>
</html>
