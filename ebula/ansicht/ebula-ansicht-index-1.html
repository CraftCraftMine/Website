<!--
  Project:     CCMC™ Web EBuLa
  Part of:     CraftCraftMine Netzwerk™ (CCMN™)
  Copyright:   (c) 2026 CraftCraftMine Netzwerk™ – All rights reserved.
  Support:     support@craftcraftmine.net
-->
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>CCMC™ Web EBuLa</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="../shared/types.js"></script>
<script src="../shared/db.js"></script>
<script src="../shared/calc.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
/* ===== RESET ===== */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body,#root{height:100%;overflow:hidden;}
body{background:#1e1e1e;font-family:'IBM Plex Mono',monospace;}

/* ===== SPLASH ===== */
#splash{position:fixed;inset:0;background:#050508;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;font-family:'IBM Plex Mono',monospace;}
@keyframes sl{0%,100%{opacity:.15}50%{opacity:1}}

/* ===== GERÄT-GEHÄUSE ===== */
.device{
  display:flex;flex-direction:column;height:100dvh;
  background:#2a2a2c;
  background-image:radial-gradient(ellipse at 50% 30%,#323234 0%,#262628 100%);
}

/* ===== HARDWARE-KNOPF BASIS ===== */
.hw{
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(180deg,#4a4a4c 0%,#3a3a3c 60%,#323234 100%);
  border:1px solid #555;
  border-bottom:2px solid #1a1a1c;
  border-right:2px solid #1a1a1c;
  border-radius:5px;
  color:#d0d0d8;
  font-family:'IBM Plex Mono',monospace;
  font-size:11px;font-weight:600;
  cursor:pointer;user-select:none;-webkit-user-select:none;
  box-shadow:0 2px 4px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.08);
  transition:transform .05s,box-shadow .05s;
  white-space:nowrap;letter-spacing:.3px;
}
.hw:active{
  transform:translateY(1px);
  box-shadow:0 1px 2px rgba(0,0,0,.5),inset 0 2px 4px rgba(0,0,0,.4);
  border-bottom-width:1px;border-right-width:1px;
}
.hw.on{
  background:linear-gradient(180deg,#1e3a6a 0%,#162e54 100%);
  color:#80b8f8;border-color:#2a52a0;
  box-shadow:0 0 6px rgba(60,120,220,.3),inset 0 1px 0 rgba(255,255,255,.05);
}
.hw.warn{
  background:linear-gradient(180deg,#5a2020 0%,#421818 100%);
  color:#f08080;border-color:#803030;
}

/* ===== OBERE KNOPFREIHE ===== */
.top-btns{
  flex-shrink:0;display:flex;align-items:center;gap:5px;
  padding:7px 8px 6px;
  border-bottom:2px solid #1a1a1c;
}
.top-btns .hw{height:34px;min-width:34px;padding:0 7px;font-size:10px;}
.top-btns .hw.wide{min-width:52px;}
.top-btns .hw.xwide{min-width:68px;font-size:10px;}
.top-spacer{flex:1;}

/* ===== MITTLERER BEREICH: Display + rechte Knöpfe ===== */
.mid-row{
  flex:1;display:flex;overflow:hidden;
  padding:0 6px 0 8px;
}

/* ===== DISPLAY-EINFASSUNG ===== */
.d-bezel{
  flex:1;
  background:#111114;
  border:3px solid #111114;
  border-radius:3px;
  box-shadow:inset 0 2px 12px rgba(0,0,0,.9),0 1px 0 rgba(255,255,255,.04);
  overflow:hidden;
  display:flex;flex-direction:column;
  margin:4px 0;
}

/* ===== DISPLAY-INHALT ===== */
.display{
  flex:1;display:flex;flex-direction:column;overflow:hidden;
  background:#f0ede6;color:#111114;
  transition:background .2s,color .2s;
}
.display.dark{background:#080b0e;color:#b8ccd8;}
.display.off{background:#050508!important;color:#050508!important;}

/* Display Kopfzeile */
.d-head{
  flex-shrink:0;display:grid;
  grid-template-columns:64px 1fr 88px 70px;
  border-bottom:2px solid currentColor;
  font-size:12px;font-weight:700;
}
.d-head>div{
  padding:3px 5px;border-right:1px solid currentColor;
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;white-space:nowrap;text-overflow:ellipsis;
}
.d-head>div:last-child{border-right:none;}

/* Status oben */
.d-st-top{
  flex-shrink:0;display:flex;justify-content:space-between;align-items:center;
  padding:1px 6px;border-bottom:1px solid currentColor;
  font-size:10px;opacity:.75;
}

/* BFP Scrollbereich */
.d-bfp-outer{
  flex:1;overflow:hidden;position:relative;
}
.d-bfp-inner{
  position:absolute;width:100%;
  will-change:transform;
}

/* Ortsmarke */
.d-marker{
  position:absolute;left:0;right:0;pointer-events:none;z-index:10;
}
.d-marker-line{
  position:absolute;left:0;right:0;height:1px;
  background:#e8b800;opacity:.8;
}
.d-marker-diam{
  position:absolute;right:6px;
  width:9px;height:9px;
  background:#e8b800;
  transform:translateY(-50%) rotate(45deg);
  box-shadow:0 0 5px #e8b80099;
}

/* BFP Zeilen */
.brow{
  display:flex;align-items:stretch;
  border-bottom:1px solid;
  position:relative;min-height:26px;
}
.display:not(.dark) .brow{border-color:#ccc;}
.display.dark .brow{border-color:#1a2028;}
.brow.sta{min-height:48px;font-weight:700;}
.brow.past{opacity:.4;}
.brow.cur{background:rgba(232,184,0,.08);}

/* Spalten */
.c-v{  width:34px;flex-shrink:0;display:flex;align-items:flex-start;justify-content:flex-end;padding:3px 3px 0;font-size:11px;font-weight:700;}
.c-km{ width:44px;flex-shrink:0;display:flex;align-items:center;justify-content:flex-end;padding-right:5px;font-size:10px;opacity:.7;}
.c-g{  width:10px;flex-shrink:0;position:relative;display:flex;justify-content:center;}
.c-txt{flex:1;display:flex;flex-direction:column;justify-content:center;padding:3px 6px;min-width:0;}
.c-arr{width:44px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:10px;}
.c-dep{width:44px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:10px;}

/* Gleis-Grafik */
.g-line{width:2px;background:#aaa;position:absolute;top:0;bottom:0;left:50%;transform:translateX(-50%);}
.display.dark .g-line{background:#445;}
.g-sta{ width:5px;background:#555;position:absolute;top:0;bottom:0;left:50%;transform:translateX(-50%);}
.display.dark .g-sta{background:#8090a8;}

/* V-Balken links */
.v-bar{position:absolute;left:0;top:0;bottom:0;width:3px;}

/* Text */
.t-sta{font-size:13px;font-weight:700;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.t-sub{font-size:9px;opacity:.6;margin-top:1px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}

/* Störungsbalken */
.d-stoer{
  flex-shrink:0;padding:1px 6px;
  background:#b02020;color:#fff;
  font-size:9px;font-weight:700;letter-spacing:.5px;
  border-bottom:1px solid #800000;
}

/* Vmax-Wiederholung */
.d-vmax{
  flex-shrink:0;display:flex;align-items:center;
  border-top:1px solid;padding:1px 6px;gap:6px;
}
.display:not(.dark) .d-vmax{border-color:#ccc;}
.display.dark .d-vmax{border-color:#1a2028;}
.vmax-val{
  font-size:18px;font-weight:700;min-width:44px;text-align:right;
  padding-right:3px;
}
.vmax-unit{font-size:9px;opacity:.6;}

/* Status unten */
.d-st-bot{
  flex-shrink:0;display:flex;justify-content:space-between;
  padding:1px 6px;border-top:1px solid;
  font-size:9px;opacity:.6;
}
.display:not(.dark) .d-st-bot{border-color:#ccc;}
.display.dark .d-st-bot{border-color:#1a2028;}

/* Softkey-Labels im Display */
.d-sk-labels{
  flex-shrink:0;display:flex;
  border-top:2px solid currentColor;
}
.d-sk-label{
  flex:1;text-align:center;padding:2px 0;font-size:9px;font-weight:700;
  border-right:1px solid currentColor;letter-spacing:.3px;
  overflow:hidden;white-space:nowrap;
}
.d-sk-label:last-child{border-right:none;}

/* ===== RECHTE KNÖPFE ===== */
.right-btns{
  flex-shrink:0;display:flex;flex-direction:column;
  gap:4px;padding:4px 0 4px 6px;
  width:44px;
}
.right-btns .hw{flex:1;width:36px;font-size:13px;}
.right-btns .hw.C-btn{font-size:14px;font-weight:700;}
.right-btns .hw.E-btn{font-size:14px;font-weight:700;background:linear-gradient(180deg,#1a4a1a 0%,#123212 100%);color:#60d060;border-color:#1a5a1a;}

/* ===== SOFTKEY REIHE ===== */
.sk-row{
  flex-shrink:0;display:flex;
  padding:5px 8px 4px;gap:4px;
  border-top:2px solid #1a1a1c;
}
.sk-row .hw{flex:1;height:32px;font-size:9px;padding:0 2px;letter-spacing:.2px;}
.sk-row .hw.empty{opacity:.25;pointer-events:none;}

/* ===== NUMPAD ===== */
.numpad{
  flex-shrink:0;display:grid;grid-template-columns:repeat(5,1fr);
  gap:4px;padding:0 8px 7px;
}
.numpad .hw{height:34px;font-size:14px;font-weight:700;}

/* ===== OVERLAYS ===== */
.ov-bg{
  position:fixed;inset:0;background:#000000c0;z-index:500;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
}
.ov-box{
  background:#0d0f14;border:1px solid #3a5a8a;border-radius:4px;
  padding:16px 20px;min-width:220px;max-width:90vw;
  font-family:'IBM Plex Mono',monospace;
}
.ov-title{font-size:11px;color:#5080b0;letter-spacing:1px;margin-bottom:8px;}
.ov-val{
  font-size:22px;font-weight:700;color:#c0d8f0;
  min-height:34px;border-bottom:2px solid #3a5a8a;
  padding-bottom:4px;margin-bottom:10px;letter-spacing:2px;
}
.ov-hint{font-size:9px;color:#404860;line-height:1.7;}

/* Streckenauswahl */
.rte-ov{position:fixed;inset:0;background:#000000d0;z-index:500;display:flex;flex-direction:column;}
.rte-box{flex:1;overflow-y:auto;background:#080b10;}
.rte-head{padding:10px 14px;border-bottom:1px solid #1a2030;font-size:10px;color:#405080;letter-spacing:1px;}
.rte-item{padding:10px 14px;border-bottom:1px solid #0f1520;cursor:pointer;}
.rte-item:active{background:#1a2030;}
.rte-name{font-size:13px;font-weight:700;color:#c0ccd8;}
.rte-sub{font-size:10px;color:#405060;margin-top:2px;}
.rte-tts{padding:4px 14px 10px 26px;}
.tt-item{
  display:flex;align-items:center;gap:8px;
  padding:7px 10px;margin-bottom:3px;
  border-radius:3px;cursor:pointer;
  background:#0d1018;border:1px solid #1a2030;
}
.tt-item:active{background:#1a2030;}
.tt-nr{font-size:12px;font-weight:700;color:#80b0e0;width:72px;flex-shrink:0;}
.tt-nm{font-size:10px;color:#405060;}
.rte-close{flex-shrink:0;padding:10px;background:#060810;border-top:1px solid #1a2030;text-align:center;font-size:10px;color:#304050;cursor:pointer;}
</style>
</head>
<body>
<div id="splash">
  <div style="font-size:18px;font-weight:700;color:#3a7ec4;letter-spacing:4px;">CCMC™ Web EBuLa</div>
  <div style="font-size:9px;color:#1a3050;letter-spacing:3px;">powered by CraftCraftMine Netzwerk™</div>
  <div style="margin-top:18px;width:60px;height:1px;background:linear-gradient(90deg,transparent,#3a7ec4,transparent);animation:sl 1.4s ease-in-out infinite;"></div>
</div>
<style>@keyframes sl{0%,100%{opacity:.1}50%{opacity:1}}</style>
<script>window.addEventListener('load',function(){setTimeout(function(){var s=document.getElementById('splash');if(!s)return;s.style.transition='opacity .6s';s.style.opacity='0';setTimeout(function(){s.remove();},650);},800);});</script>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* Marker-Position innerhalb des BFP-Bereichs (von oben) */
const MARKER_POS = 0.40;

/* Hilfsfunktionen */
const fmtKm  = k => k == null ? '' : k.toFixed(1);
const fmtT   = t => t ? t.slice(0,5) : '';
const nowStr = () => {
  const d = new Date();
  return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+':'+String(d.getSeconds()).padStart(2,'0');
};

/* Akkumulierten Pixel-Offset für ein km-Wert berechnen */
function kmToPx(items, targetKm) {
  let top = 0;
  for (let i = 0; i < items.length; i++) {
    const item = items[i];
    const h = item.type === 'STATION' ? STA_H : ROW_H;
    const next = items[i+1];
    if (!next || targetKm <= item.km + 0.001) {
      return top;
    }
    if (targetKm < next.km) {
      const ratio = (targetKm - item.km) / (next.km - item.km);
      return top + ratio * h;
    }
    top += h;
  }
  return top;
}

/* Aktuelle Vmax an Position curKm */
function getVmax(items, curKm) {
  let cur = null;
  for (const i of items) {
    if (i.km > curKm + 0.05) break;
    if (i.type === 'SPEED' || i.type === 'LA') {
      if (i.type === 'LA' && i.speedEnd != null && curKm > i.speedEnd + 0.05) continue;
      cur = i;
    }
  }
  return cur;
}

/* ============================================================
   Haupt-Komponente
   ============================================================ */
function EBuLa() {
  const [route,       setRoute]      = useState(null);
  const [tt,          setTT]         = useState(null);
  const [time,        setTime]       = useState(nowStr());
  const [running,     setRunning]    = useState(false);
  const [darkMode,    setDarkMode]   = useState(true);   /* Standard: dunkel */
  const [dispOff,     setDispOff]    = useState(false);
  const [gw,          setGw]         = useState('r');
  const [stoerung,    setStoerung]   = useState('');
  const [offset,      setOffset]     = useState(0);
  const [manOfs,      setManOfs]     = useState(0);     /* manueller Scroll-Offset in px */
  const [inputMode,   setInputMode]  = useState(null);  /* 'zug'|'zeit'|'stoer'|'offset' */
  const [inputVal,    setInputVal]   = useState('');
  const [showRoutes,  setShowRoutes] = useState(false);
  const [openRouteId, setOpenRouteId]= useState(null);

  const bfpRef  = useRef(null);
  const wrapRef = useRef(null);
  const allRoutes = DB.get();

  /* Uhr */
  useEffect(() => {
    if (!running) return;
    const iv = setInterval(() => setTime(nowStr()), 1000);
    return () => clearInterval(iv);
  }, [running]);

  /* Route aus URL-Hash laden */
  useEffect(() => {
    const hash = decodeURIComponent(window.location.hash.replace('#',''));
    if (!hash) return;
    const r = DB.getByName(hash);
    if (!r) return;
    setRoute(r);
    const ttId = DB.getActiveTTId(r.id);
    const found = (r.timetables||[]).find(t => t.id === ttId) || (r.timetables||[])[0] || null;
    if (found) setTT(found);
  }, []);

  /* Berechnungen */
  const items  = route ? [...(route.objects||[])].sort((a,b) => a.km - b.km) : [];
  const served = tt ? (tt.stops||[]).filter(s => s.served !== false) : [];
  const curKm  = (route && tt) ? calcKm(time, {...tt, startKm: route.startKm, offset}, served) : null;
  const vmaxObj = items.length && curKm != null ? getVmax(items, curKm) : null;
  const nextStop = curKm != null ? findNextStop(served, curKm, tt?.richtung||1) : null;

  /* BFP scrollen */
  useEffect(() => {
    if (!wrapRef.current || !bfpRef.current || curKm == null || !items.length) return;
    const wh = wrapRef.current.clientHeight;
    const markerY = wh * MARKER_POS;
    const itemPx  = kmToPx(items, curKm);
    const ty = markerY - itemPx + manOfs;
    bfpRef.current.style.transform = `translateY(${ty}px)`;
  }, [curKm, items, time, manOfs]);

  /* ---- Knopf-Handler ---- */
  const handleNumpad = key => {
    if (inputMode) {
      if (key >= '0' && key <= '9') { setInputVal(v => v + key); return; }
      if (key === 'C') { setInputVal(''); return; }
      if (key === 'E') { confirmInput(); return; }
      return;
    }
    /* Softkey-Modus */
    switch(key) {
      case 'ZUG':  openInput('zug');    break;
      case 'FSD':  /* Fahrplankopf - nur anzeigen, kein Overlay */ break;
      case 'GW':   setGw(g => g==='r'?'l':'r'); break;
      case 'ZEIT': openInput('zeit');   break;
      case 'GNT':  break;
      case 'G':    break;
      case '1': openInput('zug');   break;
      case '2': /* FSD */           break;
      case '3': setGw(g=>g==='r'?'l':'r'); break;
      case '4': /* - */ break;
      case '5': /* + */ break;
      case '6': setRunning(r=>!r); break;
      case '7': openInput('zeit'); break;
      case '8': openInput('offset'); break;
      case '9': break;
      case '0': break;
      default: break;
    }
  };

  const handleTop = key => {
    switch(key) {
      case 'AUS': setDispOff(d=>!d); break;
      case 'ST':  openInput('stoer'); break;
      case '-5S': setTime(t => { const s=timeToSec(t); return s!=null?secToTime(s-5):t; }); break;
      case '+5S': setTime(t => { const s=timeToSec(t); return s!=null?secToTime(s+5):t; }); break;
      case 'KONTRAST': setDarkMode(d=>!d); break;
      case 'UD': setGw(g=>g==='r'?'l':'r'); break;
      default: break;
    }
  };

  const handleRight = key => {
    switch(key) {
      case 'C': setInputVal(''); setInputMode(null); break;
      case 'UP':   setManOfs(o=>o+60); break;
      case 'DOWN': setManOfs(o=>o-60); break;
      case 'LEFT': setManOfs(o=>o+200); break;
      case 'RIGHT':setManOfs(o=>o-200); break;
      case 'E': confirmInput(); break;
      default: break;
    }
  };

  const openInput = mode => { setInputMode(mode); setInputVal(mode==='offset'?String(offset):''); };

  const confirmInput = () => {
    if (inputMode === 'zug') {
      if (route && inputVal.trim()) {
        const nr = inputVal.trim().toLowerCase().replace(/\s+/g,'');
        const found = (route.timetables||[]).find(t =>
          (t.zugNummer||'').toLowerCase().replace(/\s+/g,'') === nr
        );
        if (found) { setTT(found); DB.setActiveTTId(route.id, found.id); }
        else { alert('Zug ' + inputVal + ' nicht gefunden'); }
      }
    } else if (inputMode === 'zeit') {
      if (inputVal.length >= 4) {
        const h = inputVal.slice(0,2), m = inputVal.slice(2,4), s2 = inputVal.slice(4,6)||'00';
        setTime(`${h}:${m}:${s2}`);
      }
    } else if (inputMode === 'stoer') {
      setStoerung(inputVal.trim());
    } else if (inputMode === 'offset') {
      setOffset(parseFloat(inputVal.replace(',','.')) || 0);
      setManOfs(0);
    }
    setInputMode(null); setInputVal('');
  };

  /* Strecke wählen */
  const selectTT = (r2, tt2) => {
    setRoute(r2); setTT(tt2);
    if (tt2) DB.setActiveTTId(r2.id, tt2.id);
    window.location.hash = encodeURIComponent(r2.name.toLowerCase().replace(/\s+/g,'-'));
    setShowRoutes(false); setOpenRouteId(null); setManOfs(0);
  };

  /* ---- BFP Zeilen rendern ---- */
  const renderBFP = () => {
    if (!items.length) return (
      <div style={{padding:'20px',textAlign:'center',opacity:.3,fontSize:12}}>
        Keine Strecke — Taste 1 / Zug
      </div>
    );
    return items.map((item, idx) => {
      const isSta  = item.type === 'STATION';
      const h      = isSta ? STA_H : ROW_H;
      const isPast = curKm != null && item.km < curKm - 0.1;
      const isCur  = curKm != null && Math.abs(item.km - curKm) < 0.8;
      const stop   = served.find(s => s.sid === item.id);

      /* V-Klammer Farbe */
      let vCol = null, vVal = null;
      if (item.type === 'SPEED') { vCol = '#a88010'; vVal = item.speed; }
      if (item.type === 'LA')    { vCol = '#b02020'; vVal = item.speed; }

      /* Laufende V-Farbe für den Balken */
      const runV = getVmax(items, item.km);
      const barCol = runV ? (runV.type==='LA'?'#b02020':'#a88010') : null;

      /* Gleis-Element */
      const trackEl = isSta
        ? <div className="g-sta"/>
        : <div className="g-line"/>;

      /* Text */
      let content;
      if (isSta) {
        content = <>
          <div className="t-sta">{item.name}</div>
          {item.notes && <div className="t-sub">{item.notes}</div>}
        </>;
      } else if (item.type==='SIGNAL'||item.type==='TU_S'||item.type==='TU_E') {
        const T = TYPES[item.type];
        content = <div className="t-sub" style={{color: T.clr, fontSize:10}}>
          <b>{T.s}</b>{item.name ? ' '+item.name : ''}
        </div>;
      } else if (item.type==='GRADE') {
        const s2 = item.gradient>0?'↗':item.gradient<0?'↘':'→';
        content = <div className="t-sub" style={{color:'#308050'}}>{s2} {Math.abs(item.gradient||0)}‰</div>;
      } else if (item.type==='BUE') {
        content = <div className="t-sub" style={{color:'#904820'}}>⊥BÜ{item.name?' '+item.name:''}</div>;
      } else {
        content = null;
      }

      return (
        <div key={item.id}
          className={`brow${isSta?' sta':''}${isPast?' past':''}${isCur?' cur':''}`}
          style={{height:h, minHeight:h, maxHeight:h}}>
          {barCol && <div className="v-bar" style={{background:barCol}}/>}
          <div className="c-v">{vVal != null && <span style={{color:vCol}}>{vVal}</span>}</div>
          <div className="c-km">{fmtKm(item.km)}</div>
          <div className="c-g">{trackEl}</div>
          <div className="c-txt">{content}</div>
          <div className="c-arr" style={{opacity: stop&&stop.arr?1:.15}}>
            {stop && stop.arr ? fmtT(stop.arr) : ''}
          </div>
          <div className="c-dep" style={{opacity: stop&&stop.dep?1:.15, color: darkMode?'#80a8d0':'#2050a0'}}>
            {stop && stop.dep ? fmtT(stop.dep) : ''}
          </div>
        </div>
      );
    });
  };

  /* ---- Softkey Labels im Display ---- */
  const skLabels = inputMode
    ? ['', 'C', '', 'E', '', '', '', '']
    : ['Zug', 'FSD', '', 'GW', 'Zeit', '', 'GNT', 'G'];

  /* ---- Softkey Buttons Beschriftung ---- */
  const skBtns = inputMode
    ? [{k:'ZUG',l:''},{k:'FSD',l:'C ←'},{k:'GW',l:''},{k:'ZEIT',l:'E ⏎'},{k:'GNT',l:''},{k:'G',l:''},{k:'X1',l:''},{k:'X2',l:''}]
    : [{k:'ZUG',l:'Zug'},{k:'FSD',l:'FSD'},{k:'X1',l:''},
       {k:'GW', l:`GW/${gw}`},{k:'ZEIT',l:'Zeit'},{k:'X2',l:''},
       {k:'GNT',l:'GNT'},{k:'G',l:'G'}];

  /* ---- Numpad ---- */
  const npBtns = inputMode
    ? ['1','2','3','4','5','6','7','8','9','0']
    : ['1','2','3','4','5','6','7','8','9','0'];
  const npSub = inputMode
    ? ['','','','','','','','','','']
    : ['▶','FSD','GW','☆','★','St','Zeit','Ofs','GNT','☽'];

  /* ---- Display-Klassen ---- */
  const dispCls = `display${darkMode?' dark':''}${dispOff?' off':''}`;

  /* ---- Header-Werte ---- */
  const headZug  = tt ? (tt.zugNummer||'—') : '—';
  const headRte  = route ? route.name : 'CCMC™ Web EBuLa';
  const headDate = new Date().toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'}).replace(/\./g,'.');
  const headTime = time.slice(0,8);

  const vmaxVal = vmaxObj ? vmaxObj.speed : null;
  const vmaxCol = vmaxObj ? (vmaxObj.type==='LA'?'#c83030':'#c09000') : (darkMode?'#304050':'#999');

  return (
    <div className="device">

      {/* ===== OBERE KNÖPFE ===== */}
      <div className="top-btns">
        <div className="hw" style={{fontSize:9}} onClick={()=>handleTop('AUS')}>* aus</div>
        <div className="hw" onClick={()=>handleTop('S')}>S</div>
        <div className="hw" style={{fontStyle:'italic'}} onClick={()=>handleTop('I')}>i</div>
        <div className={`hw xwide${stoerung?' warn':''}`} onClick={()=>openInput('stoer')}>
          {stoerung ? '⚠ Stör.' : 'St'}
        </div>
        <div className="hw" onClick={()=>handleTop('-5S')}>-5s</div>
        <div className="hw" onClick={()=>handleTop('+5S')}>+5s</div>
        <div className="hw" onClick={()=>setRunning(r=>!r)}>{running?'⏸':'★'}</div>
        <div className={`hw${darkMode?' on':''}`}
          onClick={()=>handleTop('KONTRAST')}
          title="Hell / Dunkel"
          style={{fontSize:15}}>&#x25d1;</div>
        <div className={`hw${gw==='l'?' on':''}`} onClick={()=>handleTop('UD')}>UD</div>
      </div>

      {/* ===== MITTE: Display + rechte Knöpfe ===== */}
      <div className="mid-row">

        {/* Display-Einfassung */}
        <div className="d-bezel">
          <div className={dispCls}>

            {/* Kopfzeile */}
            <div className="d-head">
              <div style={{fontWeight:700}}>{headZug}</div>
              <div style={{fontSize:11,justifyContent:'flex-start',paddingLeft:8}}>{headRte}</div>
              <div style={{fontSize:11}}>{headDate}</div>
              <div style={{fontWeight:700}}>{headTime}</div>
            </div>

            {/* Status oben */}
            <div className="d-st-top">
              <span>
                {curKm != null ? `ab km ${curKm.toFixed(1)}${vmaxVal?': '+vmaxVal+' km/h':''}` : 'Keine Position'}
                {gw==='l' && <span style={{color:'#c04040',marginLeft:8}}>◀ GG</span>}
              </span>
              <span>{nextStop ? `Nächster Halt: ${nextStop.name}` : ''}</span>
            </div>

            {/* Störungsbalken */}
            {stoerung && (
              <div className="d-stoer">⚠ {stoerung}</div>
            )}

            {/* BFP */}
            <div className="d-bfp-outer" ref={wrapRef}>
              <div className="d-marker" style={{top:`${MARKER_POS*100}%`}}>
                <div className="d-marker-line"/>
                <div className="d-marker-diam"/>
              </div>
              <div className="d-bfp-inner" ref={bfpRef}>
                <div style={{height: wrapRef.current ? wrapRef.current.clientHeight * MARKER_POS : 120}}/>
                {renderBFP()}
                <div style={{height:200}}/>
              </div>
            </div>

            {/* Vmax */}
            <div className="d-vmax">
              <span className="vmax-val" style={{color:vmaxCol}}>{vmaxVal ?? '—'}</span>
              <span className="vmax-unit">km/h{vmaxObj?.type==='LA'?' (La)':''}</span>
              <span style={{marginLeft:'auto',fontSize:9,opacity:.5}}>{running?'▶ läuft':'⏸ gestoppt'}</span>
            </div>

            {/* Status unten */}
            <div className="d-st-bot">
              <span>Zeit</span>
              <span>GW /{gw}</span>
              <span>{route?.streckenNr ? 'Str. '+route.streckenNr : 'CCMC™'}</span>
              <span>+0.0 min</span>
              <span>support@craftcraftmine.net</span>
            </div>

            {/* Softkey-Labels */}
            <div className="d-sk-labels">
              {skLabels.map((l,i) => <div key={i} className="d-sk-label">{l}</div>)}
            </div>

          </div>
        </div>

        {/* Rechte Knöpfe */}
        <div className="right-btns">
          <div className="hw C-btn" onClick={()=>handleRight('C')}>C</div>
          <div className="hw" onClick={()=>handleRight('LEFT')} style={{fontSize:12}}>◄</div>
          <div className="hw" onClick={()=>handleRight('RIGHT')} style={{fontSize:12}}>►</div>
          <div className="hw" onClick={()=>handleRight('UP')} style={{fontSize:12}}>▲</div>
          <div className="hw" onClick={()=>handleRight('DOWN')} style={{fontSize:12}}>▼</div>
          <div className="hw E-btn" onClick={()=>handleRight('E')}>E</div>
        </div>
      </div>

      {/* ===== SOFTKEY-REIHE ===== */}
      <div className="sk-row">
        {skBtns.map((b,i) => (
          <div key={i}
            className={`hw${b.k.startsWith('X')?' empty':''}`}
            onClick={()=>handleNumpad(b.k)}>
            {b.l}
          </div>
        ))}
        <div className="hw" style={{fontSize:9,minWidth:36}} onClick={()=>setShowRoutes(true)}>STR</div>
        <div className="hw" style={{fontSize:9,minWidth:36}} onClick={()=>window.location.href='../'}>Home</div>
      </div>

      {/* ===== NUMPAD ===== */}
      <div className="numpad">
        {npBtns.map((n,i) => (
          <div key={i} className="hw" onClick={()=>handleNumpad(n)}>
            <div>{n}</div>
            {!inputMode && <div style={{fontSize:7,opacity:.45,marginTop:1}}>{npSub[i]}</div>}
          </div>
        ))}
      </div>

      {/* ===== STRECKENAUSWAHL-OVERLAY ===== */}
      {showRoutes && (
        <div className="rte-ov">
          <div className="rte-box">
            <div className="rte-head">CCMC™ WEB EBULA — STRECKENAUSWAHL</div>
            {allRoutes.length===0 && (
              <div style={{padding:'16px',color:'#405060',fontSize:11}}>
                Noch keine Strecken — zuerst auf der Startseite anlegen.
              </div>
            )}
            {allRoutes.map(r2 => (
              <div key={r2.id}>
                <div className="rte-item" onClick={()=>setOpenRouteId(id=>id===r2.id?null:r2.id)}>
                  <div className="rte-name">{r2.name}</div>
                  <div className="rte-sub">km {r2.startKm}–{r2.endKm} · {(r2.timetables||[]).length} Fahrpläne{r2.streckenNr?' · Str. '+r2.streckenNr:''}</div>
                </div>
                {openRouteId===r2.id && (
                  <div className="rte-tts">
                    <div className="tt-item" onClick={()=>selectTT(r2,null)}>
                      <span className="tt-nr" style={{color:'#405060'}}>— Leer —</span>
                      <span className="tt-nm">Nur Strecke</span>
                    </div>
                    {(r2.timetables||[]).map(tt2 => (
                      <div key={tt2.id} className="tt-item" onClick={()=>selectTT(r2,tt2)}>
                        <span className="tt-nr">{tt2.zugNummer||tt2.name}</span>
                        <span className="tt-nm">{tt2.name} · ab {fmtT(tt2.departure)}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
          <div className="rte-close" onClick={()=>{setShowRoutes(false);setOpenRouteId(null);}}>[ C ] Schließen</div>
        </div>
      )}

      {/* ===== EINGABE-OVERLAY ===== */}
      {inputMode && (
        <div className="ov-bg">
          <div className="ov-box">
            <div className="ov-title">
              {inputMode==='zug'   ? 'ZUGNUMMER' :
               inputMode==='zeit'  ? 'UHRZEIT (HHMMSS)' :
               inputMode==='stoer' ? 'STÖRUNGSMELDUNG' : 'KM-OFFSET'}
            </div>
            <div className="ov-val">{inputVal || '█'}</div>
            <div className="ov-hint">
              {inputMode==='stoer'
                ? 'Text über Numpad / Tastatur — E = Bestätigen — C = Löschen'
                : 'Ziffern — E = Bestätigen — C = Löschen'}
            </div>
            {inputMode==='stoer' && (
              <input
                autoFocus
                style={{marginTop:10,width:'100%',background:'#0a0d14',border:'1px solid #3a5a8a',color:'#c0d8f0',padding:'6px 8px',fontFamily:'IBM Plex Mono',fontSize:13,outline:'none',borderRadius:3}}
                value={inputVal}
                onChange={e=>setInputVal(e.target.value)}
                onKeyDown={e=>{if(e.key==='Enter')confirmInput();if(e.key==='Escape'){setInputMode(null);setInputVal('');}}}
                placeholder="Meldungstext..."
              />
            )}
          </div>
        </div>
      )}

    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<EBuLa/>);
</script>
</body>
</html>